<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LoG Beta 5.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ffffff">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1539164935971262" crossorigin="anonymous"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* „ÉÜ„Éº„ÉûÂ§âÊï∞ (Threads/X Like) */
        :root { --primary: #000000; --accent: #0095f6; --bg: #ffffff; --text: #000000; --subtext: #777777; --border: #efefef; }
        
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', 'Noto Sans JP', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none !important; }

        /* „Çπ„Éà„Éº„É™„Éº„É™„É≥„Ç∞ */
        .story-ring { padding: 2px; border-radius: 50%; background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); cursor: pointer; transition: transform 0.1s; }
        .story-ring:active { transform: scale(0.95); }
        .story-ring img { border: 2px solid var(--bg); border-radius: 50%; display: block; }
        .story-seen { background: #dbdbdb; }

        /* UI„Éë„Éº„ÉÑ */
        .btn-black { background: var(--primary); color: white; border-radius: 99px; padding: 8px 20px; font-weight: 700; font-size: 0.9rem; transition: 0.2s; }
        .btn-black:active { transform: scale(0.95); opacity: 0.8; }
        
        .nav-item { color: #b0b0b0; transition: 0.2s; }
        .nav-active { color: var(--primary); transform: scale(1.1); }

        /* „É™„Ç¢„ÇØ„Ç∑„Éß„É≥„Éî„ÉÉ„Ç´„Éº */
        .reaction-picker { position: absolute; bottom: 30px; left: -10px; background: white; border-radius: 50px; padding: 5px 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; gap: 5px; z-index: 10; animation: popUp 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from { transform: scale(0) translateY(10px); opacity: 0; } to { transform: scale(1) translateY(0); opacity: 1; } }
        .reaction-btn { font-size: 1.2rem; cursor: pointer; transition: 0.2s; }
        .reaction-btn:hover { transform: scale(1.5); }

        /* ÂºïÁî®„Çπ„Çø„Ç§„É´ */
        .quote-box { border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-top: 8px; font-size: 0.9rem; color: var(--subtext); }

        .modal-overlay { background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-8 bg-white">
        <div class="mb-12 text-center">
            <h1 class="text-6xl font-black tracking-tighter mb-2">LoG</h1>
            <span class="bg-black text-white text-xs font-bold px-3 py-1 rounded-full tracking-widest">BETA 5.0</span>
        </div>
        <div class="w-full max-w-xs space-y-4">
            <button id="google-login-btn" class="w-full border border-gray-200 py-3 rounded-2xl font-bold flex justify-center items-center gap-2 hover:bg-gray-50 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Google„ÅßÈñãÂßã
            </button>
            <div class="flex items-center gap-3 text-xs text-gray-300 my-4">
                <div class="h-px bg-gray-100 flex-1"></div>OR<div class="h-px bg-gray-100 flex-1"></div>
            </div>
            <input id="auth-email" type="email" placeholder="„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ" class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-black outline-none transition">
            <input id="auth-password" type="password" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ" class="w-full bg-gray-50 border-none rounded-2xl p-4 text-sm font-bold focus:ring-2 focus:ring-black outline-none transition">
            <div class="flex gap-2">
                <button id="email-login-btn" class="flex-1 bg-black text-white py-3 rounded-2xl font-bold hover:opacity-80 transition">„É≠„Ç∞„Ç§„É≥</button>
                <button id="email-signup-btn" class="flex-1 border border-gray-200 text-black py-3 rounded-2xl font-bold hover:bg-gray-50 transition">ÁôªÈå≤</button>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden max-w-xl mx-auto min-h-screen bg-white shadow-xl relative pb-20 border-x border-gray-50">
        
        <div class="sticky top-0 bg-white/95 backdrop-blur z-30 border-b border-gray-100">
            <div class="flex justify-between items-center px-4 py-3">
                <h1 class="text-xl font-black tracking-tighter cursor-pointer" onclick="window.scrollTo(0,0)">LoG</h1>
                <img id="header-icon" src="" class="w-8 h-8 rounded-full border border-gray-100 object-cover cursor-pointer" onclick="switchTab('profile')">
            </div>
            <div id="story-bar" class="flex gap-4 px-4 pb-3 overflow-x-auto hide-scrollbar">
                </div>
        </div>

        <div id="tab-home" class="pb-24">
            <div class="p-4 border-b border-gray-100 flex gap-3 items-start">
                <img id="input-icon" src="" class="w-10 h-10 rounded-full bg-gray-100 object-cover">
                <div class="flex-1">
                    <textarea id="post-text" rows="2" placeholder="„ÅÑ„Åæ„Å©„ÅÜ„Åó„Å¶„ÇãÔºü" class="w-full text-base resize-none mb-2 focus:outline-none placeholder-gray-400"></textarea>
                    
                    <div id="quote-preview" class="hidden mb-3 p-3 rounded-xl border border-gray-200 text-xs text-gray-500 relative">
                        <button onclick="cancelQuote()" class="absolute top-1 right-2 text-lg">√ó</button>
                        <div class="font-bold mb-1" id="quote-target-name"></div>
                        <div class="truncate" id="quote-target-text"></div>
                    </div>

                    <div class="flex justify-end">
                        <button id="post-btn" class="btn-black">Post</button>
                    </div>
                </div>
            </div>
            <div id="timeline"></div>
        </div>

        <div id="tab-explore" class="hidden">
            <div class="p-4 sticky top-14 bg-white z-20">
                <div class="bg-gray-100 rounded-xl px-4 py-3 flex items-center text-gray-500">
                    <span class="material-icons-round mr-2">search</span>
                    <input type="text" placeholder="„Ç≠„Éº„ÉØ„Éº„ÉâÊ§úÁ¥¢ (Ê∫ñÂÇô‰∏≠)" class="bg-transparent w-full outline-none text-sm font-bold">
                </div>
            </div>
            <div id="user-list" class="divide-y divide-gray-50"></div>
        </div>

        <div id="tab-chat" class="hidden h-[calc(100vh-130px)] flex flex-col">
            <div class="p-3 border-b flex items-center gap-3 sticky top-14 bg-white z-10 px-4">
                <button onclick="switchTab('explore')"><span class="material-icons-round text-gray-400">arrow_back</span></button>
                <span id="chat-target-name" class="font-bold"></span>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-white"></div>
            <div class="p-3 border-t bg-white flex gap-2 items-center">
                <input id="chat-input" type="text" class="flex-1 bg-gray-100 rounded-full px-5 py-3 text-sm font-bold outline-none" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏...">
                <button id="chat-send-btn" class="text-blue-500 p-2 font-bold">ÈÄÅ‰ø°</button>
            </div>
        </div>

        <div id="tab-profile" class="hidden">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 id="profile-name" class="text-2xl font-black"></h2>
                        <p id="profile-uid" class="text-sm text-gray-400 font-mono">@user</p>
                    </div>
                    <img id="profile-big-icon" src="" class="w-20 h-20 rounded-full border-4 border-white shadow-sm object-cover">
                </div>
                <div class="text-sm text-gray-600 mb-6">Ëá™Â∑±Á¥π‰ªãÊñá„ÅØ„Åæ„Å†Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</div>
                <div class="flex gap-4 border-b border-gray-100 pb-4">
                    <button onclick="openProfileEditor()" class="flex-1 border border-gray-300 rounded-xl py-2 font-bold text-sm hover:bg-gray-50">„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ</button>
                    <button onclick="signOutApp()" class="flex-1 border border-gray-300 rounded-xl py-2 font-bold text-sm text-red-500 hover:bg-red-50">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                </div>
            </div>
            <div id="my-timeline"></div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-xl bg-white/95 backdrop-blur border-t border-gray-100 flex justify-around py-4 z-40 pb-6">
            <button onclick="switchTab('home')" class="nav-item nav-active" data-target="home"><span class="material-icons-round text-3xl">home</span></button>
            <button onclick="switchTab('explore')" class="nav-item" data-target="explore"><span class="material-icons-round text-3xl">search</span></button>
            <button onclick="switchTab('profile')" class="nav-item" data-target="profile"><span class="material-icons-round text-3xl">person</span></button>
        </nav>
    </div>

    <div id="story-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center" onclick="this.classList.add('hidden')">
        <div class="bg-white p-8 rounded-3xl w-80 text-center shadow-2xl relative" onclick="event.stopPropagation()">
            <img id="story-icon" src="" class="w-16 h-16 rounded-full mx-auto border-4 border-white shadow-md -mt-16 mb-4">
            <h3 id="story-author" class="font-bold text-lg mb-2"></h3>
            <p id="story-text" class="text-xl font-medium text-gray-800 leading-relaxed min-h-[100px] flex items-center justify-center"></p>
            <div class="text-xs text-gray-400 mt-4 text-right" id="story-time"></div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-3xl w-80 shadow-2xl">
            <h2 class="text-lg font-bold mb-4">Setup Identity</h2>
            <input id="edit-name-input" type="text" class="w-full bg-gray-100 border-none rounded-xl p-3 mb-4 font-bold text-center outline-none" placeholder="Ë°®Á§∫Âêç">
            <button id="save-profile-btn" class="w-full btn-black py-3">‰øùÂ≠ò</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs",
            authDomain: "lo-g-8a620.firebaseapp.com",
            projectId: "lo-g-8a620",
            storageBucket: "lo-g-8a620.firebasestorage.app",
            messagingSenderId: "780857099698",
            appId: "1:780857099698:web:b6cb359114da98ab3e50ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null, myProfile = null;
        let quoteData = null; // { id, text, name }
        let currentChatUser = null;

        // --- Ë™çË®º ---
        const authErr = (e) => alert(e.message);
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(authErr);
        document.getElementById('email-login-btn').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(authErr);
        document.getElementById('email-signup-btn').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(authErr);
        window.signOutApp = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) { myProfile = userDoc.data(); initApp(); } 
                    else { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('profile-modal').classList.remove('hidden'); }
                } catch(e) { console.error(e); }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            
            updateHeader();
            loadStories(); // „Çπ„Éà„Éº„É™„ÉºË™≠„ÅøËæº„Åø
            loadTimeline();
            loadUserList();
        }

        function updateHeader() {
            const icon = myProfile.icon || `https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`;
            document.getElementById('header-icon').src = icon;
            document.getElementById('input-icon').src = icon;
            document.getElementById('profile-big-icon').src = icon;
            document.getElementById('profile-name').innerText = myProfile.name || "No Name";
            document.getElementById('profile-uid').innerText = "@" + currentUser.uid.slice(0,8);
        }

        // --- ‚òÖ „ÉÜ„Ç≠„Çπ„Éà„Çπ„Éà„Éº„É™„Éº (InstaÈ¢®) ---
        // ‚ÄªÁ∞°ÊòìÁöÑ„Å´„ÄåÊúÄÊñ∞20‰ª∂„ÅÆÊäïÁ®ø„Çí„Åó„Åü„É¶„Éº„Ç∂„Éº„Äç„Çí„É¶„Éã„Éº„ÇØ„Å´„Åó„Å¶Ë°®Á§∫
        function loadStories() {
            const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(q, (snap) => {
                const bar = document.getElementById('story-bar');
                bar.innerHTML = `
                    <div class="flex flex-col items-center gap-1 cursor-pointer min-w-[60px]">
                        <div class="w-14 h-14 rounded-full border border-gray-200 flex items-center justify-center bg-gray-50 text-xl font-bold">+</div>
                        <span class="text-[10px] text-gray-500 truncate w-14 text-center">Your Story</span>
                    </div>
                `;
                
                const usersSeen = new Set();
                snap.docs.forEach(doc => {
                    const d = doc.data();
                    if(d.uid === currentUser.uid || usersSeen.has(d.uid)) return;
                    usersSeen.add(d.uid);

                    const div = document.createElement('div');
                    div.className = "flex flex-col items-center gap-1 cursor-pointer min-w-[60px]";
                    div.onclick = () => openStory(d);
                    div.innerHTML = `
                        <div class="story-ring w-16 h-16 flex items-center justify-center">
                            <img src="${d.authorIcon}" class="w-14 h-14 bg-white object-cover">
                        </div>
                        <span class="text-[10px] text-gray-500 truncate w-16 text-center">${d.authorName}</span>
                    `;
                    bar.appendChild(div);
                });
            });
        }

        window.openStory = (d) => {
            document.getElementById('story-icon').src = d.authorIcon;
            document.getElementById('story-author').innerText = d.authorName;
            document.getElementById('story-text').innerText = d.text;
            document.getElementById('story-time').innerText = timeAgo(d.createdAt.toDate());
            document.getElementById('story-modal').classList.remove('hidden');
        };

        // --- „Çø„Ç§„É†„É©„Ç§„É≥ (ThreadsÈ¢®) ---
        function loadTimeline() {
            const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('timeline');
                container.innerHTML = "";
                snap.docs.forEach((doc) => {
                    try {
                        const d = doc.data();
                        const isMine = d.uid === currentUser.uid;
                        // „É™„Ç¢„ÇØ„Ç∑„Éß„É≥ÈõÜË®à
                        const reactions = d.reactions || {};
                        const reactionCount = Object.keys(reactions).length;
                        const myReaction = reactions[currentUser.uid];

                        const div = document.createElement('div');
                        div.className = "p-4 border-b border-gray-50 relative";
                        div.innerHTML = `
                            <div class="flex gap-3">
                                <img src="${d.authorIcon}" class="w-10 h-10 rounded-full bg-gray-100 object-cover flex-shrink-0 mt-1">
                                <div class="flex-1 min-w-0">
                                    <div class="flex justify-between items-center">
                                        <div class="font-bold text-[15px]">${d.authorName} <span class="text-gray-400 font-normal text-xs ml-1">${timeAgo(d.createdAt.toDate())}</span></div>
                                        ${isMine ? `<button onclick="deletePost('${doc.id}')" class="text-gray-300 hover:text-red-500">‚Ä¢‚Ä¢‚Ä¢</button>` : ''}
                                    </div>
                                    <p class="text-[15px] leading-relaxed mt-1 text-gray-900 whitespace-pre-wrap">${d.text}</p>
                                    
                                    ${d.quote ? `
                                        <div class="quote-box">
                                            <div class="font-bold text-xs mb-1">${d.quote.name}</div>
                                            <div class="truncate">${d.quote.text}</div>
                                        </div>
                                    ` : ''}

                                    <div class="flex gap-5 mt-3 relative">
                                        <div class="relative group">
                                            <button onclick="toggleReactionPicker('${doc.id}')" class="flex items-center gap-1 text-gray-500 hover:text-red-500 transition">
                                                <span class="material-icons-round text-xl">${myReaction ? 'favorite' : 'favorite_border'}</span>
                                            </button>
                                            <span class="text-xs text-gray-400 absolute left-7 top-1">${reactionCount > 0 ? reactionCount : ''}</span>
                                            ${myReaction ? `<span class="absolute -top-2 -right-2 text-sm">${myReaction}</span>` : ''}
                                            
                                            <div id="picker-${doc.id}" class="reaction-picker hidden">
                                                <span class="reaction-btn" onclick="addReaction('${doc.id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                                                <span class="reaction-btn" onclick="addReaction('${doc.id}', 'üëç')">üëç</span>
                                                <span class="reaction-btn" onclick="addReaction('${doc.id}', 'üòÇ')">üòÇ</span>
                                                <span class="reaction-btn" onclick="addReaction('${doc.id}', 'üî•')">üî•</span>
                                            </div>
                                        </div>

                                        <button onclick="window.setQuote('${d.text}', '${d.authorName}')" class="flex items-center gap-1 text-gray-500 hover:text-green-500 transition">
                                            <span class="material-icons-round text-xl">cached</span>
                                        </button>
                                        
                                        <button class="flex items-center gap-1 text-gray-500 hover:text-blue-500 transition">
                                            <span class="material-icons-round text-xl">send</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(div);
                    } catch(e) {}
                });
            });
            // Ëá™ÂàÜ„ÅÆÊäïÁ®ø
            const myQ = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(myQ, (s) => {
                document.getElementById('my-timeline').innerHTML = "";
                s.docs.forEach(doc => { if(doc.data().uid === currentUser.uid) { /* Á∞°ÊòìË°®Á§∫„ÅØÁúÅÁï• */ } });
            });
        }

        // --- ÊäïÁ®ø & ÂºïÁî® ---
        window.setQuote = (text, name) => {
            quoteData = { text, name };
            document.getElementById('quote-preview').classList.remove('hidden');
            document.getElementById('quote-target-name').innerText = name;
            document.getElementById('quote-target-text').innerText = text;
            document.getElementById('post-text').focus();
        };
        window.cancelQuote = () => {
            quoteData = null;
            document.getElementById('quote-preview').classList.add('hidden');
        };

        document.getElementById('post-btn').onclick = async () => {
            const text = document.getElementById('post-text').value; if(!text.trim()) return;
            const exp = new Date(); exp.setDate(exp.getDate() + 90);
            
            const data = {
                text, uid: currentUser.uid, authorName: myProfile.name, authorIcon: myProfile.icon,
                createdAt: serverTimestamp(), expireAt: exp, reactions: {}
            };
            if(quoteData) data.quote = quoteData;

            await addDoc(collection(db, "logs"), data);
            document.getElementById('post-text').value = "";
            cancelQuote();
        };

        // --- „É™„Ç¢„ÇØ„Ç∑„Éß„É≥ ---
        window.toggleReactionPicker = (id) => {
            const p = document.getElementById(`picker-${id}`);
            document.querySelectorAll('.reaction-picker').forEach(el => { if(el !== p) el.classList.add('hidden'); });
            p.classList.toggle('hidden');
        };
        window.addReaction = async (id, emoji) => {
            const ref = doc(db, "logs", id);
            // „Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆ„Ç≠„Éº„Å®„Åó„Å¶UID„Çí‰Ωø„ÅÜ (MapÂûã)
            const update = {};
            update[`reactions.${currentUser.uid}`] = emoji;
            await updateDoc(ref, update);
            document.getElementById(`picker-${id}`).classList.add('hidden');
        };

        // --- „É¶„Éº„Ç∂„Éº„É™„Çπ„Éà (Self-DM Fix) ---
        async function loadUserList() {
            const list = document.getElementById('user-list');
            const q = query(collection(db, "users"), limit(50));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                snap.forEach(doc => {
                    if (doc.id === currentUser.uid) return; // ‚òÖËá™ÂàÜ„ÇíÈô§Â§ñ

                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = "p-4 flex items-center gap-3 hover:bg-gray-50 cursor-pointer";
                    div.onclick = () => openChat(doc.id, d.name);
                    div.innerHTML = `
                        <img src="${d.icon}" class="w-10 h-10 rounded-full object-cover">
                        <div class="flex-1">
                            <div class="font-bold text-sm">${d.name}</div>
                            <div class="text-xs text-gray-400">@${doc.id.slice(0,8)}</div>
                        </div>
                        <span class="material-icons-round text-gray-300">navigate_next</span>
                    `;
                    list.appendChild(div);
                });
            });
        }

        // --- „ÉÅ„É£„ÉÉ„Éà ---
        window.openChat = (u,n) => { currentChatUser = u; document.getElementById('chat-target-name').innerText = n; switchTab('chat'); loadMessages(u); };
        function loadMessages(t) {
            const c = [currentUser.uid, t].sort().join("_");
            onSnapshot(query(collection(db, "chats", c, "messages"), orderBy("createdAt", "asc"), limit(50)), (s) => {
                const d = document.getElementById('chat-messages'); d.innerHTML = "";
                s.forEach(o => {
                    const v = o.data();
                    const m = v.senderId === currentUser.uid;
                    d.innerHTML += `<div class="flex ${m?'justify-end':'justify-start'}"><div class="max-w-[80%] px-4 py-2 rounded-2xl text-[15px] ${m?'bg-blue-500 text-white':'bg-gray-100 text-black'}">${v.text}</div></div>`;
                });
                d.scrollTop = d.scrollHeight;
            });
        }
        document.getElementById('chat-send-btn').onclick = async () => {
            const t = document.getElementById('chat-input').value; if(!t.trim()) return;
            await addDoc(collection(db, "chats", [currentUser.uid, currentChatUser].sort().join("_"), "messages"), { text: t, senderId: currentUser.uid, createdAt: serverTimestamp() });
            document.getElementById('chat-input').value = "";
        };

        // --- ÂÖ±ÈÄö ---
        window.deletePost = async (id) => { if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) await deleteDoc(doc(db, "logs", id)); };
        function timeAgo(d) { const s = Math.floor((new Date()-d)/1000); if(s<60)return"1m"; const m=Math.floor(s/60); if(m<60)return m+"m"; const h=Math.floor(m/60); if(h<24)return h+"h"; return Math.floor(h/24)+"d"; }

        document.getElementById('save-profile-btn').onclick = async () => {
            const name = document.getElementById('edit-name-input').value;
            if(!name) return;
            await setDoc(doc(db, "users", currentUser.uid), { name, icon: `https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`, updatedAt: serverTimestamp() }, { merge: true });
            location.reload();
        };
        
        window.openProfileEditor = () => document.getElementById('profile-modal').classList.remove('hidden');
        window.switchTab = (t) => {
            ['home','explore','chat','profile'].forEach(x => document.getElementById(`tab-${x}`).classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('nav-active'));
            const b = document.querySelector(`.nav-item[data-target="${t}"]`);
            if(b) b.classList.add('nav-active');
        };
    </script>
</body>
</html>
