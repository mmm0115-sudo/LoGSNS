<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LoG v1.5</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1539164935971262" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root { 
            --bg: #ffffff; --text: #0f1419; --border: #eff3f4; --card: #ffffff; 
            --subtext: #536471; --accent: #1d9bf0; --danger: #f4212e; --success: #00ba7c;
            --nav-bg: rgba(255,255,255,0.95);
        }
        .dark { 
            --bg: #000000; --text: #e7e9ea; --border: #2f3336; --card: #000000; 
            --subtext: #71767b; --accent: #1d9bf0; --nav-bg: rgba(0,0,0,0.95);
        }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', 'Noto Sans JP', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s; }
        .hidden { display: none !important; }

        .btn-primary { background: var(--text); color: var(--bg); border-radius: 99px; padding: 6px 16px; font-weight: 700; font-size: 0.85rem; transition: 0.2s; }
        .btn-ghost { color: var(--subtext); padding: 8px; border-radius: 50%; }
        .btn-ghost:hover { background: rgba(128,128,128,0.1); color: var(--accent); }
        .btn-follow { border: 1px solid var(--border); color: var(--text); padding: 6px 16px; border-radius: 99px; font-size: 0.85rem; font-weight: bold; }
        .btn-follow.following { background: var(--text); color: var(--bg); border-color: var(--text); }

        .nav-item { color: var(--subtext); padding: 12px; position: relative; }
        .nav-active { color: var(--text); }
        .nav-badge { position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--danger); border-radius: 50%; display: none; }

        .post-card { border-bottom: 1px solid var(--border); padding: 16px; }
        .tab-active { border-bottom: 2px solid var(--text); color: var(--text); }
        .tab-inactive { color: var(--subtext); }

        .poll-container { border: 1px solid var(--border); border-radius: 12px; margin-top: 10px; overflow: hidden; }
        .poll-option { padding: 8px 12px; position: relative; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .poll-fill { position: absolute; left: 0; top: 0; height: 100%; background: var(--accent); opacity: 0.15; }
        
        .rank-bronze { color: #cd7f32; } .rank-silver { color: #8a9ca8; } .rank-gold { color: #d4af37; font-weight: 900; }
        .rank-diamond { background: linear-gradient(90deg, #00c6ff, #0072ff); -webkit-background-clip: text; color: transparent; font-weight: 900; }
        .rank-obsidian { background: linear-gradient(90deg, #ff0000, #460000); -webkit-background-clip: text; color: transparent; font-weight: 900; }
        
        .title-badge { background: linear-gradient(45deg, #FFD700, #FFA500); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.6rem; font-weight: 900; margin-left: 4px; display: inline-block; vertical-align: middle; text-shadow: 0 1px 1px rgba(0,0,0,0.1); }

        .like-active { color: #f91880 !important; }
        .modal-overlay { background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }

        /* „Éü„ÉÉ„Ç∑„Éß„É≥Áî®„Çπ„Çø„Ç§„É´ */
        .mission-card { background: var(--bg); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .mission-progress { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; width: 100px; }
        .mission-bar { height: 100%; background: var(--success); transition: width 0.3s; }
        .mission-completed { color: var(--subtext); opacity: 0.7; }
        .mission-check { color: var(--success); font-weight: bold; }
        
        /* „É™„É≥„ÇØ„Ç´„Éº„ÇΩ„É´ */
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>

    <!-- Login -->
    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-8 bg-white dark:bg-black transition-colors">
        <h1 class="text-7xl font-black tracking-tighter mb-4 text-black dark:text-white">LoG</h1>
        <div class="inline-block bg-black dark:bg-white text-white dark:text-black px-4 py-1 rounded-full text-xs font-bold tracking-[0.3em] mb-12">v1.5 TITLE</div>
        <div class="w-full max-w-sm space-y-4">
            <button id="google-login-btn" class="w-full border border-gray-300 dark:border-gray-700 py-3 rounded-full font-bold flex justify-center items-center gap-3 hover:bg-gray-50 dark:hover:bg-gray-900 transition">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Google
            </button>
            <div id="email-form" class="space-y-3 pt-4 border-t border-gray-100 dark:border-gray-800">
                <input id="auth-email" type="email" placeholder="Email" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg p-3 outline-none">
                <input id="auth-password" type="password" placeholder="Password" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-lg p-3 outline-none">
                <div class="flex gap-2">
                    <button onclick="emailAuth('login')" class="flex-1 bg-black dark:bg-white text-white dark:text-black py-3 rounded-full font-bold">Login</button>
                    <button onclick="emailAuth('signup')" class="flex-1 border border-gray-300 dark:border-gray-700 py-3 rounded-full font-bold">Sign Up</button>
                </div>
            </div>
        </div>
    </div>

    <!-- App -->
    <div id="app-screen" class="hidden max-w-xl mx-auto min-h-screen bg-[var(--bg)] shadow-2xl relative pb-20 border-x border-[var(--border)]">
        
        <!-- Header -->
        <header class="sticky top-0 bg-[var(--nav-bg)] backdrop-blur-md z-40 border-b border-[var(--border)] px-4 py-3 flex justify-between items-center" onclick="window.scrollTo({top:0, behavior:'smooth'})">
            <img id="header-icon" src="" class="w-8 h-8 rounded-full object-cover border border-[var(--border)] cursor-pointer" onclick="switchTab('profile')">
            <div class="text-xl font-black tracking-tight cursor-pointer" onclick="switchTab('home')">LoG</div>
            <div class="flex items-center gap-1 text-xs font-bold text-orange-500 bg-orange-500/10 px-2 py-1 rounded-full">
                <span class="material-icons-round text-sm">local_fire_department</span>
                <span id="streak-count">0</span>
            </div>
        </header>

        <!-- A. HOME -->
        <div id="tab-home" class="pb-24">
            <div class="p-4 border-b border-[var(--border)]">
                <div class="flex gap-3">
                    <img id="input-icon" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
                    <div class="flex-1">
                        <textarea id="post-text" rows="2" placeholder="„ÅÑ„Åæ„Å©„ÅÜ„Åó„Å¶„ÇãÔºü" class="w-full text-lg resize-none bg-transparent focus:outline-none placeholder-[var(--subtext)]"></textarea>
                        
                        <div id="poll-creator" class="hidden mb-3 space-y-2 p-3 border border-[var(--border)] rounded-xl bg-[var(--bg)]">
                            <input id="poll-1" type="text" placeholder="ÈÅ∏ÊäûËÇ¢ 1" class="w-full bg-[var(--border)]/30 rounded p-2 text-sm outline-none">
                            <input id="poll-2" type="text" placeholder="ÈÅ∏ÊäûËÇ¢ 2" class="w-full bg-[var(--border)]/30 rounded p-2 text-sm outline-none">
                        </div>

                        <div id="quote-preview" class="hidden mb-3 p-3 rounded-xl border border-[var(--border)] text-sm relative">
                            <button onclick="cancelQuote()" class="absolute top-1 right-2 text-[var(--subtext)]">√ó</button>
                            <div class="font-bold mb-1" id="quote-target-name"></div>
                            <div class="truncate text-[var(--subtext)]" id="quote-target-text"></div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-[var(--border)]">
                            <div class="flex gap-2">
                                <button onclick="togglePoll()" class="btn-ghost text-[var(--accent)]"><span class="material-icons-round">poll</span></button>
                            </div>
                            <button id="post-btn" class="btn-primary">„Éù„Çπ„Éà</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="timeline"></div>
        </div>

        <!-- B. EXPLORE -->
        <div id="tab-explore" class="hidden">
            <div class="p-3 border-b border-[var(--border)] sticky top-14 bg-[var(--bg)] z-30">
                <div class="bg-[var(--border)]/50 rounded-full px-4 py-2 flex items-center text-[var(--subtext)]">
                    <span class="material-icons-round mr-2 text-sm">search</span>
                    <input id="search-input" type="text" placeholder="„É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢" class="bg-transparent w-full outline-none text-sm" onkeyup="searchUsers()">
                </div>
            </div>
            <div id="explore-list" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- C. NOTIF -->
        <div id="tab-notif" class="hidden">
            <div class="p-3 border-b border-[var(--border)] font-bold text-lg px-4">ÈÄöÁü•</div>
            <div id="notif-list" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- D. PROFILE (Self) -->
        <div id="tab-profile" class="hidden">
            <div class="px-4 py-6">
                <div class="flex justify-between items-start mb-4">
                    <img id="profile-big-icon" src="" class="w-20 h-20 rounded-full border-4 border-[var(--bg)] bg-[var(--bg)] object-cover shadow-sm">
                    <button onclick="openSettings()" class="btn-primary bg-transparent text-[var(--text)] border border-[var(--border)]">Ë®≠ÂÆö</button>
                </div>
                <h2 class="text-2xl font-black leading-tight flex items-center gap-2 flex-wrap">
                    <span id="profile-name"></span>
                    <span id="profile-title" class="title-badge hidden"></span>
                </h2>
                <p id="profile-uid" class="text-sm text-[var(--subtext)] font-mono">@user</p>
                
                <div class="flex items-center gap-4 mt-3">
                    <div class="flex items-center gap-1"><span class="font-bold" id="profile-xp">0</span> <span class="text-xs text-[var(--subtext)]">XP</span></div>
                    <div class="flex items-center gap-1"><span class="font-bold" id="profile-rank">Unranked</span></div>
                </div>

                <!-- „Éü„ÉÉ„Ç∑„Éß„É≥„Ç®„É™„Ç¢ -->
                <div class="mt-6 mb-2">
                    <div class="text-xs font-bold text-[var(--subtext)] mb-2 uppercase tracking-widest">Daily Missions</div>
                    <div id="mission-list">
                        <!-- JS„ÅßÁîüÊàê -->
                    </div>
                </div>
            </div>
            
            <div class="flex border-b border-[var(--border)] mt-2 sticky top-14 bg-[var(--bg)] z-20">
                <div onclick="switchProfileSubTab('posts')" id="tab-btn-posts" class="flex-1 text-center py-3 font-bold border-b-2 border-[var(--text)] cursor-pointer">„Éù„Çπ„Éà</div>
                <div onclick="switchProfileSubTab('likes')" id="tab-btn-likes" class="flex-1 text-center py-3 font-bold text-[var(--subtext)] cursor-pointer">„ÅÑ„ÅÑ„Å≠</div>
            </div>
            <div id="my-timeline" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- E. OTHER PROFILE (‰ªñ‰∫∫„ÅÆ„Éó„É≠„Éï„Ç£„Éº„É´) -->
        <div id="tab-other-profile" class="hidden">
            <div class="p-3 border-b border-[var(--border)] flex items-center gap-4 sticky top-14 bg-[var(--bg)] z-30">
                <button onclick="history.back()" class="text-[var(--text)]"><span class="material-icons-round">arrow_back</span></button>
                <span class="font-bold">„Éó„É≠„Éï„Ç£„Éº„É´</span>
            </div>
            <div class="px-4 py-6">
                <div class="flex justify-between items-start mb-4">
                    <img id="other-icon" src="" class="w-20 h-20 rounded-full border-4 border-[var(--bg)] object-cover shadow-sm">
                    <div class="flex gap-2">
                        <button id="other-dm-btn" class="btn-primary bg-transparent text-[var(--text)] border border-[var(--border)]"><span class="material-icons-round text-lg">mail</span></button>
                        <button id="other-follow-btn" class="btn-primary">„Éï„Ç©„É≠„Éº</button>
                    </div>
                </div>
                <h2 class="text-2xl font-black leading-tight flex items-center gap-2 flex-wrap">
                    <span id="other-name"></span>
                    <span id="other-title" class="title-badge hidden"></span>
                </h2>
                <p id="other-uid" class="text-sm text-[var(--subtext)] font-mono"></p>
                <div class="flex items-center gap-4 mt-3">
                    <div class="flex items-center gap-1"><span class="font-bold" id="other-xp">0</span> <span class="text-xs text-[var(--subtext)]">XP</span></div>
                    <div class="flex items-center gap-1"><span class="font-bold" id="other-rank">Unranked</span></div>
                </div>
            </div>
            <div class="border-b border-[var(--border)] font-bold px-4 py-2 text-sm">„Éù„Çπ„Éà</div>
            <div id="other-timeline" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- C. Chat -->
        <div id="tab-chat" class="hidden h-[calc(100vh-130px)] flex flex-col">
            <div class="p-3 border-b border-[var(--border)] flex items-center gap-4 sticky top-14 bg-[var(--bg)] z-10 px-4">
                <button onclick="history.back()"><span class="material-icons-round text-2xl">arrow_back</span></button>
                <span id="chat-target-name" class="font-bold text-lg"></span>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-[var(--bg)]"></div>
            <div class="p-3 border-t border-[var(--border)] bg-[var(--bg)] flex gap-2 items-center">
                <input id="chat-input" type="text" class="flex-1 bg-[var(--border)]/50 rounded-full px-4 py-2 text-sm outline-none focus:bg-[var(--bg)] focus:ring-2 focus:ring-blue-500 transition" placeholder="„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê">
                <button id="chat-send-btn" class="text-blue-500 p-2 font-bold"><span class="material-icons-round">send</span></button>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="fixed bottom-0 w-full max-w-xl bg-[var(--nav-bg)] border-t border-[var(--border)] flex justify-around py-3 z-50 backdrop-blur pb-6">
            <button onclick="switchTab('home')" class="nav-item nav-active" data-target="home"><span class="material-icons-round text-3xl">home</span></button>
            <button onclick="switchTab('explore')" class="nav-item" data-target="explore"><span class="material-icons-round text-3xl">search</span></button>
            <button onclick="switchTab('notif')" class="nav-item" data-target="notif">
                <span class="material-icons-round text-3xl">notifications</span>
                <div id="nav-badge" class="nav-badge"></div>
            </button>
            <button onclick="switchTab('profile')" class="nav-item" data-target="profile"><span class="material-icons-round text-3xl">person</span></button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="profile-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-[var(--card)] p-6 rounded-2xl w-80 shadow-2xl border border-[var(--border)]">
            <h2 class="text-xl font-bold mb-4">ÂàùÊúüË®≠ÂÆö</h2>
            <input id="edit-name-input" type="text" class="w-full bg-[var(--border)]/30 rounded p-3 mb-4 font-bold outline-none text-[var(--text)]" placeholder="Ë°®Á§∫Âêç">
            <button onclick="saveProfile()" class="w-full btn-primary py-3">ÈñãÂßã</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-[var(--card)] p-6 rounded-2xl w-80 shadow-2xl border border-[var(--border)]">
            <button onclick="toggleDarkMode()" class="w-full flex justify-between items-center p-3 font-bold mb-2">„ÉÄ„Éº„ÇØ„É¢„Éº„Éâ <span class="material-icons-round">dark_mode</span></button>
            <button onclick="signOutApp()" class="w-full text-left p-3 text-[var(--danger)] font-bold">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="mt-4 w-full py-2 text-sm">Èñâ„Åò„Çã</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, increment, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs", authDomain: "lo-g-8a620.firebaseapp.com", projectId: "lo-g-8a620", storageBucket: "lo-g-8a620.firebasestorage.app", messagingSenderId: "780857099698", appId: "1:780857099698:web:b6cb359114da98ab3e50ab" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser=null, myProfile=null, quoteData=null, isPoll=false;
        let currentProfileTab = 'posts', currentChatUser=null;

        // ‚òÖ „Éü„ÉÉ„Ç∑„Éß„É≥ÂÆöÁæ©
        const MISSIONS = {
            login: { label: "„É≠„Ç∞„Ç§„É≥„Éú„Éº„Éä„Çπ", target: 1, xp: 50 },
            like: { label: "3Âõû„ÅÑ„ÅÑ„Å≠„Åô„Çã", target: 3, xp: 30 },
            post: { label: "1Âõû„Éù„Çπ„Éà„Åô„Çã", target: 1, xp: 20 }
        };

        const authErr = (e) => alert(e.message);
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(authErr);
        window.emailAuth = (t) => {
            const e=document.getElementById('auth-email').value, p=document.getElementById('auth-password').value;
            if(t==='login') signInWithEmailAndPassword(auth,e,p).catch(authErr);
            else createUserWithEmailAndPassword(auth,e,p).catch(authErr);
        }

        onAuthStateChanged(auth, async (u) => {
            if(u){
                currentUser = u;
                const d = await getDoc(doc(db,"users",u.uid));
                if(d.exists()){ 
                    myProfile = d.data();
                    if(!myProfile.following) myProfile.following = [];
                    await checkStreak();
                    await checkMissions('login'); // „É≠„Ç∞„Ç§„É≥„Éü„ÉÉ„Ç∑„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
                    initApp(); 
                } else {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('profile-modal').classList.remove('hidden');
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // --- „Éü„ÉÉ„Ç∑„Éß„É≥ & „Çπ„Éà„É™„Éº„ÇØ ---
        async function checkStreak() {
            const now = new Date();
            const last = myProfile.lastLogin ? myProfile.lastLogin.toDate() : new Date(0);
            const diff = Math.floor((now - last) / (1000 * 60 * 60 * 24));
            let streak = (diff === 1) ? (myProfile.streak || 0) + 1 : (diff === 0 ? (myProfile.streak || 0) : 1);
            if (diff >= 1 || !myProfile.lastLogin) {
                await updateDoc(doc(db,"users",currentUser.uid), { lastLogin: serverTimestamp(), streak });
                myProfile.streak = streak;
            }
        }

        async function checkMissions(actionType) {
            const today = new Date().toISOString().split('T')[0];
            let missions = myProfile.missions || {};
            
            // Êó•‰ªò„ÅåÂ§â„Çè„Å£„Å¶„ÅÑ„Åü„Çâ„É™„Çª„ÉÉ„Éà
            if (missions.date !== today) {
                missions = { date: today, login: 0, like: 0, post: 0, claimed: [] };
            }

            // „Ç´„Ç¶„É≥„Éà„Ç¢„ÉÉ„Éó
            if (actionType && missions[actionType] !== undefined) {
                missions[actionType]++;
            }

            // ÈÅîÊàê„ÉÅ„Çß„ÉÉ„ÇØ & XP‰ªò‰∏é
            let xpToAdd = 0;
            for (const key in MISSIONS) {
                if (missions[key] >= MISSIONS[key].target && !missions.claimed.includes(key)) {
                    xpToAdd += MISSIONS[key].xp;
                    missions.claimed.push(key);
                    alert(`üéâ „Éü„ÉÉ„Ç∑„Éß„É≥ÈÅîÊàê: ${MISSIONS[key].label} (+${MISSIONS[key].xp} XP)`);
                }
            }

            // ‰øùÂ≠ò
            const updates = { missions: missions };
            if (xpToAdd > 0) updates.xp = increment(xpToAdd);
            
            await updateDoc(doc(db, "users", currentUser.uid), updates);
            myProfile.missions = missions;
            if (xpToAdd > 0) myProfile.xp = (myProfile.xp || 0) + xpToAdd;
            updateMyProfileUI(); // UIÊõ¥Êñ∞
        }

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark');
            
            updateMyProfileUI();
            loadTimeline();
            loadNotifications();
            loadExplore();
        }

        function updateMyProfileUI() {
            const icon = myProfile.icon || `https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`;
            document.getElementById('header-icon').src = icon;
            document.getElementById('input-icon').src = icon;
            document.getElementById('profile-big-icon').src = icon;
            document.getElementById('profile-name').innerText = myProfile.name;
            document.getElementById('profile-uid').innerText = "@"+currentUser.uid.slice(0,8);
            document.getElementById('streak-count').innerText = myProfile.streak || 0;
            document.getElementById('profile-xp').innerText = myProfile.xp || 0;
            document.getElementById('profile-rank').innerText = getRank(myProfile.xp).name;
            document.getElementById('profile-rank').className = `font-bold text-lg ${getRank(myProfile.xp).class}`;
            
            if(myProfile.title) {
                const tEl = document.getElementById('profile-title');
                tEl.innerText = myProfile.title; tEl.classList.remove('hidden');
            }

            // „Éü„ÉÉ„Ç∑„Éß„É≥UIÊèèÁîª
            const mList = document.getElementById('mission-list');
            mList.innerHTML = "";
            const mData = myProfile.missions || { login:0, like:0, post:0, claimed:[] };
            
            for (const key in MISSIONS) {
                const m = MISSIONS[key];
                const current = Math.min(mData[key] || 0, m.target);
                const isDone = mData.claimed && mData.claimed.includes(key);
                const pct = (current / m.target) * 100;
                
                mList.innerHTML += `
                    <div class="mission-card">
                        <div class="flex-1">
                            <div class="text-sm font-bold ${isDone?'mission-completed':''}">${m.label} <span class="text-xs text-[var(--accent)]">(+${m.xp}XP)</span></div>
                            <div class="mission-progress mt-1"><div class="mission-bar" style="width:${pct}%"></div></div>
                        </div>
                        <div class="text-xs font-bold ${isDone?'mission-check':'text-[var(--subtext)]'}">${isDone ? 'COMPLETED' : `${current}/${m.target}`}</div>
                    </div>`;
            }
        }

        function getRank(xp) {
            xp = xp || 0;
            if(xp>=2000) return {name:"Obsidian", class:"rank-obsidian"};
            if(xp>=1000) return {name:"Diamond", class:"rank-diamond"};
            if(xp>=500) return {name:"Gold", class:"rank-gold"};
            if(xp>=200) return {name:"Silver", class:"rank-silver"};
            if(xp>=50) return {name:"Bronze", class:"rank-bronze"};
            return {name:"Unranked", class:""};
        }

        // --- Other Profile & DM ---
        window.viewUser = async (uid) => {
            if(uid === currentUser.uid) { switchTab('profile'); return; }
            const d = await getDoc(doc(db, "users", uid));
            if(!d.exists()) return;
            const u = d.data();
            
            document.getElementById('other-name').innerText = u.name;
            document.getElementById('other-icon').src = u.icon;
            document.getElementById('other-uid').innerText = "@"+uid.slice(0,8);
            document.getElementById('other-xp').innerText = u.xp || 0;
            document.getElementById('other-rank').innerText = getRank(u.xp).name;
            
            if(u.title) {
                const tEl = document.getElementById('other-title');
                tEl.innerText = u.title; tEl.classList.remove('hidden');
            } else {
                document.getElementById('other-title').classList.add('hidden');
            }
            
            // Follow Btn
            const btn = document.getElementById('other-follow-btn');
            const isFollowing = myProfile.following && myProfile.following.includes(uid);
            btn.innerText = isFollowing ? "„Éï„Ç©„É≠„Éº‰∏≠" : "„Éï„Ç©„É≠„Éº„Åô„Çã";
            btn.className = isFollowing ? "btn-follow following" : "btn-primary";
            btn.onclick = () => toggleFollow(uid, btn);

            // ‚òÖ DM Button Logic
            document.getElementById('other-dm-btn').onclick = () => openChat(uid, u.name);

            // Other Timeline
            const q = query(collection(db,"logs"), where("uid","==",uid), orderBy("createdAt","desc"), limit(20));
            onSnapshot(q, (s) => {
                document.getElementById('other-timeline').innerHTML = "";
                s.forEach(doc => document.getElementById('other-timeline').innerHTML += buildPostHTML(doc.id, doc.data()));
            });

            switchTab('other-profile');
        };

        window.toggleFollow = async (uid, btn) => {
            const myRef = doc(db,"users",currentUser.uid);
            if(myProfile.following && myProfile.following.includes(uid)) {
                await updateDoc(myRef, { following: arrayRemove(uid) });
                myProfile.following = myProfile.following.filter(id => id !== uid);
                btn.innerText = "„Éï„Ç©„É≠„Éº„Åô„Çã";
                btn.className = "btn-primary";
            } else {
                await updateDoc(myRef, { following: arrayUnion(uid) });
                if(!myProfile.following) myProfile.following = [];
                myProfile.following.push(uid);
                btn.innerText = "„Éï„Ç©„É≠„Éº‰∏≠";
                btn.className = "btn-follow following";
            }
        };

        // --- Timeline & Post ---
        window.togglePoll = () => { isPoll=!isPoll; document.getElementById('poll-creator').classList.toggle('hidden'); };
        document.getElementById('post-btn').onclick = async () => {
            const text = document.getElementById('post-text').value;
            const p1 = document.getElementById('poll-1').value;
            const p2 = document.getElementById('poll-2').value;
            if(!text.trim() && !p1) return;
            
            const exp = new Date(); exp.setDate(exp.getDate() + 90);
            const data = { 
                text, 
                uid: currentUser.uid, 
                authorName: myProfile.name, 
                authorIcon: myProfile.icon, 
                authorTitle: myProfile.title || "", // Áß∞Âè∑‰øùÂ≠ò
                createdAt: serverTimestamp(), 
                expireAt: exp, 
                likes: [] 
            };
            if(isPoll && p1 && p2) data.poll = { total:0, options: [{id:0, txt:p1, votes:[]}, {id:1, txt:p2, votes:[]}] };
            if(quoteData) data.quote = quoteData;

            await addDoc(collection(db,"logs"), data);
            await checkMissions('post'); // ‚òÖ „Éü„ÉÉ„Ç∑„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
            
            document.getElementById('post-text').value="";
            if(isPoll) togglePoll();
            document.getElementById('poll-1').value=""; document.getElementById('poll-2').value="";
            cancelQuote();
        };

        function loadTimeline() {
            onSnapshot(query(collection(db,"logs"), orderBy("createdAt","desc"), limit(50)), (snap) => {
                const c = document.getElementById('timeline');
                c.innerHTML = "";
                snap.forEach(d => c.innerHTML += buildPostHTML(d.id, d.data()));
            });
            loadMyPosts();
        }

        window.switchProfileSubTab = (type) => {
            currentProfileTab = type;
            document.getElementById('tab-btn-posts').className = type==='posts' ? "flex-1 text-center py-3 font-bold border-b-2 border-[var(--text)] cursor-pointer" : "flex-1 text-center py-3 font-bold text-[var(--subtext)] cursor-pointer";
            document.getElementById('tab-btn-likes').className = type==='likes' ? "flex-1 text-center py-3 font-bold border-b-2 border-[var(--text)] cursor-pointer" : "flex-1 text-center py-3 font-bold text-[var(--subtext)] cursor-pointer";
            
            if(type === 'posts') loadMyPosts();
            else loadMyLikes();
        };

        function loadMyPosts() {
            onSnapshot(query(collection(db,"logs"), where("uid","==",currentUser.uid), orderBy("createdAt","desc"), limit(20)), (s) => {
                const c = document.getElementById('my-timeline'); c.innerHTML = "";
                s.forEach(d => c.innerHTML += buildPostHTML(d.id, d.data()));
            });
        }

        function loadMyLikes() {
            onSnapshot(query(collection(db,"logs"), where("likes", "array-contains", currentUser.uid), limit(20)), (s) => {
                const c = document.getElementById('my-timeline'); c.innerHTML = "";
                if(s.empty) c.innerHTML = "<div class='p-4 text-center text-sm text-[var(--subtext)]'>„ÅÑ„ÅÑ„Å≠„Åó„ÅüÊäïÁ®ø„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</div>";
                s.forEach(d => c.innerHTML += buildPostHTML(d.id, d.data()));
            });
        }

        function buildPostHTML(id, d) {
            const isLiked = d.likes && d.likes.includes(currentUser.uid);
            let pollUI = "";
            if(d.poll) {
                pollUI = `<div class="poll-container">`;
                d.poll.options.forEach((o, i) => {
                    const pct = d.poll.total ? Math.round((o.votes.length/d.poll.total)*100) : 0;
                    pollUI += `<div onclick="event.stopPropagation();vote('${id}',${i})" class="poll-option"><div class="poll-fill" style="width:${pct}%"></div><span class="z-10 text-sm font-bold">${o.txt}</span><span class="z-10 text-xs font-bold">${pct}%</span></div>`;
                });
                pollUI += `</div>`;
            }
            const profileClick = `event.stopPropagation(); viewUser('${d.uid}')`;

            return `
                <div class="post-card flex gap-3">
                    <img src="${d.authorIcon}" class="w-10 h-10 rounded-full object-cover flex-shrink-0 cursor-pointer" onclick="${profileClick}">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <div class="flex items-center gap-1 overflow-hidden">
                                <span class="font-bold text-[15px] truncate cursor-pointer hover:underline" onclick="${profileClick}">${d.authorName}</span>
                                ${d.authorTitle ? `<span class="title-badge">${d.authorTitle}</span>` : ''}
                                <span class="text-[var(--subtext)] text-sm truncate">@${d.uid.slice(0,8)}</span>
                            </div>
                        </div>
                        <p class="text-[15px] mt-1 whitespace-pre-wrap leading-relaxed">${d.text}</p>
                        ${pollUI}
                        ${d.quote ? `<div class="p-3 mt-2 rounded-xl border border-[var(--border)] text-sm"><div class="font-bold">${d.quote.name}</div><div class="text-[var(--subtext)] truncate">${d.quote.text}</div></div>` : ''}
                        
                        <div class="flex justify-between mt-3 max-w-xs text-[var(--subtext)]">
                            <button onclick="event.stopPropagation();setQuote('${d.text}','${d.authorName}')" class="btn-ghost"><span class="material-icons-round text-lg">cached</span></button>
                            <button onclick="event.stopPropagation();like('${id}','${d.uid}')" class="btn-ghost ${isLiked?'like-active like-anim':''}"><span class="material-icons-round text-lg">${isLiked?'favorite':'favorite_border'}</span> <span class="text-xs ml-1">${d.likes?d.likes.length:0}</span></button>
                        </div>
                    </div>
                </div>`;
        }

        // --- Actions ---
        window.vote = async (id, idx) => {
            const r = doc(db,"logs",id); const d=(await getDoc(r)).data();
            let voted=false; d.poll.options.forEach(o=>{if(o.votes.includes(currentUser.uid))voted=true});
            if(voted) return alert("ÊäïÁ•®Ê∏à„Åø");
            d.poll.options[idx].votes.push(currentUser.uid); d.poll.total++; await updateDoc(r,{poll:d.poll});
        };
        window.like = async (id, to) => {
            const r = doc(db,"logs",id); const d=(await getDoc(r)).data();
            if(d.likes.includes(currentUser.uid)) await updateDoc(r,{likes:arrayRemove(currentUser.uid)});
            else { 
                await updateDoc(r,{likes:arrayUnion(currentUser.uid)}); 
                await checkMissions('like'); // ‚òÖ „Éü„ÉÉ„Ç∑„Éß„É≥„ÉÅ„Çß„ÉÉ„ÇØ
            }
        };
        window.setQuote = (t,n) => { quoteData={text:t, name:n}; document.getElementById('quote-preview').classList.remove('hidden'); document.getElementById('quote-target-name').innerText=n; document.getElementById('quote-target-text').innerText=t; };
        window.cancelQuote = () => { quoteData=null; document.getElementById('quote-preview').classList.add('hidden'); };

        // --- Explore & Notif ---
        function loadExplore() {
            onSnapshot(query(collection(db,"users"), orderBy("xp","desc"), limit(20)), (s) => {
                const l = document.getElementById('explore-list'); l.innerHTML = "";
                let i = 1;
                s.forEach(d => {
                    const u = d.data();
                    let rankClass = "";
                    if(i===1) rankClass="text-yellow-500 font-black";
                    else if(i===2) rankClass="text-gray-400 font-bold";
                    else if(i===3) rankClass="text-orange-500 font-bold";
                    
                    l.innerHTML += `
                        <div class="p-4 flex items-center gap-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-900" onclick="viewUser('${d.id}')">
                            <span class="w-6 text-center ${rankClass}">${i}</span>
                            <img src="${u.icon}" class="w-10 h-10 rounded-full">
                            <div class="flex-1">
                                <div class="font-bold text-sm">${u.name}</div>
                                <div class="text-xs text-[var(--subtext)]">${u.xp||0} XP</div>
                            </div>
                        </div>`;
                    i++;
                });
            });
        }

        function loadNotifications() {
            // Beta 6‰ª•Èôç„ÅßÂÆüË£Ö‰∫àÂÆö
        }
        
        window.searchUsers = () => {
            const v = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('#explore-list > div');
            items.forEach(i => i.style.display = i.innerText.toLowerCase().includes(v) ? 'flex' : 'none');
        };

        // --- Chat Logic ---
        window.openChat = (uid, name) => {
            currentChatUser = uid; 
            document.getElementById('chat-target-name').innerText = name; 
            switchTab('chat'); 
            loadMessages(uid); 
        };
        function loadMessages(targetUid) {
            const chatId = [currentUser.uid, targetUid].sort().join("_");
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("createdAt", "asc"), limit(50));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('chat-messages');
                div.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.senderId === currentUser.uid;
                    const bubble = document.createElement('div');
                    bubble.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                    bubble.innerHTML = `<div class="max-w-[70%] px-4 py-2 rounded-2xl text-[15px] ${isMe ? 'bg-blue-500 text-white rounded-br-sm' : 'bg-gray-100 text-black rounded-bl-sm'}">${d.text}</div>`;
                    div.appendChild(bubble);
                });
                div.scrollTop = div.scrollHeight;
            });
        }
        document.getElementById('chat-send-btn').onclick = async () => {
            const text = document.getElementById('chat-input').value;
            if(!text.trim() || !currentChatUser) return;
            const chatId = [currentUser.uid, currentChatUser].sort().join("_");
            const exp = new Date(); exp.setDate(exp.getDate() + 90);
            await addDoc(collection(db, "chats", chatId, "messages"), { 
                text, senderId: currentUser.uid, createdAt: serverTimestamp(), expireAt: exp 
            });
            document.getElementById('chat-input').value = "";
        };

        // --- Common ---
        window.saveProfile = async () => { const n=document.getElementById('edit-name-input').value; if(!n)return; await setDoc(doc(db,"users",currentUser.uid),{name:n,icon:`https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`,xp:0},{merge:true}); location.reload(); };
        window.toggleDarkMode = () => { document.body.classList.toggle('dark'); localStorage.setItem('theme',document.body.classList.contains('dark')?'dark':'light'); };
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.signOutApp = () => signOut(auth);
        window.switchTab = (t) => { ['home','explore','notif','profile','other-profile','chat'].forEach(x => document.getElementById(`tab-${x}`).classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('nav-active')); const b = document.querySelector(`.nav-item[data-target="${t}"]`); if(b) b.classList.add('nav-active'); if(t==='notif') document.getElementById('nav-badge').style.display='none'; };
    </script>
</body>
</html>
