<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LoG SNS</title>

    <!-- PWA Config -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <meta name="description" content="LoG SNS: 90日で消えるログ、ランクシステム、漂流ログなどを搭載した次世代テキストSNS。">

    <!-- OGP Meta Tags -->
    <meta property="og:title" content="LoG SNS">
    <meta property="og:description" content="90日で消える、過去に縛られないテキストSNS。海に言葉を流す「漂流ログ」も搭載。">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lo-g-8a620.web.app/app.html">
    <meta property="og:image" content="https://lo-g-8a620.web.app/assets/ogp.jpg">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap"
        rel="stylesheet">

    <style>
        /* テーマ変数 */
        :root {
            --bg: #ffffff;
            --text: #0f1419;
            --border: #eff3f4;
            --card: #ffffff;
            --subtext: #536471;
            --accent: #1d9bf0;
            --danger: #f4212e;
            --success: #00ba7c;
            --nav-bg: rgba(255, 255, 255, 0.95);
        }

        .dark {
            --bg: #000000;
            --text: #e7e9ea;
            --border: #2f3336;
            --card: #000000;
            --subtext: #71767b;
            --accent: #1d9bf0;
            --nav-bg: rgba(0, 0, 0, 0.95);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.3s, color 0.3s;
        }

        .hidden {
            display: none !important;
        }

        /* UIパーツ */
        .btn-primary {
            background: var(--text);
            color: var(--bg);
            border-radius: 99px;
            padding: 6px 16px;
            font-weight: 700;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .btn-ghost {
            color: var(--subtext);
            padding: 8px;
            border-radius: 50%;
        }

        .btn-ghost:hover {
            background: rgba(128, 128, 128, 0.1);
            color: var(--accent);
        }

        .btn-follow {
            border: 1px solid var(--border);
            color: var(--text);
            padding: 6px 16px;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .btn-follow.following {
            background: var(--text);
            color: var(--bg);
            border-color: var(--text);
        }

        .nav-item {
            color: var(--subtext);
            padding: 10px;
            position: relative;
            transition: 0.2s;
        }

        .nav-active {
            color: var(--text);
            transform: scale(1.1);
        }

        .nav-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            display: none;
        }

        /* ポスト & アンケート */
        .post-card {
            border-bottom: 1px solid var(--border);
            padding: 16px;
            cursor: pointer;
            transition: background 0.1s;
        }

        .post-card:active {
            background: rgba(128, 128, 128, 0.05);
        }

        .poll-container {
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 10px;
            overflow: hidden;
        }

        .poll-option {
            padding: 8px 12px;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .poll-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--accent);
            opacity: 0.15;
            transition: width 0.5s ease;
        }

        /* ランク & 称号 */
        .rank-bronze {
            color: #cd7f32;
        }

        .rank-silver {
            color: #8a9ca8;
        }

        .rank-gold {
            color: #d4af37;
            font-weight: 900;
        }

        .rank-diamond {
            background: linear-gradient(90deg, #00c6ff, #0072ff);
            -webkit-background-clip: text;
            color: transparent;
            font-weight: 900;
        }

        .rank-obsidian {
            background: linear-gradient(90deg, #ff0000, #460000);
            -webkit-background-clip: text;
            color: transparent;
            font-weight: 900;
        }

        .title-badge {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 900;
            margin-left: 4px;
            text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
            display: inline-block;
            vertical-align: middle;
        }

        /* アニメーション */
        .like-anim {
            animation: pop 0.3s cubic-bezier(0.17, 0.89, 0.32, 1.49);
            color: #f91880 !important;
        }

        @keyframes pop {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.4);
            }

            100% {
                transform: scale(1);
            }
        }

        .bottle-anim {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-10px)
            }
        }

        /* その他 */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .mission-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .mission-progress {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            width: 80px;
        }

        .mission-bar {
            height: 100%;
            background: var(--success);
            transition: width 0.3s;
        }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.85rem;
            font-weight: bold;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
    </style>
</head>

<body>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- ■ Main App (未ログインでも表示されるベース画面) ■ -->
    <div id="app-screen"
        class="max-w-xl mx-auto min-h-screen bg-[var(--bg)] shadow-2xl relative pb-20 border-x border-[var(--border)]">

        <!-- Header -->
        <header
            class="sticky top-0 bg-[var(--nav-bg)] backdrop-blur-md z-40 border-b border-[var(--border)] px-4 py-3 flex justify-between items-center"
            onclick="window.scrollTo({top:0, behavior:'smooth'})">
            <img id="header-icon" src="https://api.dicebear.com/7.x/notionists/svg?seed=guest"
                class="w-8 h-8 rounded-full object-cover border border-[var(--border)] cursor-pointer bg-gray-100"
                onclick="switchTab('profile')">
            <div class="text-xl font-black tracking-tight cursor-pointer" onclick="switchTab('home')">LoG</div>
            <div class="flex items-center gap-1 text-xs font-bold text-orange-500 bg-orange-500/10 px-2 py-1 rounded-full cursor-pointer"
                onclick="requireAuth()">
                <span class="material-icons-round text-sm">local_fire_department</span>
                <span id="streak-count">0</span>
            </div>
        </header>

        <!-- A. HOME (Timeline) -->
        <div id="tab-home" class="pb-24">
            <div class="p-4 border-b border-[var(--border)]">
                <div class="flex gap-3">
                    <img id="input-icon" src="https://api.dicebear.com/7.x/notionists/svg?seed=guest"
                        class="w-10 h-10 rounded-full bg-gray-100 object-cover">
                    <div class="flex-1" onclick="requireAuth()">
                        <textarea id="post-text" rows="2" placeholder="いまどうしてる？"
                            class="w-full text-lg resize-none bg-transparent focus:outline-none placeholder-[var(--subtext)]"
                            readonly></textarea>

                        <!-- アンケート & 引用UI -->
                        <div id="poll-creator"
                            class="hidden mb-3 space-y-2 p-3 border border-[var(--border)] rounded-xl bg-[var(--bg)]">
                            <input id="poll-1" type="text" placeholder="選択肢 1"
                                class="w-full bg-[var(--border)]/30 rounded p-2 text-sm outline-none">
                            <input id="poll-2" type="text" placeholder="選択肢 2"
                                class="w-full bg-[var(--border)]/30 rounded p-2 text-sm outline-none">
                        </div>
                        <div id="quote-preview"
                            class="hidden mb-3 p-3 rounded-xl border border-[var(--border)] text-sm relative">
                            <button onclick="event.stopPropagation(); cancelQuote()"
                                class="absolute top-1 right-2 text-[var(--subtext)]">×</button>
                            <div class="font-bold mb-1" id="quote-target-name"></div>
                            <div class="truncate text-[var(--subtext)]" id="quote-target-text"></div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-[var(--border)]">
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); togglePoll()"
                                    class="btn-ghost text-[var(--accent)] pointer-events-none"><span
                                        class="material-icons-round">poll</span></button>
                            </div>
                            <button id="post-btn" class="btn-primary pointer-events-none">ポスト</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="timeline"></div>
        </div>

        <!-- B. EXPLORE (Rank & Search) -->
        <div id="tab-explore" class="hidden">
            <div class="p-3 border-b border-[var(--border)] sticky top-14 bg-[var(--bg)] z-30">
                <div class="bg-[var(--border)]/50 rounded-full px-4 py-2 flex items-center text-[var(--subtext)]">
                    <span class="material-icons-round mr-2 text-sm">search</span>
                    <input id="search-input" type="text" placeholder="ユーザー検索"
                        class="bg-transparent w-full outline-none text-sm" onkeyup="searchUsers()">
                </div>
            </div>
            <div
                class="p-2 border-b border-[var(--border)] bg-[var(--border)]/10 text-xs font-bold text-[var(--subtext)] text-center tracking-widest uppercase">
                XP Ranking
            </div>
            <div id="explore-list" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- C. BOTTLE (漂流ログ) -->
        <div id="tab-bottle"
            class="hidden text-center p-6 bg-[var(--bg)] min-h-[80vh] flex flex-col justify-center items-center">
            <span class="material-icons-round text-6xl text-blue-400 bottle-anim mb-4">sailing</span>
            <h2 class="text-2xl font-black mb-2">漂流ログ</h2>
            <p class="text-sm text-[var(--subtext)] mb-8">誰かの言葉を拾い、自分の言葉を流す。</p>
            <div class="space-y-4 w-full max-w-xs">
                <button onclick="pickupBottle()"
                    class="w-full py-4 bg-gradient-to-r from-blue-500 to-cyan-400 text-white font-bold rounded-2xl shadow-lg hover:scale-105 transition transform">
                    <span class="material-icons-round align-middle mr-2">waves</span> ログを拾う
                </button>
                <button onclick="openBottleModal()"
                    class="w-full py-4 border-2 border-[var(--border)] font-bold rounded-2xl hover:bg-[var(--border)] transition">
                    <span class="material-icons-round align-middle mr-2">edit</span> ログを流す
                </button>
            </div>
            <div id="bottle-result"
                class="hidden mt-8 p-6 bg-[var(--card)] border border-[var(--border)] rounded-2xl shadow-sm text-left w-full relative">
                <span class="absolute -top-3 left-4 bg-[var(--bg)] px-2 text-xs font-bold text-blue-500">漂着物</span>
                <p id="bottle-text" class="text-lg font-medium mb-4"></p>
                <div class="flex justify-between items-center text-xs text-[var(--subtext)] mb-4">
                    <span id="bottle-author">名無しの漂流者</span>
                    <span id="bottle-date"></span>
                </div>
                <!-- X (Twitter) Share Button -->
                <button onclick="shareBottle()"
                    class="w-full bg-black/5 dark:bg-white/5 border border-[var(--border)] text-[var(--text)] py-2 rounded-xl text-sm font-bold flex items-center justify-center gap-2 hover:bg-black/10 transition">
                    <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path
                            d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 22.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z">
                        </path>
                    </svg>
                    このログをXでシェア
                </button>
            </div>
        </div>

        <!-- D. NOTIF -->
        <div id="tab-notif" class="hidden">
            <div class="p-3 border-b border-[var(--border)] font-bold text-lg px-4">通知</div>
            <div id="notif-list" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- E. PROFILE (Self) -->
        <div id="tab-profile" class="hidden">
            <div class="px-4 py-6">
                <div class="flex justify-between items-start mb-4">
                    <img id="profile-big-icon" src=""
                        class="w-20 h-20 rounded-full border-4 border-[var(--bg)] bg-[var(--bg)] object-cover shadow-sm">
                    <button onclick="openSettings()"
                        class="btn-primary bg-transparent text-[var(--text)] border border-[var(--border)]">設定</button>
                </div>
                <h2 class="text-2xl font-black leading-tight flex items-center gap-2 flex-wrap">
                    <span id="profile-name"></span>
                    <span id="profile-title" class="title-badge hidden"></span>
                </h2>
                <p id="profile-uid" class="text-sm text-[var(--subtext)] font-mono">@user</p>

                <div class="flex items-center gap-4 mt-3">
                    <div class="flex items-center gap-1"><span class="font-bold" id="profile-xp">0</span> <span
                            class="text-xs text-[var(--subtext)]">XP</span></div>
                    <div id="profile-faction-badge"
                        class="hidden items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold border">
                        <span id="profile-faction-icon" class="material-icons-round text-[12px]"></span>
                        <span id="profile-faction-name"></span>
                    </div>
                </div>

                <!-- LoG Market (Economy) -->
                <div onclick="document.getElementById('market-modal').classList.remove('hidden')"
                    class="mt-4 p-4 border border-[var(--border)] rounded-2xl cursor-pointer bg-gradient-to-r from-emerald-500/5 to-teal-500/5 hover:from-emerald-500/10 hover:to-teal-500/10 transition relative overflow-hidden group">
                    <div class="flex justify-between items-center relative z-10">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                                <span class="material-icons-round">storefront</span>
                            </div>
                            <div>
                                <div class="text-sm font-black text-emerald-400 tracking-wide mb-1">LoG Market</div>
                                <div class="text-[10px] font-bold text-[var(--subtext)]">XPを使ってアイテムを購入・陣営を支援</div>
                            </div>
                        </div>
                        <span
                            class="material-icons-round text-[var(--subtext)] group-hover:text-emerald-400 transition">chevron_right</span>
                    </div>
                </div>


                <!-- 称号ガチャ & ミッション -->
                <div class="grid grid-cols-2 gap-3 mt-4 mb-4">
                    <div onclick="spinGacha()"
                        class="p-3 border border-[var(--border)] rounded-xl text-center cursor-pointer hover:bg-[var(--border)]/50 transition">
                        <div class="text-xs text-orange-500 font-bold mb-1">称号ガチャ</div>
                        <div class="text-xs text-[var(--subtext)]">50 XP</div>
                    </div>
                    <div class="p-3 border border-[var(--border)] rounded-xl">
                        <div class="text-xs font-bold text-[var(--subtext)] mb-2 uppercase">Daily Missions</div>
                        <div id="mission-list" class="space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- 固定ポスト -->
            <div id="pinned-area" class="hidden border-b border-[var(--border)] bg-[var(--border)]/10">
                <div class="px-4 py-2 text-xs font-bold text-[var(--subtext)] flex items-center gap-1">
                    <span class="material-icons-round text-xs">push_pin</span> 固定されたポスト
                </div>
                <div id="pinned-content"></div>
            </div>

            <div class="flex border-b border-[var(--border)] mt-2 sticky top-14 bg-[var(--bg)] z-20">
                <div onclick="switchProfileSubTab('posts')" id="tab-btn-posts"
                    class="flex-1 text-center py-3 font-bold border-b-2 border-[var(--text)] cursor-pointer">ポスト</div>
                <div onclick="switchProfileSubTab('likes')" id="tab-btn-likes"
                    class="flex-1 text-center py-3 font-bold text-[var(--subtext)] cursor-pointer">いいね</div>
            </div>
            <div id="my-timeline" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- F. OTHER PROFILE -->
        <div id="tab-other-profile" class="hidden">
            <div class="p-3 border-b border-[var(--border)] flex items-center gap-4 sticky top-14 bg-[var(--bg)] z-30">
                <button onclick="history.back()" class="text-[var(--text)]"><span
                        class="material-icons-round">arrow_back</span></button>
                <span class="font-bold">プロフィール</span>
            </div>
            <div class="px-4 py-6">
                <div class="flex justify-between items-start mb-4">
                    <img id="other-icon" src=""
                        class="w-20 h-20 rounded-full border-4 border-[var(--bg)] object-cover shadow-sm">
                    <div class="flex gap-2">
                        <button id="other-dm-btn"
                            class="btn-primary bg-transparent text-[var(--text)] border border-[var(--border)]"><span
                                class="material-icons-round text-lg">mail</span></button>
                        <button id="other-follow-btn" class="btn-primary">フォロー</button>
                    </div>
                </div>
                <h2 class="text-2xl font-black leading-tight flex items-center gap-2 flex-wrap">
                    <span id="other-name"></span>
                    <span id="other-title" class="title-badge hidden"></span>
                </h2>
                <p id="other-uid" class="text-sm text-[var(--subtext)] font-mono"></p>
                <div class="flex items-center gap-4 mt-3">
                    <div class="flex items-center gap-1"><span class="font-bold" id="other-xp">0</span> <span
                            class="text-xs text-[var(--subtext)]">XP</span></div>
                    <div class="flex items-center gap-1"><span class="font-bold" id="other-rank">Unranked</span></div>
                </div>
            </div>
            <div class="border-b border-[var(--border)] font-bold px-4 py-2 text-sm">ポスト</div>
            <div id="other-timeline" class="divide-y divide-[var(--border)]"></div>
        </div>

        <!-- C. Chat (DM) -->
        <div id="tab-chat" class="hidden h-[calc(100vh-130px)] flex flex-col">
            <div
                class="p-3 border-b border-[var(--border)] flex items-center gap-4 sticky top-14 bg-[var(--bg)] z-10 px-4">
                <button onclick="history.back()"><span class="material-icons-round text-2xl">arrow_back</span></button>
                <span id="chat-target-name" class="font-bold text-lg"></span>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2 bg-[var(--bg)]"></div>
            <div class="p-3 border-t border-[var(--border)] bg-[var(--bg)] flex gap-2 items-center">
                <input id="chat-input" type="text"
                    class="flex-1 bg-[var(--border)]/50 rounded-full px-4 py-2 text-sm outline-none focus:bg-[var(--bg)] focus:ring-2 focus:ring-blue-500 transition"
                    placeholder="メッセージを作成">
                <button id="chat-send-btn" class="text-blue-500 p-2 font-bold"><span
                        class="material-icons-round">send</span></button>
            </div>
        </div>



        <!-- Navigation -->
        <nav
            class="fixed bottom-0 w-full max-w-xl bg-[var(--nav-bg)] border-t border-[var(--border)] flex justify-around py-3 z-50 backdrop-blur pb-6">
            <button onclick="switchTab('home')" class="nav-item nav-active" data-target="home"><span
                    class="material-icons-round text-3xl">home</span></button>
            <button onclick="switchTab('explore')" class="nav-item" data-target="explore"><span
                    class="material-icons-round text-3xl">search</span></button>

            <button onclick="switchTab('bottle')" class="nav-item" data-target="bottle"><span
                    class="material-icons-round text-3xl">sailing</span></button>
            <button onclick="switchTab('notif')" class="nav-item" data-target="notif">
                <span class="material-icons-round text-3xl">notifications</span>
                <div id="nav-badge" class="nav-badge"></div>
            </button>
            <button onclick="switchTab('profile')" class="nav-item" data-target="profile"><span
                    class="material-icons-round text-3xl">person</span></button>
        </nav>
    </div>

    <!-- ■ Auth Modal (ログイン要求モーダル) ■ -->
    <div id="auth-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-[var(--card)] p-8 rounded-3xl w-full max-w-sm shadow-2xl border border-[var(--border)] text-center relative">
            <button onclick="closeAuthModal()" class="absolute top-4 right-4 text-[var(--subtext)]"><span
                    class="material-icons-round">close</span></button>
            <h1 class="text-4xl font-black tracking-tighter mb-2">LoG</h1>
            <p class="text-[var(--subtext)] text-sm mb-8">この機能を利用するには、<br>ログインまたはアカウント作成が必要です。</p>

            <div class="space-y-4">
                <button id="google-login-btn"
                    class="w-full border border-[var(--border)] py-3 rounded-full font-bold flex justify-center items-center gap-3 hover:bg-[var(--border)]/50 transition">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                    Googleで続行
                </button>
                <div class="space-y-3 pt-4 border-t border-[var(--border)]">
                    <input id="auth-email" type="email" placeholder="Email"
                        class="w-full bg-[var(--border)]/30 border border-[var(--border)] rounded-xl p-3 outline-none focus:border-[var(--text)] transition">
                    <input id="auth-password" type="password" placeholder="Password"
                        class="w-full bg-[var(--border)]/30 border border-[var(--border)] rounded-xl p-3 outline-none focus:border-[var(--text)] transition">
                    <div class="flex gap-2">
                        <button onclick="emailAuth('login')" class="flex-1 btn-primary py-3">ログイン</button>
                        <button onclick="emailAuth('signup')"
                            class="flex-1 border border-[var(--border)] py-3 rounded-full font-bold hover:bg-[var(--border)]/50 transition">新規登録</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Modals -->
    <div id="bottle-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-[var(--card)] p-6 rounded-2xl w-80 shadow-2xl border border-[var(--border)] text-center">
            <h2 class="text-lg font-bold mb-2">手紙を流す</h2>
            <textarea id="bottle-input" rows="4"
                class="w-full bg-[var(--border)]/30 rounded-xl p-3 mb-4 text-sm outline-none resize-none"
                placeholder="ここになにか書いて..."></textarea>
            <div class="flex gap-2">
                <button onclick="document.getElementById('bottle-modal').classList.add('hidden')"
                    class="flex-1 py-3 text-sm font-bold text-[var(--subtext)]">やめる</button>
                <button onclick="sendBottle()" class="flex-1 btn-primary py-3">海に流す</button>
            </div>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-[var(--card)] p-6 rounded-2xl w-full max-w-sm shadow-2xl border border-[var(--border)] text-center">
            <h2 class="text-xl font-black mb-2">所属陣営の選択</h2>
            <p class="text-[var(--subtext)] text-sm mb-6">世界（Universe）のどこに所属するか選んでください。</p>

            <div class="grid grid-cols-1 gap-3 mb-6">
                <!-- Neon -->
                <label class="cursor-pointer relative">
                    <input type="radio" name="faction" value="neon" class="peer sr-only" checked>
                    <div
                        class="p-4 rounded-xl border-2 border-[var(--border)] peer-checked:border-pink-500 peer-checked:bg-pink-500/10 transition flex items-center gap-4 text-left">
                        <div
                            class="w-10 h-10 rounded-full bg-pink-500 flex items-center justify-center shadow-[0_0_15px_rgba(236,72,153,0.5)]">
                            <span class="material-icons-round text-white">whatshot</span>
                        </div>
                        <div>
                            <div class="font-black text-pink-500">Neon (ネオン)</div>
                            <div class="text-[10px] text-[var(--subtext)]">情熱と混沌の勢力</div>
                        </div>
                    </div>
                </label>
                <!-- Cyber -->
                <label class="cursor-pointer relative">
                    <input type="radio" name="faction" value="cyber" class="peer sr-only">
                    <div
                        class="p-4 rounded-xl border-2 border-[var(--border)] peer-checked:border-blue-500 peer-checked:bg-blue-500/10 transition flex items-center gap-4 text-left">
                        <div
                            class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center shadow-[0_0_15px_rgba(59,130,246,0.5)]">
                            <span class="material-icons-round text-white">memory</span>
                        </div>
                        <div>
                            <div class="font-black text-blue-500">Cyber (サイバー)</div>
                            <div class="text-[10px] text-[var(--subtext)]">技術と秩序の勢力</div>
                        </div>
                    </div>
                </label>
                <!-- Void -->
                <label class="cursor-pointer relative">
                    <input type="radio" name="faction" value="void" class="peer sr-only">
                    <div
                        class="p-4 rounded-xl border-2 border-gray-600 peer-checked:border-gray-300 peer-checked:bg-gray-500/10 transition flex items-center gap-4 text-left">
                        <div
                            class="w-10 h-10 rounded-full bg-gray-800 flex items-center justify-center shadow-[0_0_15px_rgba(255,255,255,0.2)] border border-gray-600">
                            <span class="material-icons-round text-gray-300">nightlight_round</span>
                        </div>
                        <div>
                            <div class="font-black text-gray-300">Void (ヴォイド)</div>
                            <div class="text-[10px] text-[var(--subtext)]">静寂と深淵の勢力</div>
                        </div>
                    </div>
                </label>
            </div>

            <input id="edit-name-input" type="text"
                class="w-full bg-[var(--border)]/30 rounded-xl border border-[var(--border)] p-4 mb-4 font-bold outline-none focus:border-[var(--text)] transition text-[var(--text)]"
                placeholder="表示名を入力 (例: Anonymous)">
            <button onclick="saveProfile()"
                class="w-full btn-primary py-4 text-lg font-black tracking-widest shadow-xl hover:scale-105 transition transform">世界へ降り立つ</button>
        </div>
    </div>

    <!-- LoG Market Modal -->
    <div id="market-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-[var(--card)] p-6 rounded-3xl w-full max-w-md shadow-2xl border border-[var(--border)] relative overflow-hidden flex flex-col max-h-[90vh]">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div
                        class="w-12 h-12 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                        <span class="material-icons-round text-2xl">storefront</span>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black text-emerald-400">LoG Market</h2>
                        <div class="text-[10px] font-bold text-[var(--subtext)]">所持: <span
                                class="text-[var(--text)] text-sm ml-1" id="market-my-xp">0</span> XP</div>
                    </div>
                </div>
                <button onclick="document.getElementById('market-modal').classList.add('hidden')"
                    class="text-[var(--subtext)] hover:text-white transition"><span
                        class="material-icons-round">close</span></button>
            </div>

            <!-- Content Scroll Area -->
            <div class="flex-1 overflow-y-auto pr-2 space-y-6">

                <!-- Section 1: Titles -->
                <div>
                    <h3 class="text-sm font-bold text-[var(--subtext)] uppercase tracking-wider mb-3">プレミアム称号</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="glass-panel p-4 flex justify-between items-center">
                            <div>
                                <span
                                    class="title-badge bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold px-2 py-0.5 rounded text-xs">Pioneer</span>
                                <div class="text-[10px] text-[var(--subtext)] mt-1">最初期参加者の証</div>
                            </div>
                            <button onclick="buyItem('title', 'Pioneer', 500)"
                                class="btn-primary py-1 px-4 text-xs font-bold! tracking-wider flex items-center gap-1 justify-center"><span
                                    class="material-icons-round text-[14px]">local_atm</span> 500</button>
                        </div>
                        <div class="glass-panel p-4 flex justify-between items-center">
                            <div>
                                <span
                                    class="title-badge bg-gradient-to-r from-yellow-500 to-orange-500 text-white font-bold px-2 py-0.5 rounded text-xs">Whale</span>
                                <div class="text-[10px] text-[var(--subtext)] mt-1">富豪の証</div>
                            </div>
                            <button onclick="buyItem('title', 'Whale', 5000)"
                                class="btn-primary py-1 px-4 text-xs font-bold! tracking-wider flex items-center gap-1 justify-center"><span
                                    class="material-icons-round text-[14px]">local_atm</span> 5k</button>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Faction War -->
                <div>
                    <h3 class="text-sm font-bold text-[var(--subtext)] uppercase tracking-wider mb-3">陣営支援物資</h3>
                    <div class="grid grid-cols-1 gap-3">
                        <div class="glass-panel p-4 flex gap-4 items-center">
                            <div class="w-12 h-12 bg-[var(--border)] rounded-xl flex items-center justify-center">
                                <span class="material-icons-round text-yellow-500">campaign</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">陣営プロパガンダ</div>
                                <div class="text-[10px] text-[var(--subtext)]">自陣営に +100 Point</div>
                            </div>
                            <button onclick="buyItem('faction_boost', 100, 150)"
                                class="btn-primary py-1 px-3 text-xs flex flex-col items-center">
                                <span>買う</span>
                                <span class="text-[8px] opacity-70">150 XP</span>
                            </button>
                        </div>
                        <div class="glass-panel p-4 flex gap-4 items-center">
                            <div class="w-12 h-12 bg-[var(--border)] rounded-xl flex items-center justify-center">
                                <span class="material-icons-round text-red-500">local_fire_department</span>
                            </div>
                            <div class="flex-1">
                                <div class="font-bold text-sm">総攻撃司令</div>
                                <div class="text-[10px] text-[var(--subtext)]">自陣営に +1000 Point</div>
                            </div>
                            <button onclick="buyItem('faction_boost', 1000, 1200)"
                                class="btn-primary py-1 px-3 text-xs flex flex-col items-center">
                                <span>買う</span>
                                <span class="text-[8px] opacity-70">1.2k XP</span>
                            </button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-[var(--card)] p-6 rounded-2xl w-80 shadow-2xl border border-[var(--border)]">
            <button onclick="toggleDarkMode()"
                class="w-full flex justify-between items-center p-3 font-bold mb-2 rounded-lg hover:bg-[var(--border)]/50 transition">ダークモード
                <span class="material-icons-round">dark_mode</span></button>
            <button onclick="signOutApp()"
                class="w-full text-left p-3 text-[var(--danger)] font-bold rounded-lg hover:bg-red-500/10 transition">ログアウト</button>
            <button onclick="document.getElementById('settings-modal').classList.add('hidden')"
                class="mt-4 w-full py-2 text-sm font-bold text-[var(--subtext)]">閉じる</button>
        </div>
    </div>



    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, increment, where, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { shareToX } from './assets/js/core.js';

        const firebaseConfig = { apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs", authDomain: "lo-g-8a620.firebaseapp.com", projectId: "lo-g-8a620", storageBucket: "lo-g-8a620.firebasestorage.app", messagingSenderId: "780857099698", appId: "1:780857099698:web:b6cb359114da98ab3e50ab" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.shareBottle = () => {
            const text = document.getElementById('bottle-text').innerText;
            const author = document.getElementById('bottle-author').innerText;
            const shareText = `海で見つけた名無しの漂流ログ:\n「${text}」\n- ${author}\n\n#LoG_Ecosystem #漂流ログ`;
            shareToX(shareText, 'https://lo-g-8a620.web.app/app.html');
        };

        window.sharePost = (text, author) => {
            let truncated = text;
            if (truncated.length > 50) truncated = truncated.slice(0, 50) + '...';
            const shareText = `${author} のログ:\n「${truncated}」\n\n#LoG_Ecosystem #LoG_SNS`;
            shareToX(shareText, 'https://lo-g-8a620.web.app/app.html');
        };

        let currentUser = null, myProfile = null, quoteData = null, isPoll = false;
        let currentProfileTab = 'posts', currentChatUser = null;

        const MISSIONS = { login: { label: "ログイン", target: 1, xp: 50 }, like: { label: "3回いいね", target: 3, xp: 30 }, post: { label: "1回ポスト", target: 1, xp: 20 } };
        const TITLES = ["見習い", "住人", "詩人", "哲学", "虚無", "猫", "神", "富豪", "ニート", "将軍", "伝説", "歩行者", "空気", "勇者"];

        // Utils
        const showToast = (m) => { const t = document.getElementById('toast'); t.innerText = m; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); };
        const authErr = (e) => showToast("Error: " + e.message);

        // ログイン要求ガード (未ログインならモーダルを出してfalseを返す)
        window.requireAuth = () => {
            if (!currentUser) {
                document.getElementById('auth-modal').classList.remove('hidden');
                return false;
            }
            return true;
        };
        window.closeAuthModal = () => document.getElementById('auth-modal').classList.add('hidden');

        // Auth
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(authErr);
        window.emailAuth = (t) => {
            const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value;
            if (t === 'login') signInWithEmailAndPassword(auth, e, p).catch(authErr);
            else createUserWithEmailAndPassword(auth, e, p).catch(authErr);
        };

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUser = u;
                closeAuthModal(); // ログイン成功したらモーダルを閉じる
                const d = await getDoc(doc(db, "users", u.uid));
                if (d.exists()) {
                    myProfile = d.data();
                    if (!myProfile.following) myProfile.following = [];
                    await checkStreak();
                    await checkMissions('login');
                    initApp(true);

                    // Force faction selection if not set
                    if (!myProfile.faction) {
                        document.getElementById('profile-modal').classList.remove('hidden');
                    }
                } else {
                    document.getElementById('profile-modal').classList.remove('hidden');
                }
            } else {
                currentUser = null;
                myProfile = null;
                initApp(false); // 未ログイン状態でもアプリを描画する
            }
        });

        // App Logic
        async function checkStreak() {
            const now = new Date();
            const last = myProfile.lastLogin ? myProfile.lastLogin.toDate() : new Date(0);
            const diff = Math.floor((now - last) / (1000 * 60 * 60 * 24));
            let streak = (diff === 1) ? (myProfile.streak || 0) + 1 : (diff === 0 ? (myProfile.streak || 0) : 1);
            if (diff >= 1 || !myProfile.lastLogin) {
                await updateDoc(doc(db, "users", currentUser.uid), {
                    lastLogin: serverTimestamp(),
                    streak,
                    xp: increment(50), // Daily Login Bonus
                    expireAt: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000)
                });
                myProfile.streak = streak;
                myProfile.xp = (myProfile.xp || 0) + 50;
                showToast("ログインボーナス: +50 XP");
            }
        }

        async function checkMissions(type) {
            if (!currentUser) return;
            const today = new Date().toISOString().split('T')[0];
            let missions = myProfile.missions || {};
            if (missions.date !== today) missions = { date: today, login: 0, like: 0, post: 0, claimed: [] };
            if (type && missions[type] !== undefined) missions[type]++;

            let xpAdd = 0;
            for (const k in MISSIONS) {
                if (missions[k] >= MISSIONS[k].target && !missions.claimed.includes(k)) {
                    xpAdd += MISSIONS[k].xp;
                    missions.claimed.push(k);
                    showToast(`達成: ${MISSIONS[k].label} (+${MISSIONS[k].xp}XP)`);
                }
            }
            if (xpAdd > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), { missions, xp: increment(xpAdd) });
                myProfile.xp = (myProfile.xp || 0) + xpAdd;
            } else {
                await updateDoc(doc(db, "users", currentUser.uid), { missions });
            }
            myProfile.missions = missions;
            updateMyProfileUI();
        }

        function initApp(isLogged) {
            if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');

            // 誰でも見れるデータのロード
            loadTimeline();
            loadRanking();

            if (isLogged) {
                // ログイン済み用UIセットアップ
                updateMyProfileUI();
                loadNotifications();
                document.getElementById('post-text').removeAttribute('readonly');
                document.getElementById('post-text').style.pointerEvents = 'auto';
                document.getElementById('post-btn').style.pointerEvents = 'auto';
                document.querySelector('.btn-ghost > span.material-icons-round').parentElement.style.pointerEvents = 'auto';
            } else {
                // ゲスト用UIセットアップ
                document.getElementById('header-icon').src = "https://api.dicebear.com/7.x/notionists/svg?seed=guest";
                document.getElementById('input-icon').src = "https://api.dicebear.com/7.x/notionists/svg?seed=guest";
                // 投稿欄をクリックした時にログインモーダルを出すように
                document.getElementById('post-text').setAttribute('readonly', 'true');
                document.getElementById('post-text').style.pointerEvents = 'none'; // クリックイベントを親(flex-1)に貫通させる
                document.getElementById('post-btn').style.pointerEvents = 'none';
            }
        }

        function updateMyProfileUI() {
            if (!myProfile) return;
            const icon = myProfile.icon || `https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`;
            document.getElementById('header-icon').src = icon;
            document.getElementById('input-icon').src = icon;
            document.getElementById('profile-big-icon').src = icon;
            document.getElementById('profile-name').innerText = myProfile.name;
            document.getElementById('profile-uid').innerText = "@" + currentUser.uid.slice(0, 8);
            document.getElementById('streak-count').innerText = myProfile.streak || 0;
            document.getElementById('profile-xp').innerText = myProfile.xp || 0;

            const fBadge = document.getElementById('profile-faction-badge');
            if (myProfile.faction) {
                fBadge.classList.remove('hidden');
                fBadge.classList.add('flex');
                const fIcon = document.getElementById('profile-faction-icon');
                const fName = document.getElementById('profile-faction-name');
                if (myProfile.faction === 'neon') {
                    fBadge.className = 'flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold border border-pink-500/50 bg-pink-500/10 text-pink-500';
                    fIcon.innerText = 'whatshot'; fName.innerText = 'Neon';
                } else if (myProfile.faction === 'cyber') {
                    fBadge.className = 'flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold border border-blue-500/50 bg-blue-500/10 text-blue-500';
                    fIcon.innerText = 'memory'; fName.innerText = 'Cyber';
                } else {
                    fBadge.className = 'flex items-center gap-1 px-2 py-0.5 rounded text-[10px] font-bold border border-gray-400/50 bg-gray-500/10 text-gray-300';
                    fIcon.innerText = 'nightlight_round'; fName.innerText = 'Void';
                }
            } else {
                fBadge.classList.add('hidden');
                fBadge.classList.remove('flex');
            }

            const tEl = document.getElementById('profile-title');
            if (myProfile.title) { tEl.innerText = myProfile.title; tEl.classList.remove('hidden'); }

            if (myProfile.pinnedId) loadPinned(myProfile.pinnedId);

            // Mission UI
            const mList = document.getElementById('mission-list'); mList.innerHTML = "";
            const mData = myProfile.missions || { login: 0, like: 0, post: 0, claimed: [] };
            for (const k in MISSIONS) {
                const m = MISSIONS[k];
                const cur = Math.min(mData[k] || 0, m.target);
                const pct = (cur / m.target) * 100;
                mList.innerHTML += `<div class="bg-[var(--border)]/20 rounded p-2 text-xs"><div class="flex justify-between mb-1"><span>${m.label}</span><span>${cur}/${m.target}</span></div><div class="h-1.5 bg-[var(--border)] rounded-full overflow-hidden"><div class="h-full bg-[var(--success)] transition-all" style="width:${pct}%"></div></div></div>`;
            }
        }

        async function loadPinned(id) {
            const d = await getDoc(doc(db, "logs", id));
            if (d.exists()) {
                document.getElementById('pinned-area').classList.remove('hidden');
                document.getElementById('pinned-content').innerHTML = buildPostHTML(d.id, d.data(), true);
            }
        }

        function getRank(xp) {
            xp = xp || 0;
            if (xp >= 2000) return { name: "Obsidian", class: "rank-obsidian" };
            if (xp >= 1000) return { name: "Diamond", class: "rank-diamond" };
            if (xp >= 500) return { name: "Gold", class: "rank-gold" };
            if (xp >= 200) return { name: "Silver", class: "rank-silver" };
            if (xp >= 50) return { name: "Bronze", class: "rank-bronze" };
            return { name: "Unranked", class: "" };
        }

        // --- Other Profile ---
        window.viewUser = async (uid) => {
            if (!requireAuth()) return;
            if (uid === currentUser.uid) { switchTab('profile'); return; }
            const d = await getDoc(doc(db, "users", uid));
            if (!d.exists()) return;
            const u = d.data();

            document.getElementById('other-name').innerText = u.name;
            document.getElementById('other-icon').src = u.icon;
            document.getElementById('other-uid').innerText = "@" + uid.slice(0, 8);
            document.getElementById('other-xp').innerText = u.xp || 0;
            document.getElementById('other-rank').innerText = getRank(u.xp).name;

            const tEl = document.getElementById('other-title');
            if (u.title) { tEl.innerText = u.title; tEl.classList.remove('hidden'); } else tEl.classList.add('hidden');

            const btn = document.getElementById('other-follow-btn');
            const isFollowing = myProfile.following && myProfile.following.includes(uid);
            btn.innerText = isFollowing ? "フォロー中" : "フォローする";
            btn.className = isFollowing ? "btn-follow following" : "btn-primary";
            btn.onclick = () => toggleFollow(uid, btn);

            document.getElementById('other-dm-btn').onclick = () => openChat(uid, u.name);

            const q = query(collection(db, "logs"), where("uid", "==", uid), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(q, (s) => {
                document.getElementById('other-timeline').innerHTML = "";
                s.forEach(doc => document.getElementById('other-timeline').innerHTML += buildPostHTML(doc.id, doc.data()));
            });
            switchTab('other-profile');
        };

        window.toggleFollow = async (uid, btn) => {
            if (!requireAuth()) return;
            const myRef = doc(db, "users", currentUser.uid);
            if (myProfile.following && myProfile.following.includes(uid)) {
                await updateDoc(myRef, { following: arrayRemove(uid) });
                myProfile.following = myProfile.following.filter(id => id !== uid);
                btn.innerText = "フォローする";
                btn.className = "btn-primary";
            } else {
                await updateDoc(myRef, { following: arrayUnion(uid) });
                if (!myProfile.following) myProfile.following = [];
                myProfile.following.push(uid);
                btn.innerText = "フォロー中";
                btn.className = "btn-follow following";

                await addDoc(collection(db, "notif"), {
                    to: uid, from: myProfile.name, type: 'follow', read: false, createdAt: serverTimestamp(), expireAt: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000)
                });
            }
        };

        // --- Post & Timeline ---
        window.togglePoll = () => {
            if (!requireAuth()) return;
            isPoll = !isPoll; document.getElementById('poll-creator').classList.toggle('hidden');
        };
        document.getElementById('post-btn').onclick = async () => {
            if (!requireAuth()) return;
            const text = document.getElementById('post-text').value; const p1 = document.getElementById('poll-1').value; const p2 = document.getElementById('poll-2').value;
            if (!text.trim() && !p1) return;

            const exp = new Date(); exp.setDate(exp.getDate() + 90);
            const data = { text, uid: currentUser.uid, authorName: myProfile.name, authorIcon: myProfile.icon, authorTitle: myProfile.title || "", createdAt: serverTimestamp(), expireAt: exp, likes: [] };
            if (isPoll && p1 && p2) data.poll = { total: 0, options: [{ id: 0, txt: p1, votes: [] }, { id: 1, txt: p2, votes: [] }] };
            if (quoteData) data.quote = quoteData;

            await addDoc(collection(db, "logs"), data);

            // Posting Reward: +5 XP
            await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(5) });
            myProfile.xp = (myProfile.xp || 0) + 5;
            updateMyProfileUI();

            await checkMissions('post');

            document.getElementById('post-text').value = "";
            if (isPoll) togglePoll();
            document.getElementById('poll-1').value = ""; document.getElementById('poll-2').value = "";
            cancelQuote();
        };

        function loadTimeline() {
            onSnapshot(query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50)), (snap) => {
                const c = document.getElementById('timeline'); c.innerHTML = "";
                snap.forEach(d => {
                    c.innerHTML += buildPostHTML(d.id, d.data());
                });
            });
            if (currentUser) loadMyPosts();
        }

        window.switchProfileSubTab = (type) => {
            currentProfileTab = type;
            document.getElementById('tab-btn-posts').className = type === 'posts' ? "flex-1 text-center py-3 font-bold border-b-2 border-[var(--text)] cursor-pointer" : "flex-1 text-center py-3 font-bold text-[var(--subtext)] cursor-pointer";
            document.getElementById('tab-btn-likes').className = type === 'likes' ? "flex-1 text-center py-3 font-bold border-b-2 border-[var(--text)] cursor-pointer" : "flex-1 text-center py-3 font-bold text-[var(--subtext)] cursor-pointer";
            if (type === 'posts') loadMyPosts(); else loadMyLikes();
        };

        function loadMyPosts() {
            if (!currentUser) return;
            onSnapshot(query(collection(db, "logs"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20)), (s) => {
                const c = document.getElementById('my-timeline'); c.innerHTML = "";
                s.forEach(d => c.innerHTML += buildPostHTML(d.id, d.data()));
            });
        }
        function loadMyLikes() {
            if (!currentUser) return;
            onSnapshot(query(collection(db, "logs"), where("likes", "array-contains", currentUser.uid), limit(20)), (s) => {
                const c = document.getElementById('my-timeline'); c.innerHTML = "";
                if (s.empty) c.innerHTML = "<div class='p-4 text-center text-sm text-[var(--subtext)]'>いいねなし</div>";
                s.forEach(d => c.innerHTML += buildPostHTML(d.id, d.data()));
            });
        }

        function buildPostHTML(id, d, isPin = false) {
            // currentUserがnull（未ログイン）の場合のエラーを防ぐため、安全なチェックを行う
            const isLiked = currentUser && d.likes && d.likes.includes(currentUser.uid);
            const isMine = currentUser && d.uid === currentUser.uid;
            let pollUI = "";
            if (d.poll) {
                pollUI = `<div class="poll-container">`;
                d.poll.options.forEach((o, i) => {
                    const pct = d.poll.total ? Math.round((o.votes.length / d.poll.total) * 100) : 0;
                    pollUI += `<div onclick="event.stopPropagation();vote('${id}',${i})" class="poll-option hover:bg-[var(--border)]/20"><div class="poll-fill" style="width:${pct}%"></div><span class="z-10 text-sm font-bold">${o.txt}</span><span class="z-10 text-xs font-bold">${pct}%</span></div>`;
                });
                pollUI += `</div>`;
            }
            const profileClick = `event.stopPropagation(); viewUser('${d.uid}')`;

            return `
                <div class="post-card flex gap-3">
                    <img src="${d.authorIcon}" class="w-10 h-10 rounded-full object-cover flex-shrink-0 cursor-pointer" onclick="${profileClick}">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <div class="flex items-center gap-1 overflow-hidden">
                                <span class="font-bold text-[15px] truncate cursor-pointer hover:underline" onclick="${profileClick}">${d.authorName}</span>
                                ${d.authorTitle ? `<span class="title-badge">${d.authorTitle}</span>` : ''}
                                <span class="text-[var(--subtext)] text-sm truncate">@${d.uid.slice(0, 8)}</span>
                            </div>
                            ${isMine && !isPin ? `<div class="relative group"><button class="text-[var(--subtext)]">•••</button><div class="hidden group-hover:block absolute right-0 bg-[var(--card)] border border-[var(--border)] shadow-lg rounded p-1 z-10 w-24"><button onclick="pin('${id}')" class="w-full text-left text-xs p-2 hover:bg-[var(--border)]">固定</button><button onclick="del('${id}')" class="w-full text-left text-xs p-2 text-[var(--danger)] hover:bg-[var(--border)]">削除</button></div></div>` : ''}
                        </div>
                        <p class="text-[15px] mt-1 whitespace-pre-wrap leading-relaxed break-words">${d.text}</p>
                        ${pollUI}
                        ${d.quote ? `<div class="p-3 mt-2 rounded-xl border border-[var(--border)] text-sm"><div class="font-bold">${d.quote.name}</div><div class="text-[var(--subtext)] truncate">${d.quote.text}</div></div>` : ''}
                        <div class="flex justify-between mt-3 max-w-sm text-[var(--subtext)] pr-4">
                            <button onclick="event.stopPropagation();setQuote('${d.text.replace(/'/g, "\\'").replace(/\n/g, " ")}','${d.authorName}')" class="btn-ghost"><span class="material-icons-round text-lg">cached</span></button>
                            <button onclick="event.stopPropagation(); window.sharePost('${d.text.replace(/'/g, "\\'").replace(/\n/g, " ")}', '${d.authorName}')" class="btn-ghost hover:text-[#1da1f2] transition"><svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 22.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"></path></svg></button>
                            <button onclick="event.stopPropagation();like('${id}','${d.uid}')" class="btn-ghost ${isLiked ? 'like-active like-anim text-[#f91880]' : ''}"><span class="material-icons-round text-lg">${isLiked ? 'favorite' : 'favorite_border'}</span> <span class="text-xs ml-1">${d.likes ? d.likes.length : 0}</span></button>
                        </div>
                    </div>
                </div>`;
        }

        // --- Actions ---
        window.vote = async (id, idx) => {
            if (!requireAuth()) return;
            const r = doc(db, "logs", id); const d = (await getDoc(r)).data();
            let voted = false; d.poll.options.forEach(o => { if (o.votes.includes(currentUser.uid)) voted = true });
            if (voted) return showToast("投票済み");
            d.poll.options[idx].votes.push(currentUser.uid); d.poll.total++; await updateDoc(r, { poll: d.poll });
        };
        window.like = async (id, to) => {
            if (!requireAuth()) return;
            const r = doc(db, "logs", id); const d = (await getDoc(r)).data();
            if (d.likes.includes(currentUser.uid)) await updateDoc(r, { likes: arrayRemove(currentUser.uid) });
            else {
                await updateDoc(r, { likes: arrayUnion(currentUser.uid) });

                // Liking Reward: +1 XP
                await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(1) });
                myProfile.xp = (myProfile.xp || 0) + 1;
                updateMyProfileUI();

                await checkMissions('like');
                if (to !== currentUser.uid) await addDoc(collection(db, "notif"), { to, from: myProfile.name, type: 'like', read: false, createdAt: serverTimestamp(), expireAt: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000) });
            }
        };
        window.setQuote = (t, n) => {
            if (!requireAuth()) return;
            quoteData = { text: t, name: n }; document.getElementById('quote-preview').classList.remove('hidden'); document.getElementById('quote-target-name').innerText = n; document.getElementById('quote-target-text').innerText = t;
        };
        window.cancelQuote = () => { quoteData = null; document.getElementById('quote-preview').classList.add('hidden'); };
        window.pin = async (id) => { await updateDoc(doc(db, "users", currentUser.uid), { pinnedId: id }); showToast("固定しました"); location.reload(); };
        window.del = async (id) => { if (confirm("削除？")) await deleteDoc(doc(db, "logs", id)); };

        // --- Explore & Notif ---
        function loadRanking() {
            onSnapshot(query(collection(db, "users"), orderBy("xp", "desc"), limit(20)), (s) => {
                const l = document.getElementById('explore-list'); l.innerHTML = "";
                let i = 1;
                s.forEach(d => {
                    const u = d.data();
                    let rankClass = ""; if (i === 1) rankClass = "text-yellow-500 font-black";
                    l.innerHTML += `<div class="p-4 flex items-center gap-3 cursor-pointer hover:bg-[var(--border)]/20" onclick="viewUser('${d.id}')"><span class="w-6 text-center ${rankClass}">${i}</span><img src="${u.icon}" class="w-10 h-10 rounded-full"><div class="flex-1"><div class="font-bold text-sm">${u.name}</div><div class="text-xs text-[var(--subtext)]">${u.xp || 0} XP</div></div></div>`; i++;
                });
            });
        }
        function loadNotifications() {
            if (!currentUser) return;
            onSnapshot(query(collection(db, "notif"), where("to", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20)), (s) => {
                const l = document.getElementById('notif-list'); l.innerHTML = "";
                const b = document.getElementById('nav-badge');
                let unread = false;
                if (s.empty) l.innerHTML = `<div class="p-8 text-center text-sm text-[var(--subtext)]">通知なし</div>`;
                s.forEach(d => {
                    const n = d.data();
                    if (!n.read) unread = true;
                    l.innerHTML += `<div class="p-4 flex gap-3 ${!n.read ? 'bg-[var(--accent)]/10' : ''}"><span class="material-icons-round text-[var(--accent)]">${n.type === 'like' ? 'favorite' : (n.type === 'follow' ? 'person_add' : 'reply')}</span><div class="text-sm"><span class="font-bold">${n.from}</span>さんが${n.type === 'like' ? 'いいね' : (n.type === 'follow' ? 'フォロー' : '反応')}しました</div></div>`;
                    if (!n.read) updateDoc(doc(db, "notif", d.id), { read: true });
                });
                b.style.display = unread ? 'block' : 'none';
            });
        }
        window.searchUsers = () => {
            const v = document.getElementById('search-input').value.toLowerCase();
            const items = document.querySelectorAll('#explore-list > div');
            items.forEach(i => i.style.display = i.innerText.toLowerCase().includes(v) ? 'flex' : 'none');
        };

        // --- Bottle ---
        window.openBottleModal = () => {
            if (!requireAuth()) return;
            document.getElementById('bottle-modal').classList.remove('hidden');
        }
        window.sendBottle = async () => {
            const text = document.getElementById('bottle-input').value; if (!text.trim()) return;
            const exp = new Date(); exp.setDate(exp.getDate() + 30);
            await addDoc(collection(db, "bottles"), { text, senderUid: currentUser.uid, createdAt: serverTimestamp(), expireAt: exp, status: 'unread' });
            await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(20) });
            showToast("手紙を海に流しました"); document.getElementById('bottle-input').value = ""; document.getElementById('bottle-modal').classList.add('hidden');
        };
        window.pickupBottle = async () => {
            if (!requireAuth()) return;
            const q = query(collection(db, "bottles"), where("status", "==", "unread"), orderBy("createdAt", "desc"), limit(20));
            const snap = await getDocs(q);
            const others = snap.docs.filter(d => d.data().senderUid !== currentUser.uid);
            if (others.length === 0) return showToast("漂着物なし");
            const randomDoc = others[Math.floor(Math.random() * others.length)];
            const d = randomDoc.data();
            document.getElementById('bottle-result').classList.remove('hidden');
            document.getElementById('bottle-text').innerText = d.text;
            document.getElementById('bottle-date').innerText = new Date(d.createdAt.toDate()).toLocaleDateString();
            await updateDoc(doc(db, "bottles", randomDoc.id), { status: 'read' });
        };

        // --- Gacha ---
        window.spinGacha = async () => {
            if (!requireAuth()) return;
            if ((myProfile.xp || 0) < 50) return showToast("XP不足 (50必要)");
            if (!confirm("50 XP消費しますか？")) return;
            const newTitle = TITLES[Math.floor(Math.random() * TITLES.length)];
            await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(-50), title: newTitle });
            myProfile.xp -= 50; myProfile.title = newTitle; updateMyProfileUI();
            showToast(`称号GET: [${newTitle}]`);
        };

        // --- LoG Market ---
        window.buyItem = async (type, itemData, cost) => {
            if (!requireAuth()) return;
            if ((myProfile.xp || 0) < cost) return showToast(`XP不足 (${cost}必要)`);
            if (!confirm(`${cost} XP消費しますか？`)) return;

            if (type === 'title') {
                if (myProfile.title === itemData) return showToast("既に装備中です");
                await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(-cost), title: itemData });
                myProfile.xp -= cost; myProfile.title = itemData; updateMyProfileUI();
                showToast(`称号GET: [${itemData}]`);
            } else if (type === 'faction_boost') {
                if (!myProfile.faction) return showToast("陣営に所属していません");
                await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(-cost) });

                // Add points to a global faction document (e.g. 'universe/factions')
                await setDoc(doc(db, "universe", "factions"), {
                    [myProfile.faction]: increment(itemData)
                }, { merge: true });

                myProfile.xp -= cost; updateMyProfileUI();
                showToast(`${myProfile.faction} 陣営に ${itemData} Point 貢献しました🔥`);
            }

            // UI更新
            const xpDisplay = document.getElementById('market-my-xp');
            if (xpDisplay) xpDisplay.innerText = myProfile.xp;
        };

        // --- Chat ---
        window.openChat = (uid, name) => {
            if (!requireAuth()) return;
            currentChatUser = uid; document.getElementById('chat-target-name').innerText = name; switchTab('chat'); loadMessages(uid);
        };
        function loadMessages(t) {
            onSnapshot(query(collection(db, "chats", [currentUser.uid, t].sort().join("_"), "messages"), orderBy("createdAt", "asc"), limit(50)), (s) => {
                const d = document.getElementById('chat-messages'); d.innerHTML = "";
                s.forEach(o => { const v = o.data(); const m = v.senderId === currentUser.uid; d.innerHTML += `<div class="flex ${m ? 'justify-end' : 'justify-start'}"><div class="max-w-[70%] px-4 py-2 rounded-2xl text-[15px] ${m ? 'bg-blue-500 text-white rounded-br-sm' : 'bg-gray-100 text-black rounded-bl-sm'}">${v.text}</div></div>`; });
                d.scrollTop = d.scrollHeight;
            });
        }
        document.getElementById('chat-send-btn').onclick = async () => { const t = document.getElementById('chat-input').value; if (!t.trim()) return; await addDoc(collection(db, "chats", [currentUser.uid, currentChatUser].sort().join("_"), "messages"), { text: t, senderId: currentUser.uid, createdAt: serverTimestamp(), expireAt: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000) }); document.getElementById('chat-input').value = ""; };

        // --- Common ---
        window.saveProfile = async () => {
            const n = document.getElementById('edit-name-input').value;
            if (!n) return;

            let faction = 'void';
            const factions = document.getElementsByName('faction');
            for (let i = 0; i < factions.length; i++) {
                if (factions[i].checked) {
                    faction = factions[i].value;
                    break;
                }
            }

            await setDoc(doc(db, "users", currentUser.uid), {
                name: n,
                icon: `https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`,
                xp: 100, // Initial 100 XP to start economy
                faction: faction,
                expireAt: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000)
            }, { merge: true });
            location.reload();
        };
        window.toggleDarkMode = () => { document.body.classList.toggle('dark'); localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light'); };
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.signOutApp = () => { signOut(auth); document.getElementById('settings-modal').classList.add('hidden'); };

        window.switchTab = (t) => {
            // 通知とプロフィールタブはログイン必須にする
            if ((t === 'notif' || t === 'profile') && !requireAuth()) return;

            ['home', 'explore', 'bottle', 'notif', 'profile', 'other-profile', 'chat'].forEach(x => {
                const el = document.getElementById(`tab-${x}`);
                if (el) el.classList.add('hidden');
            });

            const targetEl = document.getElementById(`tab-${t}`);
            if (targetEl) targetEl.classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('nav-active'));
            const b = document.querySelector(`.nav-item[data-target="${t}"]`); if (b) b.classList.add('nav-active');
            if (t === 'notif') document.getElementById('nav-badge').style.display = 'none';

            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
    </script>
</body>

</html>