<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LoG Beta 6.0</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1539164935971262" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* テーマ変数 */
        :root { --primary: #000000; --bg: #ffffff; --card: #ffffff; --text: #0f1419; --border: #eff3f4; --subtext: #536471; --accent: #1d9bf0; }
        .dark-mode { --primary: #ffffff; --bg: #000000; --card: #000000; --text: #e7e9ea; --border: #2f3336; --subtext: #71767b; }

        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', 'Noto Sans JP', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; transition: background 0.3s, color 0.3s; }
        .hidden { display: none !important; }

        /* UIパーツ */
        .btn-main { background: var(--primary); color: var(--bg); border-radius: 99px; padding: 6px 16px; font-weight: 700; font-size: 0.9rem; transition: 0.2s; }
        .btn-outline { border: 1px solid var(--border); color: var(--text); border-radius: 99px; padding: 6px 16px; font-weight: 700; font-size: 0.9rem; }
        
        .nav-item { color: var(--subtext); padding: 10px; transition: 0.2s; position: relative; }
        .nav-active { color: var(--text); }
        .nav-badge { position: absolute; top: 5px; right: 5px; width: 8px; height: 8px; background: #f4212e; border-radius: 50%; display: none; }

        .quote-box { border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-top: 12px; font-size: 0.95rem; }
        .poll-bar { height: 100%; background-color: var(--accent); opacity: 0.2; position: absolute; top: 0; left: 0; border-radius: 4px; transition: width 0.5s; }
        
        .like-active { color: #f91880 !important; }
        .like-anim { animation: heartPop 0.2s ease-out; }
        @keyframes heartPop { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }

        /* ランク色 */
        .rank-gold { color: #d4af37; font-weight: 900; }
        .rank-diamond { color: #00bfff; font-weight: 900; }
        
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body>

    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-8 bg-white transition-colors duration-500">
        <h1 class="text-6xl font-black tracking-tighter mb-2">LoG</h1>
        <span class="text-xs font-bold bg-black text-white px-2 py-1 rounded mb-8">BETA 6.0</span>
        <div class="w-full max-w-xs space-y-4">
            <button id="google-login-btn" class="w-full border py-3 rounded-full font-bold flex justify-center gap-2 hover:bg-gray-50"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Google</button>
            <button id="email-login-btn" class="w-full bg-black text-white py-3 rounded-full font-bold">Email Login</button>
        </div>
        <div id="email-form" class="hidden w-full max-w-xs space-y-3 mt-4">
            <input id="auth-email" type="email" placeholder="Email" class="w-full border p-3 rounded-lg">
            <input id="auth-password" type="password" placeholder="Pass" class="w-full border p-3 rounded-lg">
            <button onclick="emailAuth('login')" class="w-full bg-black text-white py-2 rounded-lg font-bold">ログイン</button>
            <button onclick="emailAuth('signup')" class="w-full text-xs text-gray-500 underline">新規登録</button>
        </div>
    </div>

    <div id="app-screen" class="hidden max-w-xl mx-auto min-h-screen bg-[var(--bg)] shadow-xl relative pb-20 border-x border-[var(--border)]">
        
        <header class="sticky top-0 bg-[var(--bg)]/90 backdrop-blur z-30 border-b border-[var(--border)] px-4 py-3 flex justify-between items-center" onclick="window.scrollTo(0,0)">
            <img id="header-icon" src="" class="w-8 h-8 rounded-full object-cover" onclick="switchTab('profile')">
            <div class="text-xl font-black cursor-pointer">LoG</div>
            <div class="flex items-center gap-1 text-xs font-bold text-orange-500">
                <span class="material-icons-round text-base">local_fire_department</span>
                <span id="streak-count">0</span>
            </div>
        </header>

        <div id="tab-home" class="pb-24">
            <div class="p-4 border-b border-[var(--border)]">
                <div class="flex gap-3">
                    <img id="input-icon" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
                    <div class="flex-1">
                        <textarea id="post-text" rows="2" placeholder="いまどうしてる？" class="w-full text-lg resize-none mb-2 bg-transparent focus:outline-none placeholder-[var(--subtext)]"></textarea>
                        
                        <div id="poll-creator" class="hidden mb-3 space-y-2 p-3 border border-[var(--border)] rounded-xl">
                            <input id="poll-opt-1" type="text" placeholder="選択肢 1" class="w-full bg-[var(--bg)] border border-[var(--border)] rounded p-2 text-sm">
                            <input id="poll-opt-2" type="text" placeholder="選択肢 2" class="w-full bg-[var(--bg)] border border-[var(--border)] rounded p-2 text-sm">
                            <button onclick="togglePollCreator()" class="text-xs text-red-500 font-bold">削除</button>
                        </div>

                        <div id="quote-preview" class="hidden mb-3 p-3 rounded-xl border border-[var(--border)] text-sm relative">
                            <button onclick="cancelQuote()" class="absolute top-1 right-2">×</button>
                            <div class="font-bold mb-1" id="quote-target-name"></div>
                            <div class="truncate text-[var(--subtext)]" id="quote-target-text"></div>
                        </div>

                        <div class="flex justify-between items-center pt-2 border-t border-[var(--border)]">
                            <button onclick="togglePollCreator()" class="text-[var(--accent)] hover:bg-blue-50 p-2 rounded-full transition"><span class="material-icons-round">poll</span></button>
                            <button id="post-btn" class="btn-main">ポストする</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="timeline"></div>
        </div>

        <div id="tab-explore" class="hidden">
            <div class="p-3 border-b border-[var(--border)] font-bold text-lg px-4">探索 & ランキング</div>
            <div id="user-list" class="divide-y divide-[var(--border)]"></div>
        </div>

        <div id="tab-notif" class="hidden">
            <div class="p-3 border-b border-[var(--border)] font-bold text-lg px-4">通知</div>
            <div id="notif-list" class="divide-y divide-[var(--border)]">
                <div class="p-8 text-center text-[var(--subtext)] text-sm">通知はありません</div>
            </div>
        </div>

        <div id="tab-profile" class="hidden">
            <div class="h-32 bg-[var(--subtext)] w-full relative opacity-20"></div>
            <div class="px-4 relative mb-4">
                <img id="profile-big-icon" src="" class="w-20 h-20 rounded-full border-4 border-[var(--bg)] absolute -top-10 bg-white object-cover">
                <div class="flex justify-end pt-3 gap-2">
                    <button onclick="toggleDarkMode()" class="btn-outline"><span class="material-icons-round text-sm">dark_mode</span></button>
                    <button onclick="openProfileEditor()" class="btn-outline">編集</button>
                    <button onclick="signOutApp()" class="btn-outline text-red-500 border-red-200">ログアウト</button>
                </div>
                <div class="mt-3">
                    <h2 id="profile-name" class="text-xl font-black leading-tight"></h2>
                    <p id="profile-uid" class="text-sm text-[var(--subtext)]">@user_id</p>
                    <div class="flex gap-4 mt-2 text-sm">
                        <span class="font-bold" id="profile-xp">0 XP</span>
                        <span class="text-[var(--subtext)]" id="profile-rank">Unranked</span>
                    </div>
                </div>
            </div>
            
            <div id="pinned-post-container" class="hidden border-b border-[var(--border)] bg-[var(--border)]/10">
                <div class="px-4 py-1 text-xs font-bold text-[var(--subtext)] flex items-center gap-1"><span class="material-icons-round text-xs">push_pin</span> 固定されたポスト</div>
                <div id="pinned-post-content"></div>
            </div>

            <div class="flex border-b border-[var(--border)] mt-2">
                <div class="flex-1 text-center py-3 font-bold border-b-2 border-[var(--text)]">ポスト</div>
                <div class="flex-1 text-center py-3 font-bold text-[var(--subtext)]">いいね</div>
            </div>
            <div id="my-timeline" class="divide-y divide-[var(--border)]"></div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-xl bg-[var(--bg)]/95 border-t border-[var(--border)] flex justify-around py-3 z-40 pb-6 backdrop-blur">
            <button onclick="switchTab('home')" class="nav-item nav-active" data-target="home"><span class="material-icons-round text-3xl">home</span></button>
            <button onclick="switchTab('explore')" class="nav-item" data-target="explore"><span class="material-icons-round text-3xl">search</span></button>
            <button onclick="switchTab('notif')" class="nav-item" data-target="notif">
                <span class="material-icons-round text-3xl">notifications</span>
                <div id="nav-badge" class="nav-badge"></div>
            </button>
            <button onclick="switchTab('profile')" class="nav-item" data-target="profile"><span class="material-icons-round text-3xl">person</span></button>
        </nav>
    </div>

    <div id="profile-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-[var(--card)] p-6 rounded-2xl w-80 shadow-2xl border border-[var(--border)]">
            <h2 class="text-xl font-bold mb-4">アカウント設定</h2>
            <input id="edit-name-input" type="text" class="w-full bg-[var(--bg)] border border-[var(--border)] rounded p-3 mb-4 font-bold outline-none text-[var(--text)]" placeholder="名前">
            <button id="save-profile-btn" class="w-full btn-main py-3">保存</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, arrayUnion, arrayRemove, deleteDoc, increment, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs",
            authDomain: "lo-g-8a620.firebaseapp.com",
            projectId: "lo-g-8a620",
            storageBucket: "lo-g-8a620.firebasestorage.app",
            messagingSenderId: "780857099698",
            appId: "1:780857099698:web:b6cb359114da98ab3e50ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null, myProfile = null;
        let quoteData = null; 
        let isPollMode = false;

        const authErr = (e) => alert(e.message);
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(authErr);
        document.getElementById('email-login-btn').onclick = () => document.getElementById('email-form').classList.remove('hidden');
        window.emailAuth = (type) => {
            const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value;
            if(type==='login') signInWithEmailAndPassword(auth,e,p).catch(authErr);
            else createUserWithEmailAndPassword(auth,e,p).catch(authErr);
        };
        window.signOutApp = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) { 
                    myProfile = userDoc.data(); 
                    await checkStreak(); // ★連続ログイン
                    initApp(); 
                } else { 
                    document.getElementById('login-screen').classList.add('hidden'); 
                    document.getElementById('profile-modal').classList.remove('hidden'); 
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // ★ Streak & Dark Mode
        async function checkStreak() {
            const now = new Date();
            const last = myProfile.lastLogin ? myProfile.lastLogin.toDate() : new Date(0);
            const diffDays = Math.floor((now - last) / (1000 * 60 * 60 * 24));
            
            let streak = myProfile.streak || 0;
            if (diffDays === 1) streak++; // 連続
            else if (diffDays > 1) streak = 1; // 途切れ
            // 0日(同日)ならそのまま

            if (diffDays >= 1 || !myProfile.lastLogin) {
                await updateDoc(doc(db, "users", currentUser.uid), { lastLogin: serverTimestamp(), streak: streak });
                myProfile.streak = streak;
            }
        }

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            
            // テーマ適用
            if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

            updateProfileUI();
            loadTimeline();
            loadNotifications();
            loadUserList();
        }

        function updateProfileUI() {
            const icon = myProfile.icon || `https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`;
            document.getElementById('header-icon').src = icon;
            document.getElementById('input-icon').src = icon;
            document.getElementById('profile-big-icon').src = icon;
            document.getElementById('profile-name').innerText = myProfile.name;
            document.getElementById('profile-uid').innerText = "@" + currentUser.uid.slice(0,8);
            document.getElementById('streak-count').innerText = myProfile.streak || 0;
            document.getElementById('profile-xp').innerText = (myProfile.xp || 0) + " XP";
            
            // ランク計算
            let rank = "Unranked";
            const xp = myProfile.xp || 0;
            if(xp >= 50) rank = "Bronze";
            if(xp >= 500) rank = "Gold";
            if(xp >= 1000) rank = "Diamond";
            document.getElementById('profile-rank').innerText = rank;

            // ★固定ポスト表示
            if (myProfile.pinnedPostId) loadPinnedPost(myProfile.pinnedPostId);
        }

        async function loadPinnedPost(id) {
            const d = await getDoc(doc(db, "logs", id));
            if(d.exists()) {
                document.getElementById('pinned-post-container').classList.remove('hidden');
                const div = document.createElement('div');
                // 簡易レンダリング
                div.innerHTML = createPostHTML(d.id, d.data(), true); 
                document.getElementById('pinned-post-content').innerHTML = "";
                document.getElementById('pinned-post-content').appendChild(div);
            }
        }

        // --- タイムライン & 投稿 ---
        window.togglePollCreator = () => {
            isPollMode = !isPollMode;
            const el = document.getElementById('poll-creator');
            isPollMode ? el.classList.remove('hidden') : el.classList.add('hidden');
        };

        document.getElementById('post-btn').onclick = async () => {
            const text = document.getElementById('post-text').value; 
            if(!text.trim() && !isPollMode) return;
            const exp = new Date(); exp.setDate(exp.getDate() + 90);
            
            const data = { 
                text, uid: currentUser.uid, authorName: myProfile.name, authorIcon: myProfile.icon, 
                createdAt: serverTimestamp(), expireAt: exp, likes: [] 
            };

            // ★投票データ
            if(isPollMode) {
                const o1 = document.getElementById('poll-opt-1').value;
                const o2 = document.getElementById('poll-opt-2').value;
                if(o1 && o2) {
                    data.poll = {
                        options: [ {id:0, text:o1, votes:[]}, {id:1, text:o2, votes:[]} ],
                        total: 0
                    };
                }
            }
            // 引用
            if(quoteData) data.quote = quoteData;

            await addDoc(collection(db, "logs"), data);
            await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(15) }); // XP
            
            document.getElementById('post-text').value = "";
            window.cancelQuote();
            if(isPollMode) window.togglePollCreator();
            document.getElementById('poll-opt-1').value = ""; document.getElementById('poll-opt-2').value = "";
        };

        function loadTimeline() {
            onSnapshot(query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50)), (snap) => {
                const c = document.getElementById('timeline'); c.innerHTML = "";
                snap.docs.forEach(doc => {
                    const div = document.createElement('div');
                    div.innerHTML = createPostHTML(doc.id, doc.data());
                    c.appendChild(div);
                });
            });
            // Profile Timeline
            onSnapshot(query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(20)), (snap) => {
                const c = document.getElementById('my-timeline'); c.innerHTML = "";
                snap.docs.forEach(doc => {
                    if(doc.data().uid === currentUser.uid) {
                        const div = document.createElement('div');
                        div.innerHTML = createPostHTML(doc.id, doc.data());
                        c.appendChild(div);
                    }
                });
            });
        }

        // ★ HTML生成 (複雑なので関数化)
        function createPostHTML(id, d, isPinned=false) {
            const isMine = d.uid === currentUser.uid;
            const isLiked = d.likes && d.likes.includes(currentUser.uid);
            
            // 投票UI
            let pollHTML = "";
            if(d.poll) {
                const total = d.poll.total || 0;
                pollHTML = `<div class="mt-2 space-y-2">`;
                d.poll.options.forEach((opt, idx) => {
                    const percent = total > 0 ? Math.round((opt.votes.length / total) * 100) : 0;
                    const hasVoted = opt.votes.includes(currentUser.uid);
                    pollHTML += `
                        <div onclick="votePoll('${id}', ${idx})" class="relative border border-[var(--border)] rounded p-2 cursor-pointer hover:bg-[var(--border)]/20 overflow-hidden">
                            <div class="poll-bar" style="width: ${percent}%"></div>
                            <div class="relative flex justify-between text-sm font-bold z-10">
                                <span>${opt.text} ${hasVoted?'<span class="material-icons-round text-xs">check</span>':''}</span>
                                <span>${percent}%</span>
                            </div>
                        </div>`;
                });
                pollHTML += `<div class="text-xs text-[var(--subtext)] text-right">${total} votes</div></div>`;
            }

            return `
                <div class="p-4 border-b border-[var(--border)] flex gap-3 hover:bg-[var(--border)]/10 transition">
                    <img src="${d.authorIcon}" class="w-10 h-10 rounded-full object-cover flex-shrink-0">
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-baseline">
                            <div class="flex items-center gap-1 overflow-hidden">
                                <span class="font-bold text-[15px] truncate">${d.authorName}</span>
                                <span class="text-[var(--subtext)] text-sm truncate">@${d.uid.slice(0,8)}</span>
                                <span class="text-[var(--subtext)] text-sm">· ${timeAgo(d.createdAt?d.createdAt.toDate():new Date())}</span>
                            </div>
                            <div class="relative group">
                                ${isMine && !isPinned ? `<button onclick="showMenu('${id}')" class="text-[var(--subtext)]">•••</button>` : ''}
                                <div id="menu-${id}" class="hidden absolute right-0 bg-[var(--card)] border border-[var(--border)] shadow-lg rounded-lg z-20 w-32 py-1">
                                    <button onclick="pinPost('${id}')" class="w-full text-left px-4 py-2 text-sm hover:bg-[var(--border)]">固定する</button>
                                    <button onclick="deletePost('${id}')" class="w-full text-left px-4 py-2 text-sm text-red-500 hover:bg-[var(--border)]">削除</button>
                                </div>
                            </div>
                        </div>
                        <p class="text-[15px] leading-relaxed mt-0.5 whitespace-pre-wrap">${d.text}</p>
                        ${pollHTML}
                        ${d.quote ? `<div class="quote-box"><div class="font-bold text-sm mb-1">${d.quote.name}</div><div class="truncate text-[var(--subtext)]">${d.quote.text}</div></div>` : ''}

                        <div class="flex justify-between mt-3 max-w-xs text-[var(--subtext)]">
                            <button onclick="window.setQuote('${d.text}', '${d.authorName}')" class="flex items-center gap-2 hover:text-green-500"><span class="material-icons-round text-[18px]">cached</span></button>
                            <button onclick="toggleLike('${id}', '${d.uid}')" class="flex items-center gap-2 ${isLiked ? 'like-active' : 'hover:text-pink-500'}"><span class="material-icons-round text-[18px] ${isLiked ? 'like-anim' : ''}">${isLiked ? 'favorite' : 'favorite_border'}</span> <span class="text-xs">${d.likes?d.likes.length:''}</span></button>
                        </div>
                    </div>
                </div>`;
        }

        // ★ 投票ロジック
        window.votePoll = async (id, optIdx) => {
            const ref = doc(db, "logs", id);
            const d = (await getDoc(ref)).data();
            const uid = currentUser.uid;
            
            // 既に投票済みかチェック
            let alreadyVoted = false;
            d.poll.options.forEach(o => { if(o.votes.includes(uid)) alreadyVoted = true; });
            if(alreadyVoted) return alert("投票済みです");

            d.poll.options[optIdx].votes.push(uid);
            d.poll.total++;
            await updateDoc(ref, { poll: d.poll });
        };

        // ★ 通知システム
        function loadNotifications() {
            onSnapshot(query(collection(db, "notifications"), where("targetUid", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20)), (snap) => {
                const list = document.getElementById('notif-list');
                const badge = document.getElementById('nav-badge');
                if(snap.empty) {
                    list.innerHTML = `<div class="p-8 text-center text-[var(--subtext)]">通知はありません</div>`;
                    badge.style.display = 'none';
                } else {
                    list.innerHTML = "";
                    let hasUnread = false;
                    snap.forEach(doc => {
                        const d = doc.data();
                        if(!d.read) hasUnread = true;
                        list.innerHTML += `
                            <div class="p-4 border-b border-[var(--border)] flex gap-3 ${!d.read ? 'bg-blue-50/10' : ''}">
                                <span class="material-icons-round text-xl ${d.type==='like'?'text-pink-500':'text-blue-500'}">${d.type==='like'?'favorite':'reply'}</span>
                                <div class="text-sm">
                                    <span class="font-bold">${d.fromName}</span>さんが${d.type==='like'?'いいねしました':'反応しました'}
                                    <div class="text-[var(--subtext)] text-xs mt-1">${timeAgo(d.createdAt.toDate())}</div>
                                </div>
                            </div>`;
                        // 既読にする
                        updateDoc(doc(db, "notifications", doc.id), { read: true });
                    });
                    if(hasUnread) badge.style.display = 'block';
                }
            });
        }

        async function sendNotif(target, type) {
            if(target === currentUser.uid) return;
            await addDoc(collection(db, "notifications"), {
                targetUid: target, type: type, fromName: myProfile.name, read: false, createdAt: serverTimestamp()
            });
        }

        window.toggleLike = async (id, authorUid) => {
            const ref = doc(db, "logs", id);
            const d = (await getDoc(ref)).data();
            if(d.likes && d.likes.includes(currentUser.uid)) {
                await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
                await addXP(2);
                sendNotif(authorUid, 'like'); // ★通知送信
            }
        };

        // ★ その他機能
        window.toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        };
        window.showMenu = (id) => { document.getElementById(`menu-${id}`).classList.remove('hidden'); setTimeout(()=>document.getElementById(`menu-${id}`).classList.add('hidden'), 3000); };
        window.pinPost = async (id) => {
            await updateDoc(doc(db, "users", currentUser.uid), { pinnedPostId: id });
            alert("プロフィールに固定しました");
            location.reload();
        };

        // (Common)
        window.setQuote = (t,n) => { quoteData = {text:t, name:n}; document.getElementById('quote-preview').classList.remove('hidden'); document.getElementById('quote-target-name').innerText = n; document.getElementById('quote-target-text').innerText = t; };
        window.cancelQuote = () => { quoteData = null; document.getElementById('quote-preview').classList.add('hidden'); };
        window.deletePost = async (id) => { if(confirm("削除？")) await deleteDoc(doc(db, "logs", id)); };
        function timeAgo(d){ const s=Math.floor((new Date()-d)/1000); if(s<60)return"1m"; const m=Math.floor(s/60); if(m<60)return m+"m"; return Math.floor(m/60)+"h"; }
        async function loadUserList() {
            const list = document.getElementById('user-list');
            onSnapshot(query(collection(db,"users"),orderBy("xp","desc"),limit(50)), (s)=>{
                list.innerHTML=""; s.forEach(d=>{ if(d.id!==currentUser.uid) list.innerHTML+=`<div class="p-4 flex gap-3 items-center"><img src="${d.data().icon}" class="w-10 h-10 rounded-full"><div class="flex-1"><div class="font-bold text-sm">${d.data().name}</div><div class="text-xs text-[var(--subtext)]">${d.data().xp} XP</div></div></div>`});
            });
        }
        document.getElementById('save-profile-btn').onclick = async () => { const n = document.getElementById('edit-name-input').value; if(!n) return; await setDoc(doc(db, "users", currentUser.uid), { name: n, icon: `https://api.dicebear.com/7.x/notionists/svg?seed=${currentUser.uid}`, xp:0, streak:0 }, { merge: true }); location.reload(); };
        window.openProfileEditor = () => document.getElementById('profile-modal').classList.remove('hidden');
        window.switchTab = (t) => { ['home','explore','notif','profile'].forEach(x => document.getElementById(`tab-${x}`).classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('nav-active')); const b = document.querySelector(`.nav-item[data-target="${t}"]`); if(b) b.classList.add('nav-active'); if(t==='notif') document.getElementById('nav-badge').style.display='none'; };
    </script>
</body>
</html>
