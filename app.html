<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>LoG B2 | シンプルSNS</title>
    <meta name="description" content="LoG B2は、90日で消えるログと、心地よい繋がりを提供するテキストSNSです。">
    <meta name="google-site-verification" content="Z2rHXTn9RZClgr4XgNlPX0di9h8peZXKxsakNEp9v-E" />

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1539164935971262" crossorigin="anonymous"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body { 
            background-color: #f3f4f6; /* 薄いグレー背景 */
            color: #1f2937; /* 濃いグレー文字 */
            font-family: 'Noto Sans JP', sans-serif;
            overflow-x: hidden;
        }
        .hidden { display: none; }
        
        /* 白いカードデザイン */
        .card { background: white; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        /* ボタン */
        .btn-primary { 
            background-color: #3b82f6; /* 青 */
            color: white; 
            font-weight: bold; 
            border-radius: 9999px; 
            padding: 8px 20px; 
            transition: 0.2s; 
        }
        .btn-primary:hover { background-color: #2563eb; }
        
        /* いいねアニメーション */
        .like-anim { animation: heartPop 0.3s ease-out; }
        @keyframes heartPop { 0%{transform:scale(1);} 50%{transform:scale(1.3);} 100%{transform:scale(1);} }

        /* スクロールバー非表示（スッキリさせる） */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .modal-overlay { background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body>

    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <div class="text-center mb-10">
            <h1 class="text-6xl font-bold text-blue-600 mb-2 tracking-tighter">LoG</h1>
            <span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded-full">B2 Version</span>
            <p class="text-gray-400 text-sm mt-2">Simple Text Communication</p>
        </div>

        <div class="w-full max-w-xs space-y-4">
            <button id="google-login-btn" class="w-full border border-gray-300 bg-white py-3 rounded-full hover:bg-gray-50 transition flex justify-center items-center gap-2 shadow-sm font-bold text-gray-600">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> 
                Googleで始める
            </button>
            
            <div class="relative flex py-2 items-center">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink mx-4 text-gray-400 text-xs">または Email</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <input id="auth-email" type="email" placeholder="メールアドレス" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <input id="auth-password" type="password" placeholder="パスワード (6文字以上)" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-blue-500">
            
            <div class="flex gap-2">
                <button id="email-login-btn" class="flex-1 bg-gray-800 text-white py-3 rounded-lg font-bold hover:bg-gray-700">ログイン</button>
                <button id="email-signup-btn" class="flex-1 border border-gray-300 text-gray-600 py-3 rounded-lg font-bold hover:bg-gray-50">新規登録</button>
            </div>
        </div>
        
        <p class="mt-8 text-xs text-gray-400 underline cursor-pointer" onclick="openTerms()">利用規約とプライバシーポリシー</p>
    </div>

    <div id="app-screen" class="hidden max-w-xl mx-auto min-h-screen bg-white shadow-xl relative pb-20">
        
        <header class="sticky top-0 bg-white/90 backdrop-blur z-20 border-b border-gray-100 p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-600 tracking-tighter cursor-pointer" onclick="switchTab('home')">LoG</h1>
            <div class="flex gap-4">
                <button onclick="switchTab('users')" class="text-gray-400 hover:text-blue-500"><span class="material-icons-round">question_answer</span></button>
                <img id="header-icon" src="" class="w-8 h-8 rounded-full border border-gray-200 cursor-pointer object-cover" onclick="switchTab('profile')">
            </div>
        </header>

        <div id="tab-home" class="pb-24">
            <div class="p-4 border-b border-gray-100 flex gap-3">
                <img id="input-icon" src="" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
                <div class="flex-1">
                    <textarea id="post-text" rows="2" placeholder="今、何してる？" class="w-full text-base resize-none mb-2 focus:outline-none text-gray-700 placeholder-gray-400"></textarea>
                    <div id="reply-indicator" class="hidden text-xs text-blue-500 mb-2 bg-blue-50 p-1 rounded px-2 inline-block">
                        返信先: <span id="reply-target-name"></span> <button onclick="cancelReply()" class="ml-2 text-gray-400">✕</button>
                    </div>
                    <div class="flex justify-end">
                        <button id="post-btn" class="btn-primary shadow-lg shadow-blue-200">ポスト</button>
                    </div>
                </div>
            </div>
            <div id="timeline" class="divide-y divide-gray-50"></div>
        </div>

        <div id="tab-users" class="hidden p-4">
            <h2 class="text-xl font-bold mb-4 px-2">メッセージを送る</h2>
            <div id="user-list" class="space-y-2"></div>
        </div>

        <div id="tab-chat" class="hidden h-[calc(100vh-130px)] flex flex-col">
            <div class="p-3 border-b flex items-center gap-2 bg-gray-50 sticky top-0">
                <button onclick="switchTab('users')" class="text-gray-500"><span class="material-icons-round">arrow_back</span></button>
                <span id="chat-target-name" class="font-bold"></span>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-white"></div>
            <div class="p-3 border-t bg-white flex gap-2">
                <input id="chat-input" type="text" class="flex-1 bg-gray-100 rounded-full px-4 py-2 focus:outline-none" placeholder="メッセージ...">
                <button id="chat-send-btn" class="text-blue-500 p-2"><span class="material-icons-round">send</span></button>
            </div>
        </div>

        <div id="tab-profile" class="hidden">
            <div class="p-6 bg-blue-50">
                <div class="flex justify-between items-start mb-4">
                    <img id="profile-big-icon" src="" class="w-20 h-20 rounded-full border-4 border-white shadow-md object-cover">
                    <button onclick="openProfileEditor()" class="text-xs border border-gray-300 px-3 py-1 rounded-full bg-white text-gray-600 hover:bg-gray-50">プロフィール編集</button>
                </div>
                <h2 id="profile-name" class="text-xl font-bold text-gray-800"></h2>
                <p id="profile-uid" class="text-gray-400 text-xs font-mono mt-1"></p>
                <button onclick="signOutApp()" class="mt-4 text-xs text-red-400 hover:text-red-600">ログアウト</button>
            </div>
            <div class="p-4 font-bold text-gray-400 text-sm border-b">自分の投稿</div>
            <div id="my-timeline" class="divide-y divide-gray-50"></div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-xl bg-white border-t border-gray-100 flex justify-around p-3 text-gray-400 pb-5 z-30">
            <button onclick="switchTab('home')" class="hover:text-blue-500 nav-btn" data-target="home"><span class="material-icons-round text-2xl">home</span></button>
            <button onclick="switchTab('users')" class="hover:text-blue-500 nav-btn" data-target="users"><span class="material-icons-round text-2xl">mail</span></button>
            <button onclick="switchTab('profile')" class="hover:text-blue-500 nav-btn" data-target="profile"><span class="material-icons-round text-2xl">person</span></button>
        </nav>
    </div>

    <div id="profile-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl w-80 shadow-2xl text-center">
            <h2 class="text-lg font-bold mb-4 text-gray-800">プロフィール設定</h2>
            <img id="edit-preview-icon" src="" class="w-24 h-24 rounded-full bg-gray-100 mb-4 mx-auto object-cover">
            <button id="random-icon-btn" class="text-xs bg-gray-100 px-3 py-1 rounded-full mb-4 hover:bg-gray-200">アイコンをランダム生成</button>
            <input type="hidden" id="edit-icon-url">
            <input id="edit-name-input" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg p-3 mb-4 text-center" placeholder="名前を入力">
            <button id="save-profile-btn" class="w-full btn-primary py-3">保存する</button>
        </div>
    </div>

    <div id="terms-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-2xl max-w-sm w-full m-4 shadow-2xl max-h-[80vh] flex flex-col">
            <h2 class="text-lg font-bold mb-4 text-gray-800">利用規約 (B2)</h2>
            <div class="overflow-y-auto flex-1 text-sm text-gray-600 space-y-4 mb-4">
                <p><strong>1. 免責事項</strong><br>本サービス利用によるトラブルについて運営者は責任を負いません。投稿は90日後に自動削除されます。</p>
                <p><strong>2. 禁止事項</strong><br>誹謗中傷、荒らし行為は即時アカウント停止となります。</p>
                <p><strong>3. プライバシー</strong><br>Google AdSenseを使用し、Cookieを利用して広告を配信します。</p>
            </div>
            <button onclick="document.getElementById('terms-modal').classList.add('hidden')" class="w-full border border-gray-300 py-2 rounded-lg font-bold text-gray-600 hover:bg-gray-50">閉じる</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, where, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs",
            authDomain: "lo-g-8a620.firebaseapp.com",
            projectId: "lo-g-8a620",
            storageBucket: "lo-g-8a620.firebasestorage.app",
            messagingSenderId: "780857099698",
            appId: "1:780857099698:web:b6cb359114da98ab3e50ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null, myProfile = null;
        let replyToId = null, replyToName = null;
        let currentChatUser = null;

        // --- 認証 ---
        const handleAuthError = (e) => alert("エラー: " + e.message);
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(handleAuthError);
        document.getElementById('email-login-btn').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(handleAuthError);
        document.getElementById('email-signup-btn').onclick = () => {
            const p = document.getElementById('auth-password').value;
            if(p.length < 6) return alert("パスワードは6文字以上にしてください");
            createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, p).catch(handleAuthError);
        };
        window.signOutApp = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists()) { myProfile = userDoc.data(); initApp(); } 
                else { document.getElementById('login-screen').classList.add('hidden'); openProfileEditor(); }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            document.getElementById('header-icon').src = myProfile.icon;
            document.getElementById('input-icon').src = myProfile.icon;
            document.getElementById('profile-big-icon').src = myProfile.icon;
            document.getElementById('profile-name').innerText = myProfile.name;
            document.getElementById('profile-uid').innerText = "@" + currentUser.uid.slice(0,8);
            loadTimeline();
            loadUserList();
        }

        // --- 投稿 & リプライ ---
        document.getElementById('post-btn').onclick = async () => {
            const text = document.getElementById('post-text').value;
            if (!text.trim() || !myProfile) return;
            const exp = new Date(); exp.setDate(exp.getDate() + 90);
            
            const postData = {
                text, uid: currentUser.uid, authorName: myProfile.name, authorIcon: myProfile.icon,
                createdAt: serverTimestamp(), expireAt: exp, likes: []
            };
            if(replyToId) {
                postData.replyToId = replyToId;
                postData.replyToName = replyToName;
            }

            await addDoc(collection(db, "logs"), postData);
            document.getElementById('post-text').value = "";
            cancelReply();
        };

        window.setReply = (id, name) => {
            replyToId = id; replyToName = name;
            document.getElementById('reply-indicator').classList.remove('hidden');
            document.getElementById('reply-target-name').innerText = name;
            document.getElementById('post-text').focus();
        };
        window.cancelReply = () => {
            replyToId = null; replyToName = null;
            document.getElementById('reply-indicator').classList.add('hidden');
        };

        // --- いいね機能 ---
        window.toggleLike = async (id, likes) => {
            const ref = doc(db, "logs", id);
            if(likes && likes.includes(currentUser.uid)) {
                await updateDoc(ref, { likes: arrayRemove(currentUser.uid) });
            } else {
                await updateDoc(ref, { likes: arrayUnion(currentUser.uid) });
            }
        };

        // --- タイムライン表示 ---
        function loadTimeline() {
            const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50));
            onSnapshot(q, (snap) => {
                const container = document.getElementById('timeline');
                container.innerHTML = "";
                snap.docs.forEach((doc, i) => {
                    if (i > 0 && i % 5 === 0) injectAd(container);
                    container.appendChild(createPostEl(doc.id, doc.data()));
                });
            });
            // 自分の投稿
            const myQ = query(collection(db, "logs"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(myQ, (snap) => {
                const c = document.getElementById('my-timeline'); c.innerHTML = "";
                snap.docs.forEach(doc => c.appendChild(createPostEl(doc.id, doc.data())));
            });
        }

        function createPostEl(id, d) {
            const isLiked = d.likes && d.likes.includes(currentUser.uid);
            const div = document.createElement('div');
            div.className = "p-4 flex gap-3 hover:bg-gray-50 transition";
            div.innerHTML = `
                <img src="${d.authorIcon}" class="w-10 h-10 rounded-full bg-gray-200 border border-gray-100 object-cover">
                <div class="flex-1 min-w-0">
                    <div class="flex items-baseline justify-between">
                        <span class="font-bold text-sm text-gray-900 truncate">${d.authorName}</span>
                        <span class="text-xs text-gray-400 ml-2">${d.createdAt ? timeAgo(d.createdAt.toDate()) : '...'}</span>
                    </div>
                    ${d.replyToName ? `<div class="text-xs text-blue-500 mb-1">返信先: ${d.replyToName}</div>` : ''}
                    <p class="text-gray-800 text-sm whitespace-pre-wrap leading-relaxed break-words">${d.text}</p>
                    
                    <div class="flex gap-6 mt-3">
                        <button onclick="toggleLike('${id}', ${JSON.stringify(d.likes || [])})" class="flex items-center gap-1 text-xs ${isLiked ? 'text-pink-500' : 'text-gray-400 hover:text-pink-500'} transition">
                            <span class="material-icons-round text-sm ${isLiked ? 'like-anim' : ''}">${isLiked ? 'favorite' : 'favorite_border'}</span>
                            <span>${d.likes ? d.likes.length : 0}</span>
                        </button>
                        <button onclick="setReply('${id}', '${d.authorName}')" class="flex items-center gap-1 text-xs text-gray-400 hover:text-blue-500 transition">
                            <span class="material-icons-round text-sm">chat_bubble_outline</span>
                            <span>返信</span>
                        </button>
                    </div>
                </div>`;
            return div;
        }

        // --- DM (チャット) 機能 ---
        async function loadUserList() {
            // ※注意: 本来は全ユーザー取得は重いが、β版のため制限付きで取得
            const q = query(collection(db, "users"), limit(20)); 
            const snap = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js").then(m => m.getDocs(q));
            const list = document.getElementById('user-list');
            list.innerHTML = "";
            snap.forEach(doc => {
                if(doc.id === currentUser.uid) return;
                const d = doc.data();
                const div = document.createElement('div');
                div.className = "p-3 bg-white rounded-lg shadow-sm flex items-center gap-3 cursor-pointer hover:bg-blue-50 transition";
                div.onclick = () => openChat(doc.id, d.name);
                div.innerHTML = `<img src="${d.icon}" class="w-10 h-10 rounded-full object-cover"><span class="font-bold text-gray-700">${d.name}</span>`;
                list.appendChild(div);
            });
        }

        window.openChat = (uid, name) => {
            currentChatUser = uid;
            document.getElementById('chat-target-name').innerText = name;
            switchTab('chat');
            loadMessages(uid);
        };

        function loadMessages(targetUid) {
            // チャットIDは2人のUIDをソートして結合 (例: uidA_uidB)
            const chatId = [currentUser.uid, targetUid].sort().join("_");
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("createdAt", "asc"), limit(50));
            onSnapshot(q, (snap) => {
                const div = document.getElementById('chat-messages');
                div.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    const isMe = d.senderId === currentUser.uid;
                    const bubble = document.createElement('div');
                    bubble.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
                    bubble.innerHTML = `<div class="max-w-[70%] p-3 rounded-2xl text-sm ${isMe ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}">${d.text}</div>`;
                    div.appendChild(bubble);
                });
                div.scrollTop = div.scrollHeight;
            });
        }

        document.getElementById('chat-send-btn').onclick = async () => {
            const text = document.getElementById('chat-input').value;
            if(!text.trim() || !currentChatUser) return;
            const chatId = [currentUser.uid, currentChatUser].sort().join("_");
            await addDoc(collection(db, "chats", chatId, "messages"), {
                text, senderId: currentUser.uid, createdAt: serverTimestamp()
            });
            document.getElementById('chat-input').value = "";
        };

        // --- その他ツール ---
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return "今";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + "分前";
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + "時間前";
            return Math.floor(hours / 24) + "日前";
        }

        function injectAd(container) {
            const ad = document.createElement('div');
            ad.className = "p-4 bg-gray-50 border-y border-gray-100 text-center";
            ad.innerHTML = `<span class="text-[10px] text-gray-400 block mb-2">SPONSORED</span><ins class="adsbygoogle" style="display:block" data-ad-format="fluid" data-ad-layout-key="-fb+5w+4e-db+86" data-ad-client="ca-pub-1539164935971262" data-ad-slot="YOUR_AD_SLOT_ID"></ins>`;
            container.appendChild(ad);
            (window.adsbygoogle = window.adsbygoogle || []).push({});
        }

        window.openProfileEditor = () => {
            document.getElementById('profile-modal').classList.remove('hidden');
            if(myProfile) { document.getElementById('edit-name-input').value = myProfile.name; document.getElementById('edit-icon-url').value = myProfile.icon; document.getElementById('edit-preview-icon').src = myProfile.icon; }
            else generateRandomIcon();
        };

        function generateRandomIcon() {
            const url = `https://api.dicebear.com/7.x/notionists/svg?seed=${Math.random().toString(36).substring(7)}`; // アイコンスタイルも変更
            document.getElementById('edit-icon-url').value = url;
            document.getElementById('edit-preview-icon').src = url;
        }
        document.getElementById('random-icon-btn').onclick = generateRandomIcon;

        document.getElementById('save-profile-btn').onclick = async () => {
            const name = document.getElementById('edit-name-input').value, icon = document.getElementById('edit-icon-url').value;
            if(!name) return alert("名前を入力してください");
            await setDoc(doc(db, "users", currentUser.uid), { name, icon, updatedAt: serverTimestamp() }, { merge: true });
            myProfile = { name, icon }; initApp();
        };

        window.switchTab = (t) => {
            ['home', 'users', 'chat', 'profile'].forEach(x => document.getElementById(`tab-${x}`).classList.add('hidden'));
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            // ナビゲーションのアイコン色変更
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('text-blue-500'));
            const activeBtn = document.querySelector(`.nav-btn[data-target="${t}"]`);
            if(activeBtn) activeBtn.classList.add('text-blue-500');
        };
        window.openTerms = () => document.getElementById('terms-modal').classList.remove('hidden');
    </script>
</body>
</html>
