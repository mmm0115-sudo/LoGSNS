<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LoG B5 | Repair Mode</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1539164935971262" crossorigin="anonymous"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        :root { --accent: #2563eb; }
        body { background-color: #f8fafc; color: #334155; font-family: 'Noto Sans JP', sans-serif; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .hidden { display: none; }
        .btn-primary { background-color: var(--accent); color: white; font-weight: bold; border-radius: 99px; padding: 8px 20px; transition: 0.2s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.2); }
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        /* ランク色 */
        .rank-bronze { color: #cd7f32; } .rank-silver { color: #94a3b8; } .rank-gold { color: #eab308; text-shadow: 0 0 5px rgba(234,179,8,0.4); }
    </style>
</head>
<body>

    <div id="login-screen" class="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
        <h1 class="text-7xl font-black text-blue-600 mb-2">LoG</h1>
        <span class="bg-red-500 text-white text-xs font-bold px-3 py-1 rounded-full">REPAIR MODE</span>
        <div class="mt-10 w-full max-w-xs space-y-4">
            <button id="google-login-btn" class="w-full border py-3 rounded-xl font-bold text-gray-600 flex justify-center gap-2"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5"> Google Login</button>
            <div class="flex gap-2">
                <input id="auth-email" type="email" placeholder="Email" class="flex-1 bg-gray-50 border-none rounded-xl p-3">
                <input id="auth-password" type="password" placeholder="Pass" class="flex-1 bg-gray-50 border-none rounded-xl p-3">
            </div>
            <div class="flex gap-2">
                <button id="email-login-btn" class="flex-1 bg-gray-900 text-white py-3 rounded-xl font-bold">Login</button>
                <button id="email-signup-btn" class="flex-1 border py-3 rounded-xl font-bold">Sign Up</button>
            </div>
        </div>
    </div>

    <div id="app-screen" class="hidden max-w-xl mx-auto min-h-screen bg-white shadow-2xl pb-24">
        <header class="sticky top-0 bg-white/90 backdrop-blur-md z-30 border-b border-gray-100 p-4 flex justify-between items-center">
            <h1 class="text-2xl font-black text-blue-600" onclick="switchTab('home')">LoG</h1>
            <div class="flex gap-4 items-center">
                <div class="flex flex-col items-end"><span id="league-name" class="text-[10px] font-bold uppercase text-slate-400">Loading...</span></div>
                <img id="header-icon" src="" class="w-9 h-9 rounded-full border border-gray-200 object-cover" onclick="switchTab('profile')">
            </div>
        </header>

        <div id="tab-home" class="pb-24">
            <div class="p-4 border-b border-gray-100 flex gap-3">
                <textarea id="post-text" rows="2" placeholder="今、何してる？" class="w-full text-base resize-none mb-2 focus:outline-none bg-transparent placeholder-gray-400"></textarea>
                <button id="post-btn" class="btn-primary h-10 self-end">Post</button>
            </div>
            <div id="timeline" class="divide-y divide-gray-100"></div>
        </div>

        <div id="tab-users" class="hidden p-4 space-y-3" id="user-list"></div>

        <div id="tab-chat" class="hidden h-[calc(100vh-140px)] flex flex-col">
            <div class="p-3 border-b flex items-center gap-2 sticky top-0 bg-white z-10">
                <button onclick="switchTab('users')"><span class="material-icons-round">arrow_back</span></button>
                <span id="chat-target-name" class="font-bold"></span>
            </div>
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-2"></div>
            <div class="p-3 border-t flex gap-2">
                <input id="chat-input" type="text" class="flex-1 bg-gray-100 rounded-full px-4 py-2 border-none outline-none" placeholder="Message...">
                <button id="chat-send-btn" class="text-blue-600 p-2"><span class="material-icons-round">send</span></button>
            </div>
        </div>

        <div id="tab-profile" class="hidden text-center p-8">
            <img id="profile-big-icon" src="" class="w-24 h-24 rounded-full border-4 border-white shadow-xl mx-auto mb-4">
            <h2 id="profile-name" class="text-2xl font-black mb-1"></h2>
            <p id="profile-uid" class="text-xs text-gray-400 mb-6"></p>
            <button onclick="signOutApp()" class="text-xs text-red-400 border border-red-200 px-5 py-2 rounded-full font-bold">Logout</button>
            <div class="mt-8 text-left font-bold text-gray-400 text-sm border-b pb-2">My Logs</div>
            <div id="my-timeline" class="divide-y divide-gray-100"></div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-xl bg-white/90 backdrop-blur-lg border-t border-gray-100 flex justify-around p-3 pb-6 z-40">
            <button onclick="switchTab('home')" class="material-icons-round text-3xl text-gray-400 hover:text-blue-500">home</button>
            <button onclick="switchTab('users')" class="material-icons-round text-3xl text-gray-400 hover:text-blue-500">emoji_events</button>
            <button onclick="switchTab('profile')" class="material-icons-round text-3xl text-gray-400 hover:text-blue-500">person</button>
        </nav>
    </div>

    <div id="profile-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-3xl w-80 shadow-2xl text-center">
            <h2 class="text-lg font-bold mb-4">Identity Setup</h2>
            <input id="edit-name-input" type="text" class="w-full bg-gray-50 border-none rounded-xl p-3 mb-4 text-center" placeholder="名前">
            <button id="save-profile-btn" class="w-full btn-primary py-3">Save</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, where, updateDoc, arrayUnion, arrayRemove, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs",
            authDomain: "lo-g-8a620.firebaseapp.com",
            projectId: "lo-g-8a620",
            storageBucket: "lo-g-8a620.firebasestorage.app",
            messagingSenderId: "780857099698",
            appId: "1:780857099698:web:b6cb359114da98ab3e50ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null, myProfile = null;
        let currentChatUser = null;

        // エラーハンドリング
        const authErr = (e) => alert("Error: " + e.message);
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(authErr);
        document.getElementById('email-login-btn').onclick = () => signInWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(authErr);
        document.getElementById('email-signup-btn').onclick = () => createUserWithEmailAndPassword(auth, document.getElementById('auth-email').value, document.getElementById('auth-password').value).catch(authErr);
        window.signOutApp = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) { myProfile = userDoc.data(); initApp(); } 
                    else { document.getElementById('login-screen').classList.add('hidden'); document.getElementById('profile-modal').classList.remove('hidden'); }
                } catch(e) {
                    console.error("User Load Error:", e);
                    // ここでエラーが出る場合は、Firestoreのセキュリティルールかインデックスの問題
                    alert("データの読み込みに失敗しました。F12コンソールを確認してください。");
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            
            updateProfileUI();
            loadTimeline();
            loadUserList();
        }

        function updateProfileUI() {
            // アイコンがない場合の対策
            const icon = myProfile.icon || "https://api.dicebear.com/7.x/notionists/svg?seed=guest";
            document.getElementById('header-icon').src = icon;
            document.getElementById('profile-big-icon').src = icon;
            document.getElementById('profile-name').innerText = myProfile.name || "No Name";
            document.getElementById('profile-uid').innerText = "@" + currentUser.uid.slice(0,8);
            
            // リーグ表示
            const xp = myProfile.xp || 0;
            let league = "Unranked";
            if(xp >= 50) league = "Bronze";
            if(xp >= 200) league = "Silver";
            if(xp >= 500) league = "Gold";
            document.getElementById('league-name').innerText = league;
        }

        document.getElementById('save-profile-btn').onclick = async () => {
            const name = document.getElementById('edit-name-input').value;
            const icon = `https://api.dicebear.com/7.x/notionists/svg?seed=${Math.random()}`;
            if(!name) return;
            await setDoc(doc(db, "users", currentUser.uid), { name, icon, xp: 0, updatedAt: serverTimestamp() }, { merge: true });
            myProfile = { name, icon, xp: 0 };
            initApp();
        };

        // --- ★ 頑丈なタイムライン読み込み ---
        function loadTimeline() {
            // エラーが出にくいよう、orderByだけにする（whereを外す）
            const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50));
            
            onSnapshot(q, (snap) => {
                const container = document.getElementById('timeline');
                container.innerHTML = "";
                
                snap.docs.forEach((doc) => {
                    try {
                        // データが壊れていてもアプリを止めない「try-catch」ブロック
                        const d = doc.data();
                        
                        // 必須データのチェック
                        const name = d.authorName || "Unknown";
                        const text = d.text || "";
                        const icon = d.authorIcon || "https://api.dicebear.com/7.x/notionists/svg?seed=error";
                        
                        // 時間の処理（ここが一番エラーになりやすい）
                        let timeStr = "...";
                        if (d.createdAt && typeof d.createdAt.toDate === 'function') {
                            timeStr = timeAgo(d.createdAt.toDate());
                        }

                        const div = document.createElement('div');
                        div.className = "p-4 flex gap-3 border-b border-gray-100";
                        div.innerHTML = `
                            <img src="${icon}" class="w-10 h-10 rounded-full bg-gray-200 object-cover">
                            <div class="flex-1">
                                <div class="flex justify-between">
                                    <span class="font-bold text-sm text-gray-800">${name}</span>
                                    <span class="text-xs text-gray-400">${timeStr}</span>
                                </div>
                                <p class="text-sm mt-1 whitespace-pre-wrap">${text}</p>
                            </div>`;
                        container.appendChild(div);
                    } catch (err) {
                        console.warn("Skipped broken post:", doc.id, err);
                        // 壊れた投稿は無視して次へ進む
                    }
                });
            }, (error) => {
                // ここでエラーが出たら、インデックスがない証拠
                console.error("Snapshot Error:", error);
                if(error.message.includes("index")) {
                    alert("インデックスが必要です！PCでF12キーを押して、コンソールのリンクをクリックしてください！");
                }
            });
        }

        // --- 投稿 ---
        document.getElementById('post-btn').onclick = async () => {
            const text = document.getElementById('post-text').value; 
            if(!text.trim()) return;
            const exp = new Date(); exp.setDate(exp.getDate() + 90);
            
            await addDoc(collection(db, "logs"), {
                text, 
                uid: currentUser.uid, 
                authorName: myProfile.name || "No Name", 
                authorIcon: myProfile.icon || "",
                createdAt: serverTimestamp(), 
                expireAt: exp, 
                likes: []
            });
            
            // XP加算
            await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(15) });
            document.getElementById('post-text').value = "";
        };

        // --- その他の関数 ---
        async function loadUserList() {
            const list = document.getElementById('tab-users'); // id修正
            if(!list) return;
            const q = query(collection(db, "users"), limit(30), orderBy("xp", "desc"));
            onSnapshot(q, (snap) => {
                list.innerHTML = "";
                snap.forEach(doc => {
                    const d = doc.data();
                    list.innerHTML += `<div onclick="openChat('${doc.id}','${d.name}')" class="p-3 border rounded-xl flex items-center gap-3 cursor-pointer"><img src="${d.icon}" class="w-10 h-10 rounded-full"><div class="font-bold text-sm">${d.name} <span class="text-xs text-yellow-500">${d.xp||0} XP</span></div></div>`;
                });
            });
        }

        window.openChat = (u,n) => { currentChatUser = u; document.getElementById('chat-target-name').innerText = n; switchTab('chat'); loadMessages(u); };
        function loadMessages(t) {
            const c = [currentUser.uid, t].sort().join("_");
            onSnapshot(query(collection(db, "chats", c, "messages"), orderBy("createdAt", "asc"), limit(50)), (s) => {
                const d = document.getElementById('chat-messages'); d.innerHTML = "";
                s.forEach(o => {
                    const v = o.data();
                    const m = v.senderId === currentUser.uid;
                    d.innerHTML += `<div class="flex ${m?'justify-end':'justify-start'}"><div class="max-w-[75%] p-3 rounded-2xl text-sm ${m?'bg-blue-600 text-white':'bg-gray-100'}">${v.text}</div></div>`;
                });
                d.scrollTop = d.scrollHeight;
            });
        }
        document.getElementById('chat-send-btn').onclick = async () => {
            const t = document.getElementById('chat-input').value; if(!t.trim()) return;
            await addDoc(collection(db, "chats", [currentUser.uid, currentChatUser].sort().join("_"), "messages"), { text: t, senderId: currentUser.uid, createdAt: serverTimestamp() });
            document.getElementById('chat-input').value = "";
        };

        function timeAgo(d) { const s = Math.floor((new Date()-d)/1000); if(s<60)return"今"; const m=Math.floor(s/60); if(m<60)return m+"分前"; return Math.floor(m/60)+"時間前"; }
        window.switchTab = (t) => { ['home','users','chat','profile'].forEach(x => document.getElementById(`tab-${x}`).classList.add('hidden')); document.getElementById(`tab-${t}`).classList.remove('hidden'); };
    </script>
</body>
</html>
