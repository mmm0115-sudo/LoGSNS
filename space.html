<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LoG Space | The Metaverse</title>
    <meta property="og:title" content="LoG Space | The Metaverse">
    <meta property="og:description" content="テキストだけが残る空間。果てなき宇宙でログを刻め。">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">

    <!-- Google AdSense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1539164935971262"
        crossorigin="anonymous"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Noto+Sans+JP:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg: #030303;
            --text: #ffffff;
            --subtext: #a1a1aa;
            --border: #27272a;
            --card: #18181b;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: white;
            overflow: hidden;
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            touch-action: none;
            user-select: none;
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: bold;
            opacity: 0;
            transition: 0.3s;
            pointer-events: none;
            z-index: 100;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .btn-primary {
            background: white;
            color: black;
            font-weight: bold;
            border-radius: 9999px;
        }

        #joystick-zone {
            position: absolute;
            bottom: 40px;
            left: 40px;
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 40;
            touch-action: none;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        #joystick-knob {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
            position: absolute;
            pointer-events: none;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(0.8);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(0.8);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .drop-btn-pulse {
            animation: pulse-ring 2s infinite;
        }

        canvas {
            touch-action: none;
        }
    </style>
</head>

<body>
    <div id="toast" class="toast"></div>

    <!-- HUD Header -->
    <div class="fixed top-6 left-6 z-40 bg-black/40 backdrop-blur-md border border-white/10 rounded-2xl p-2 pr-4 inline-flex items-center shadow-lg hover:bg-black/60 transition cursor-pointer"
        onclick="window.location.href='app.html'">
        <div class="flex items-center gap-2 text-white">
            <span class="material-icons-round text-xl">arrow_back</span>
            <span class="text-sm font-bold tracking-wider uppercase">HUB</span>
        </div>
    </div>

    <!-- HUD Status -->
    <div
        class="fixed top-6 right-6 z-40 bg-black/40 backdrop-blur-md border border-white/10 rounded-2xl p-4 shadow-lg text-right min-w-[150px] pointer-events-none">
        <div class="text-[10px] font-black tracking-[0.2em] text-gray-500 uppercase mb-3">Universe Status</div>
        <div class="flex flex-col gap-2 relative">
            <div class="flex justify-between items-center text-xs font-bold text-pink-500"><span>NEON</span> <span
                    id="space-point-neon">0</span></div>
            <div class="flex justify-between items-center text-xs font-bold text-blue-500"><span>CYBER</span> <span
                    id="space-point-cyber">0</span></div>
            <div class="flex justify-between items-center text-xs font-bold text-gray-300"><span>VOID</span> <span
                    id="space-point-void">0</span></div>
        </div>
        <div class="w-full h-[1px] bg-white/10 my-3"></div>
        <div class="flex justify-between items-center">
            <span class="text-[10px] text-gray-500 font-bold uppercase" id="my-faction-label">FACTION</span>
            <span class="text-xs font-bold text-white" id="my-space-status">Connecting...</span>
        </div>
    </div>

    <!-- Canvas Engine -->
    <div class="w-screen h-screen relative overflow-hidden bg-[#020205]">
        <canvas id="space-canvas" class="w-full h-full cursor-crosshair"></canvas>

        <div class="absolute bottom-10 right-10 flex flex-col items-center gap-3 z-40">
            <button onclick="dropLog()"
                class="w-16 h-16 bg-emerald-500/20 text-emerald-400 border border-emerald-500/50 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(16,185,129,0.2)] drop-btn-pulse active:scale-95 transition">
                <span class="material-icons-round text-3xl">place</span>
            </button>
            <div class="text-[10px] font-black tracking-widest text-emerald-400/80 uppercase text-center">Drop
                Log<br><span class="opacity-70">(10 XP)</span></div>
        </div>

        <!-- Virtual Joystick for Mobile -->
        <div id="joystick-zone" class="md:hidden">
            <div id="joystick-knob"></div>
        </div>

        <div
            class="absolute bottom-10 left-10 hidden md:flex items-center gap-4 text-xs font-bold text-white/30 tracking-[0.2em] uppercase pointer-events-none bg-black/30 px-4 py-2 rounded-xl backdrop-blur-sm border border-white/5">
            <div class="flex flex-col items-center"><span class="material-icons-round text-lg">keyboard</span> WASD to
                Move</div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center p-4">
        <div
            class="bg-[var(--card)] p-8 rounded-3xl w-full max-w-sm shadow-[0_0_50px_rgba(0,0,0,0.5)] border border-[var(--border)] text-center relative text-[var(--text)]">
            <button onclick="window.location.href='index.html'"
                class="absolute top-4 right-4 text-[var(--subtext)] hover:text-white transition"><span
                    class="material-icons-round">close</span></button>
            <div
                class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-white/5 border border-white/10 text-white mb-4 shadow-lg">
                <span class="material-icons-round text-3xl">public</span>
            </div>
            <h1 class="text-3xl font-black tracking-tighter mb-2">LoG Space</h1>
            <p class="text-[var(--subtext)] text-sm mb-8 leading-relaxed">メタバースへアクセスするには<br>認証が必要です。</p>

            <div class="space-y-4">
                <button id="google-login-btn"
                    class="w-full border border-[var(--border)] bg-white/5 py-3.5 rounded-full font-bold flex justify-center items-center gap-3 hover:bg-white/10 transition shadow-inner">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5">
                    Googleで続行
                </button>
                <div class="flex items-center gap-4 py-1">
                    <div class="h-[1px] flex-1 bg-[var(--border)]"></div>
                    <span class="text-xs text-[var(--subtext)] font-bold">OR</span>
                    <div class="h-[1px] flex-1 bg-[var(--border)]"></div>
                </div>
                <div class="space-y-3">
                    <input id="auth-email" type="email" placeholder="Email"
                        class="w-full bg-[var(--border)]/30 border border-[var(--border)] rounded-xl p-3.5 outline-none focus:border-white/50 transition text-white">
                    <input id="auth-password" type="password" placeholder="Password"
                        class="w-full bg-[var(--border)]/30 border border-[var(--border)] rounded-xl p-3.5 outline-none focus:border-white/50 transition text-white">
                    <button onclick="window.emailAuth('login')"
                        class="w-full btn-primary text-black py-3.5 shadow-[0_0_20px_rgba(255,255,255,0.2)] hover:scale-[1.02] transition">ログイン</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, increment, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs", authDomain: "lo-g-8a620.firebaseapp.com", projectId: "lo-g-8a620", storageBucket: "lo-g-8a620.firebasestorage.app", messagingSenderId: "780857099698", appId: "1:780857099698:web:b6cb359114da98ab3e50ab" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null, myProfile = null;
        let players = {}, spaceLogs = {};
        let mySpacePos = { x: 0, y: 0 };
        const spaceCanvas = document.getElementById('space-canvas');
        const ctx = spaceCanvas.getContext('2d');
        const toast = document.getElementById('toast');

        const showToast = (m) => { toast.innerText = m; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 3000); };

        function resizeCanvas() { spaceCanvas.width = window.innerWidth; spaceCanvas.height = window.innerHeight; }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // 恒星の生成 (Starfield)
        const stars = [];
        for (let i = 0; i < 200; i++) {
            stars.push({
                x: Math.random() * 2000 - 1000,
                y: Math.random() * 2000 - 1000,
                size: Math.random() * 1.5 + 0.5,
                opacity: Math.random()
            });
        }

        // Auth
        document.getElementById('google-login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e => showToast(e.message));
        window.emailAuth = (t) => {
            const e = document.getElementById('auth-email').value, p = document.getElementById('auth-password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => showToast(err.message));
        };

        let moveLoopStarted = false;

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                currentUser = u;
                document.getElementById('auth-modal').classList.add('hidden');
                const d = await getDoc(doc(db, "users", u.uid));
                if (d.exists()) {
                    myProfile = d.data();
                    if (!myProfile.faction) {
                        alert("陣営が未設定です。SNSアプリ（HUB）で陣営を選択してください。");
                        window.location.href = 'app.html';
                        return;
                    }

                    document.getElementById('my-space-status').innerText = `${myProfile.name}`;
                    document.getElementById('my-faction-label').innerText = myProfile.faction;

                    let fColor = 'text-white';
                    if (myProfile.faction === 'neon') fColor = 'text-pink-500';
                    else if (myProfile.faction === 'cyber') fColor = 'text-blue-500';
                    else if (myProfile.faction === 'void') fColor = 'text-gray-300';
                    document.getElementById('my-faction-label').className = `text-[10px] font-bold uppercase ${fColor}`;

                    initSpaceSync();
                    requestAnimationFrame(drawSpace);
                    if (!moveLoopStarted) {
                        moveLoopStarted = true;
                        updateSpaceMovement();
                    }
                } else {
                    alert("プロフィールが未設定です。SNSアプリ（HUB）で先にアカウント設定を完了してください。");
                    window.location.href = 'app.html';
                }
            } else {
                document.getElementById('auth-modal').classList.remove('hidden');
                document.getElementById('my-space-status').innerText = "Not logged in";
            }
        });

        const getColor = (faction) => {
            if (faction === 'neon') return '#ec4899';
            if (faction === 'cyber') return '#3b82f6';
            if (faction === 'void') return '#d1d5db';
            return '#ffffff';
        };

        // Space Engine Core
        function drawSpace() {
            ctx.clearRect(0, 0, spaceCanvas.width, spaceCanvas.height);
            const cx = spaceCanvas.width / 2; const cy = spaceCanvas.height / 2;

            // 背景の星
            stars.forEach(s => {
                let sx = cx + ((s.x - mySpacePos.x) * (0.1 / s.size));
                let sy = cy + ((s.y - mySpacePos.y) * (0.1 / s.size));

                // Wrap around
                while (sx < 0) sx += spaceCanvas.width;
                while (sx > spaceCanvas.width) sx -= spaceCanvas.width;
                while (sy < 0) sy += spaceCanvas.height;
                while (sy > spaceCanvas.height) sy -= spaceCanvas.height;

                ctx.fillStyle = `rgba(255, 255, 255, ${s.opacity})`;
                ctx.beginPath();
                ctx.arc(sx, sy, s.size, 0, Math.PI * 2);
                ctx.fill();
            });

            // グリッド
            ctx.strokeStyle = "rgba(255, 255, 255, 0.05)"; ctx.lineWidth = 1;
            const gridSize = 100; const offsetX = mySpacePos.x % gridSize; const offsetY = mySpacePos.y % gridSize;
            ctx.beginPath();
            for (let x = -offsetX; x < spaceCanvas.width; x += gridSize) { ctx.moveTo(x, 0); ctx.lineTo(x, spaceCanvas.height); }
            for (let y = -offsetY; y < spaceCanvas.height; y += gridSize) { ctx.moveTo(0, y); ctx.lineTo(spaceCanvas.width, y); }
            ctx.stroke();

            // 他プレイヤー
            for (let pid in players) {
                if (pid === currentUser?.uid) continue;
                const p = players[pid];
                const screenX = cx + (p.x - mySpacePos.x); const screenY = cy + (p.y - mySpacePos.y);
                if (screenX < -50 || screenX > spaceCanvas.width + 50 || screenY < -50 || screenY > spaceCanvas.height + 50) continue;

                const tColor = getColor(p.faction);

                ctx.shadowBlur = 10; ctx.shadowColor = tColor;
                ctx.beginPath(); ctx.arc(screenX, screenY, 12, 0, Math.PI * 2); ctx.fillStyle = tColor; ctx.fill();
                ctx.shadowBlur = 0;
                ctx.fillStyle = "rgba(255, 255, 255, 0.9)"; ctx.font = "bold 10px sans-serif"; ctx.textAlign = "center";
                ctx.fillText(p.name || "User", screenX, screenY + 24);
            }

            // ログ（看板）
            for (let lid in spaceLogs) {
                const log = spaceLogs[lid];
                const screenX = cx + (log.x - mySpacePos.x); const screenY = cy + (log.y - mySpacePos.y);
                if (screenX < -150 || screenX > spaceCanvas.width + 150 || screenY < -150 || screenY > spaceCanvas.height + 150) continue;

                const lColor = getColor(log.faction);

                // 柱
                ctx.strokeStyle = "rgba(255,255,255,0.2)"; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(screenX, screenY); ctx.lineTo(screenX, screenY + 20); ctx.stroke();

                // 光るコア
                ctx.fillStyle = lColor; ctx.globalAlpha = 0.3; ctx.beginPath(); ctx.arc(screenX, screenY, 15, 0, Math.PI * 2); ctx.fill(); ctx.globalAlpha = 1.0;
                ctx.shadowBlur = 15; ctx.shadowColor = lColor; ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(screenX, screenY, 4, 0, Math.PI * 2); ctx.fill(); ctx.shadowBlur = 0;

                // テキストと作者
                ctx.fillStyle = '#fff'; ctx.font = "bold 13px sans-serif"; ctx.textAlign = "center";
                ctx.fillText(log.text, screenX, screenY - 15);
                ctx.fillStyle = 'rgba(255,255,255,0.5)'; ctx.font = "9px sans-serif";
                ctx.fillText(`- ${log.author}`, screenX, screenY - 4);
            }

            // 自分
            if (currentUser && myProfile) {
                const myColor = getColor(myProfile.faction);
                ctx.shadowBlur = 15; ctx.shadowColor = myColor; ctx.beginPath(); ctx.arc(cx, cy, 14, 0, Math.PI * 2); ctx.fillStyle = myColor; ctx.fill();
                ctx.shadowBlur = 0; ctx.fillStyle = "white"; ctx.font = "bold 11px sans-serif"; ctx.textAlign = "center"; ctx.fillText("You", cx, cy + 26);
            }

            requestAnimationFrame(drawSpace);
        }

        // 入力処理周辺
        let keys = {};
        window.addEventListener('keydown', e => keys[e.key] = true);
        window.addEventListener('keyup', e => keys[e.key] = false);

        // バーチャルジョイスティック (Touch)
        const joystickZone = document.getElementById('joystick-zone');
        const joystickKnob = document.getElementById('joystick-knob');
        let joyActive = false;
        let joyPos = { x: 0, y: 0 };
        const maxDist = 35; // px

        joystickZone.addEventListener('touchstart', handleJoyStart, { passive: false });
        joystickZone.addEventListener('touchmove', handleJoyMove, { passive: false });
        joystickZone.addEventListener('touchend', handleJoyEnd);
        joystickZone.addEventListener('touchcancel', handleJoyEnd);

        function handleJoyStart(e) { e.preventDefault(); joyActive = true; handleJoyMove(e); }
        function handleJoyMove(e) {
            if (!joyActive) return;
            e.preventDefault();
            const rect = joystickZone.getBoundingClientRect();
            const touch = e.targetTouches[0];
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            let dx = touch.clientX - centerX;
            let dy = touch.clientY - centerY;
            const dist = Math.min(Math.sqrt(dx * dx + dy * dy), maxDist);
            const angle = Math.atan2(dy, dx);

            joyPos.x = Math.cos(angle) * dist;
            joyPos.y = Math.sin(angle) * dist;
            joystickKnob.style.transform = `translate(${joyPos.x}px, ${joyPos.y}px)`;
        }
        function handleJoyEnd() {
            joyActive = false;
            joyPos = { x: 0, y: 0 };
            joystickKnob.style.transform = `translate(0px, 0px)`;
        }

        // 移動と同期のループ
        let lastSyncTime = 0;
        let lastSyncedPos = { x: 0, y: 0 };
        const SYNC_INTERVAL = 1500; // msに1回同期（負荷低減）

        function updateSpaceMovement() {
            if (!currentUser) return;
            let dx = 0; let dy = 0; const speed = 4;

            if (keys['w'] || keys['ArrowUp']) dy -= speed;
            if (keys['s'] || keys['ArrowDown']) dy += speed;
            if (keys['a'] || keys['ArrowLeft']) dx -= speed;
            if (keys['d'] || keys['ArrowRight']) dx += speed;

            if (joyActive) {
                dx = (joyPos.x / maxDist) * speed;
                dy = (joyPos.y / maxDist) * speed;
            }

            if (dx !== 0 || dy !== 0) {
                mySpacePos.x += dx; mySpacePos.y += dy;

                // Firestoreスロットリング
                const now = Date.now();
                const distMoved = Math.sqrt(Math.pow(mySpacePos.x - lastSyncedPos.x, 2) + Math.pow(mySpacePos.y - lastSyncedPos.y, 2));

                if (now - lastSyncTime > SYNC_INTERVAL || distMoved > 100) {
                    setDoc(doc(db, "universe_space", currentUser.uid), {
                        x: mySpacePos.x, y: mySpacePos.y,
                        name: myProfile.name,
                        faction: myProfile.faction,
                        lastActive: serverTimestamp()
                    }, { merge: true });
                    lastSyncTime = now;
                    lastSyncedPos = { x: mySpacePos.x, y: mySpacePos.y };
                }
            }
            setTimeout(updateSpaceMovement, 1000 / 60);
        }

        function initSpaceSync() {
            const lastHour = new Date(Date.now() - 60 * 60 * 1000);
            onSnapshot(query(collection(db, "universe_space"), where("lastActive", ">", lastHour)), (s) => {
                players = {};
                s.forEach(doc => { players[doc.id] = doc.data(); });
            });
            onSnapshot(query(collection(db, "universe_logs"), orderBy("createdAt", "desc"), limit(100)), (s) => {
                spaceLogs = {};
                s.forEach(doc => {
                    let d = doc.data();
                    if (d.expireAt && d.expireAt.toDate() > new Date()) spaceLogs[doc.id] = d;
                });
            });
        }

        onSnapshot(doc(db, "universe", "factions"), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('space-point-neon').innerText = data.neon || 0;
                document.getElementById('space-point-cyber').innerText = data.cyber || 0;
                document.getElementById('space-point-void').innerText = data.void || 0;
            }
        });

        window.dropLog = async () => {
            if (!currentUser) return;
            if ((myProfile.xp || 0) < 10) return showToast("XP不足。 HUBでアクションしてXPを獲得してください。");
            const msg = prompt("この場所にログを刻みます（メッセージを入力）:");
            if (!msg) return;

            await updateDoc(doc(db, "users", currentUser.uid), { xp: increment(-10) });
            myProfile.xp -= 10;

            await addDoc(collection(db, "universe_logs"), {
                x: mySpacePos.x, y: mySpacePos.y,
                text: msg, author: myProfile.name,
                faction: myProfile.faction,
                createdAt: serverTimestamp(),
                expireAt: new Date(Date.now() + 90 * 24 * 60 * 60 * 1000)
            });
            showToast("宇宙にログを刻みました");
        };
    </script>
</body>

</html>