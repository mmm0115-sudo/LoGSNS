<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Courier New', monospace; }
        .hidden { display: none; }
        .btn-primary { background-color: #fff; color: #000; font-weight: bold; border-radius: 4px; padding: 8px 16px; transition: 0.2s; }
        .btn-primary:hover { background-color: #ccc; }
        .btn-outline { border: 1px solid #666; color: #ccc; border-radius: 4px; padding: 6px 12px; font-size: 0.9em; }
        .btn-outline:hover { border-color: #fff; color: #fff; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; display: flex; align-items: center; justify-content: center; }
        /* è¦ç´„ç”¨ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¨ãƒªã‚¢ */
        .terms-scroll { max-height: 300px; overflow-y: auto; background: #111; padding: 10px; border: 1px solid #333; font-size: 0.8em; line-height: 1.6; }
    </style>
</head>
<body>

    <div id="login-screen" class="h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-6xl font-bold mb-4 tracking-tighter">LoG</h1>
        <p class="mb-8 text-gray-400">text-based communication protocol</p>
        
        <button id="login-btn" class="border border-white px-6 py-3 rounded hover:bg-white hover:text-black transition flex items-center gap-2 mb-4">
            <span class="material-icons">login</span> Start Session
        </button>

        <p class="text-xs text-gray-500">
            é–‹å§‹ã™ã‚‹ã“ã¨ã§ <span class="underline cursor-pointer hover:text-white" onclick="openTerms()">åˆ©ç”¨è¦ç´„</span> ã«åŒæ„ã—ãŸã‚‚ã®ã¨ã¿ãªã—ã¾ã™ã€‚
        </p>
    </div>

    <div id="app-screen" class="hidden max-w-xl mx-auto min-h-screen border-x border-gray-800 relative pb-20">
        <header class="sticky top-0 bg-black/90 backdrop-blur z-10 border-b border-gray-800 p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tighter cursor-pointer" onclick="switchTab('home')">LoG</h1>
            <div class="flex items-center gap-3">
                <img id="header-icon" src="" class="w-8 h-8 rounded bg-gray-700 cursor-pointer" onclick="switchTab('profile')">
            </div>
        </header>

        <div id="tab-home">
            <div class="p-4 border-b border-gray-800 flex gap-3">
                <img id="input-icon" src="" class="w-10 h-10 rounded bg-gray-700">
                <div class="flex-1">
                    <textarea id="post-text" rows="3" placeholder="Write to log..." class="w-full bg-transparent text-lg outline-none resize-none mb-2 text-white"></textarea>
                    <div class="flex justify-end">
                        <button id="post-btn" class="btn-primary">COMMIT</button>
                    </div>
                </div>
            </div>
            <div id="timeline" class="divide-y divide-gray-800"></div>
        </div>

        <div id="tab-profile" class="hidden">
            <div class="p-6 border-b border-gray-800">
                <div class="flex justify-between items-start">
                    <img id="profile-big-icon" src="" class="w-20 h-20 rounded bg-gray-700 mb-4">
                    <button onclick="openProfileEditor()" class="btn-outline">Edit Profile</button>
                </div>
                <h2 id="profile-name" class="text-2xl font-bold"></h2>
                <p id="profile-uid" class="text-gray-500 text-xs font-mono mt-1"></p>
                <div class="mt-6 border-b border-gray-800 pb-2 mb-2 font-bold text-gray-400">YOUR LOGS</div>
            </div>
            <div id="my-timeline" class="divide-y divide-gray-800"></div>
            
            <div class="p-6 text-center">
                <span class="text-xs text-gray-600 underline cursor-pointer hover:text-gray-400" onclick="openTerms()">åˆ©ç”¨è¦ç´„ã‚’ç¢ºèª</span>
            </div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-xl bg-black border-t border-gray-800 flex justify-around p-3 text-gray-400">
            <button onclick="switchTab('home')" class="hover:text-white"><span class="material-icons">home</span></button>
            <button onclick="switchTab('profile')" class="hover:text-white"><span class="material-icons">person</span></button>
        </nav>
    </div>

    <div id="profile-modal" class="modal-overlay hidden">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-lg w-80 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Setup Profile</h2>
            <div class="flex flex-col items-center mb-4">
                <img id="edit-preview-icon" src="" class="w-20 h-20 rounded bg-gray-800 mb-2">
                <button id="random-icon-btn" class="text-xs border border-gray-600 px-2 py-1 rounded hover:bg-gray-700">ğŸ² Random Icon</button>
                <input type="hidden" id="edit-icon-url">
            </div>
            <div class="mb-6">
                <label class="block text-gray-500 text-sm mb-1">Display Name</label>
                <input id="edit-name-input" type="text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white outline-none focus:border-white" placeholder="Enter name">
            </div>
            <button id="save-profile-btn" class="w-full btn-primary">SAVE</button>
        </div>
    </div>

    <div id="terms-modal" class="modal-overlay hidden">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-lg w-full max-w-md shadow-2xl m-4">
            <h2 class="text-xl font-bold mb-4">åˆ©ç”¨è¦ç´„ (Terms)</h2>
            <div class="terms-scroll mb-4 text-gray-300">
                <p class="font-bold mb-1">ç¬¬1æ¡ï¼ˆã¯ã˜ã‚ã«ï¼‰</p>
                <p class="mb-2">æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã€ŒLoGã€ï¼ˆä»¥ä¸‹ã€Œæœ¬ã‚µãƒ¼ãƒ“ã‚¹ã€ï¼‰ã¯ã€é–‹ç™ºè€…ãŒå€‹äººçš„ã«é‹å–¶ã™ã‚‹è©¦é¨“çš„ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚åˆ©ç”¨è€…ã¯ã€æœ¬è¦ç´„ã«åŒæ„ã—ãŸä¸Šã§åˆ©ç”¨ã™ã‚‹ã‚‚ã®ã¨ã—ã¾ã™ã€‚</p>
                
                <p class="font-bold mb-1">ç¬¬2æ¡ï¼ˆå…è²¬äº‹é …ï¼šé‡è¦ï¼‰</p>
                <p class="mb-2">1. é‹å–¶è€…ã¯ã€æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã®åˆ©ç”¨ã«ã‚ˆã‚Šåˆ©ç”¨è€…ã«ç”Ÿã˜ãŸæå®³ï¼ˆãƒ‡ãƒ¼ã‚¿ã®æ¶ˆå¤±ã€ç¬¬ä¸‰è€…ã¨ã®ãƒˆãƒ©ãƒ–ãƒ«ç­‰ï¼‰ã«ã¤ã„ã¦ã€ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚<br>
                2. æœ¬ã‚µãƒ¼ãƒ“ã‚¹ã¯äºˆå‘Šãªãå†…å®¹ã®å¤‰æ›´ã€åœæ­¢ã€ã¾ãŸã¯çµ‚äº†ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>

                <p class="font-bold mb-1">ç¬¬3æ¡ï¼ˆç¦æ­¢äº‹é …ï¼‰</p>
                <p class="mb-2">ä»¥ä¸‹ã®è¡Œç‚ºã‚’ç¦æ­¢ã—ã¾ã™ã€‚<br>
                ãƒ»æ³•ä»¤ã«é•åã™ã‚‹è¡Œç‚º<br>
                ãƒ»ä»–è€…ã‚’èª¹è¬—ä¸­å‚·ã™ã‚‹è¡Œç‚º<br>
                ãƒ»éåº¦ã«æš´åŠ›çš„ã€æ€§çš„ãªæŠ•ç¨¿<br>
                ãƒ»ã‚µãƒ¼ãƒãƒ¼ã«éåº¦ãªè² è·ã‚’ã‹ã‘ã‚‹è¡Œç‚º</p>

                <p class="font-bold mb-1">ç¬¬4æ¡ï¼ˆåˆ©ç”¨åœæ­¢ï¼‰</p>
                <p class="mb-0">é‹å–¶è€…ã¯ã€æœ¬è¦ç´„ã«é•åã—ãŸåˆ©ç”¨è€…ã«å¯¾ã—ã€äº‹å‰ã®é€šçŸ¥ãªãæŠ•ç¨¿ã®å‰Šé™¤ã‚„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®åœæ­¢ã‚’è¡Œã†æ¨©åˆ©ã‚’æœ‰ã—ã¾ã™ã€‚</p>
            </div>
            <button onclick="document.getElementById('terms-modal').classList.add('hidden')" class="w-full border border-white text-white py-2 rounded font-bold hover:bg-white hover:text-black">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // â˜…è¨­å®šã‚­ãƒ¼ï¼ˆã“ã“ã«æ­£ã—ã„ã‚­ãƒ¼ãŒå…¥ã£ã¦ã„ã¾ã™ï¼‰
        const firebaseConfig = {
            apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs",
            authDomain: "lo-g-8a620.firebaseapp.com",
            projectId: "lo-g-8a620",
            storageBucket: "lo-g-8a620.firebasestorage.app",
            messagingSenderId: "780857099698",
            appId: "1:780857099698:web:b6cb359114da98ab3e50ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let myProfile = null;

        // ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³å‡¦ç†
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(alert);
        });

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ç›£è¦–
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                try {
                    const userDoc = await getDoc(doc(db, "users", user.uid));
                    if (userDoc.exists()) {
                        myProfile = userDoc.data();
                        initApp(); 
                    } else {
                        document.getElementById('login-screen').classList.add('hidden');
                        openProfileEditor(true); 
                    }
                } catch(e) { console.error(e); }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            updateHeaderUI();
            loadTimeline();
        }

        function updateHeaderUI() {
            if(!myProfile) return;
            document.getElementById('header-icon').src = myProfile.icon;
            document.getElementById('input-icon').src = myProfile.icon;
            document.getElementById('profile-big-icon').src = myProfile.icon;
            document.getElementById('profile-name').innerText = myProfile.name;
            document.getElementById('profile-uid').innerText = "ID: " + currentUser.uid.slice(0, 8);
        }

     // æŠ•ç¨¿ãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆã“ã“ã‚’æ›¸ãæ›ãˆã‚‹ï¼‰
        document.getElementById('post-btn').addEventListener('click', async () => {
            const text = document.getElementById('post-text').value;
            if (!text.trim() || !myProfile) return;

            // â˜…å‰Šé™¤äºˆå®šæ—¥ã‚’è¨ˆç®—ï¼ˆä»Šã¯ã€Œ90æ—¥å¾Œã€ã«è¨­å®šã—ã¦ã„ã¾ã™ï¼‰
            const expireDate = new Date();
            expireDate.setDate(expireDate.getDate() + 90); 

            try {
                await addDoc(collection(db, "logs"), {
                    text: text,
                    uid: currentUser.uid,
                    authorName: myProfile.name,
                    authorIcon: myProfile.icon,
                    createdAt: serverTimestamp(),
                    expireAt: expireDate // â˜…ã“ã‚Œã«è¿½åŠ ï¼ã€Œã“ã®æ—¥ã«æ¶ˆã—ã¦ã­ã€ã¨ã„ã†äºˆç´„
                });
                document.getElementById('post-text').value = "";
                switchTab('home');
            } catch (e) { alert("Error: " + e.message); }
        });

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³
        function loadTimeline() {
            const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('timeline');
                container.innerHTML = "";
                snapshot.forEach(doc => container.appendChild(createPostEl(doc.data())));
            });
            const myQ = query(collection(db, "logs"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(myQ, (snapshot) => {
                const container = document.getElementById('my-timeline');
                container.innerHTML = "";
                snapshot.forEach(doc => container.appendChild(createPostEl(doc.data())));
            });
        }

        function createPostEl(data) {
            const div = document.createElement('div');
            div.className = "p-4 hover:bg-gray-900 transition flex gap-3";
            div.innerHTML = `
                <img src="${data.authorIcon}" class="w-10 h-10 rounded bg-gray-800">
                <div class="overflow-hidden">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-sm text-white">${data.authorName}</span>
                        <span class="text-gray-500 text-xs">${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString() : '...'}</span>
                    </div>
                    <p class="mt-1 text-gray-300 break-words whitespace-pre-wrap">${data.text}</p>
                </div>`;
            return div;
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†
        window.openProfileEditor = () => {
            document.getElementById('profile-modal').classList.remove('hidden');
            if (myProfile) {
                document.getElementById('edit-name-input').value = myProfile.name;
                document.getElementById('edit-icon-url').value = myProfile.icon;
                document.getElementById('edit-preview-icon').src = myProfile.icon;
            } else generateRandomIcon();
        };

        function generateRandomIcon() {
            const seed = Math.random().toString(36).substring(7);
            const url = `https://api.dicebear.com/7.x/identicon/svg?seed=${seed}&backgroundColor=c0aede,b6e3f4,c1f4c6`;
            document.getElementById('edit-icon-url').value = url;
            document.getElementById('edit-preview-icon').src = url;
        }
        document.getElementById('random-icon-btn').addEventListener('click', generateRandomIcon);

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const name = document.getElementById('edit-name-input').value;
            const icon = document.getElementById('edit-icon-url').value;
            if(!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            try {
                await setDoc(doc(db, "users", currentUser.uid), { name, icon, updatedAt: serverTimestamp() }, { merge: true });
                myProfile = { name, icon };
                initApp();
            } catch(e) { alert("ä¿å­˜å¤±æ•—: " + e.message); }
        });

        window.switchTab = (tabName) => {
            ['home', 'profile'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        };

        // è¦ç´„ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‹é–‰
        window.openTerms = () => {
            document.getElementById('terms-modal').classList.remove('hidden');
        };
    </script>
</body>
</html>
