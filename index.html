<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { background-color: #000; color: #fff; font-family: 'Courier New', monospace; }
        .hidden { display: none; }
        .btn-primary { background-color: #fff; color: #000; font-weight: bold; border-radius: 4px; padding: 8px 16px; transition: 0.2s; }
        .btn-primary:hover { background-color: #ccc; }
        .btn-outline { border: 1px solid #666; color: #ccc; border-radius: 4px; padding: 6px 12px; font-size: 0.9em; }
        .btn-outline:hover { border-color: #fff; color: #fff; }
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div id="login-screen" class="h-screen flex flex-col items-center justify-center">
        <h1 class="text-6xl font-bold mb-4 tracking-tighter">LoG</h1>
        <p class="mb-8 text-gray-400">text-based communication protocol</p>
        <button id="login-btn" class="border border-white px-6 py-3 rounded hover:bg-white hover:text-black transition flex items-center gap-2">
            <span class="material-icons">login</span> Start Session
        </button>
    </div>

    <div id="app-screen" class="hidden max-w-xl mx-auto min-h-screen border-x border-gray-800 relative pb-20">
        <header class="sticky top-0 bg-black/90 backdrop-blur z-10 border-b border-gray-800 p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold tracking-tighter cursor-pointer" onclick="switchTab('home')">LoG</h1>
            <div class="flex items-center gap-3">
                <img id="header-icon" src="" class="w-8 h-8 rounded bg-gray-700 cursor-pointer" onclick="switchTab('profile')">
            </div>
        </header>

        <div id="tab-home">
            <div class="p-4 border-b border-gray-800 flex gap-3">
                <img id="input-icon" src="" class="w-10 h-10 rounded bg-gray-700">
                <div class="flex-1">
                    <textarea id="post-text" rows="3" placeholder="Write to log..." class="w-full bg-transparent text-lg outline-none resize-none mb-2 text-white"></textarea>
                    <div class="flex justify-end">
                        <button id="post-btn" class="btn-primary">COMMIT</button>
                    </div>
                </div>
            </div>
            <div id="timeline" class="divide-y divide-gray-800"></div>
        </div>

        <div id="tab-profile" class="hidden">
            <div class="p-6 border-b border-gray-800">
                <div class="flex justify-between items-start">
                    <img id="profile-big-icon" src="" class="w-20 h-20 rounded bg-gray-700 mb-4">
                    <button onclick="openProfileEditor()" class="btn-outline">Edit Profile</button>
                </div>
                <h2 id="profile-name" class="text-2xl font-bold"></h2>
                <p id="profile-uid" class="text-gray-500 text-xs font-mono mt-1"></p>
                
                <div class="mt-6 border-b border-gray-800 pb-2 mb-2 font-bold text-gray-400">YOUR LOGS</div>
            </div>
            <div id="my-timeline" class="divide-y divide-gray-800"></div>
        </div>

        <nav class="fixed bottom-0 w-full max-w-xl bg-black border-t border-gray-800 flex justify-around p-3 text-gray-400">
            <button onclick="switchTab('home')" class="hover:text-white"><span class="material-icons">home</span></button>
            <button onclick="switchTab('profile')" class="hover:text-white"><span class="material-icons">person</span></button>
        </nav>
    </div>

    <div id="profile-modal" class="modal-overlay hidden">
        <div class="bg-gray-900 border border-gray-700 p-6 rounded-lg w-80 shadow-2xl">
            <h2 class="text-xl font-bold mb-4">Setup Profile</h2>
            
            <div class="flex flex-col items-center mb-4">
                <img id="edit-preview-icon" src="" class="w-20 h-20 rounded bg-gray-800 mb-2">
                <button id="random-icon-btn" class="text-xs border border-gray-600 px-2 py-1 rounded hover:bg-gray-700">ðŸŽ² Random Icon</button>
                <input type="hidden" id="edit-icon-url">
            </div>

            <div class="mb-6">
                <label class="block text-gray-500 text-sm mb-1">Display Name</label>
                <input id="edit-name-input" type="text" class="w-full bg-gray-800 border border-gray-600 rounded p-2 text-white outline-none focus:border-white" placeholder="Enter name">
            </div>

            <button id="save-profile-btn" class="w-full btn-primary">SAVE</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // â˜…â˜…â˜… ã“ã“ã«APIã‚­ãƒ¼ã‚’è²¼ã‚‹ â˜…â˜…â˜…
        const firebaseConfig = {
            apiKey: "AIzaSy...",
            authDomain: "logsns.netlify.app", // è‡ªåˆ†ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ãªã©
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let myProfile = null; // LoGå°‚ç”¨ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿

        // --- èªè¨¼ ---
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch(alert);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                // LoGã®usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’å–å¾—
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒã‚ã‚Œã°ãƒ­ãƒ¼ãƒ‰
                    myProfile = userDoc.data();
                    initApp();
                } else {
                    // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã‘ã‚Œã°ä½œæˆç”»é¢ã¸
                    document.getElementById('login-screen').classList.add('hidden');
                    openProfileEditor(true); // åˆå›žãƒ¢ãƒ¼ãƒ‰
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // --- ã‚¢ãƒ—ãƒªåˆæœŸåŒ– ---
        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            
            updateHeaderUI();
            loadTimeline();
        }

        function updateHeaderUI() {
            if(!myProfile) return;
            // ç”»é¢ã®ã‚¢ã‚¤ã‚³ãƒ³ãªã©ã‚’æ›´æ–°
            document.getElementById('header-icon').src = myProfile.icon;
            document.getElementById('input-icon').src = myProfile.icon;
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ–ã®ä¸­èº«
            document.getElementById('profile-big-icon').src = myProfile.icon;
            document.getElementById('profile-name').innerText = myProfile.name;
            document.getElementById('profile-uid').innerText = "ID: " + currentUser.uid.slice(0, 8);
        }

        // --- æŠ•ç¨¿æ©Ÿèƒ½ ---
        document.getElementById('post-btn').addEventListener('click', async () => {
            const text = document.getElementById('post-text').value;
            if (!text.trim()) return;
            if (!myProfile) return alert("ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");

            try {
                await addDoc(collection(db, "logs"), {
                    text: text,
                    uid: currentUser.uid,
                    authorName: myProfile.name, // â˜…Googleåã§ã¯ãªãLoGã®åå‰ã‚’ä½¿ã†
                    authorIcon: myProfile.icon, // â˜…LoGã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã†
                    createdAt: serverTimestamp()
                });
                document.getElementById('post-text').value = "";
                switchTab('home');
            } catch (e) {
                console.error(e);
                alert("æŠ•ç¨¿ã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        });

        // --- ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ ---
        function loadTimeline() {
            // å…¨ä½“
            const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('timeline');
                container.innerHTML = "";
                snapshot.forEach(doc => container.appendChild(createPostEl(doc.data())));
            });

            // è‡ªåˆ†ã®ã¿ï¼ˆãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¿ãƒ–ç”¨ï¼‰
            const myQ = query(collection(db, "logs"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(myQ, (snapshot) => {
                const container = document.getElementById('my-timeline');
                container.innerHTML = "";
                snapshot.forEach(doc => container.appendChild(createPostEl(doc.data())));
            });
        }

        function createPostEl(data) {
            const div = document.createElement('div');
            div.className = "p-4 hover:bg-gray-900 transition flex gap-3";
            div.innerHTML = `
                <img src="${data.authorIcon}" class="w-10 h-10 rounded bg-gray-800">
                <div class="overflow-hidden">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-sm text-white">${data.authorName}</span>
                        <span class="text-gray-500 text-xs">${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString() : '...'}</span>
                    </div>
                    <p class="mt-1 text-gray-300 break-words whitespace-pre-wrap">${data.text}</p>
                </div>
            `;
            return div;
        }

        // --- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç·¨é›†ã¾ã‚ã‚Š ---
        window.openProfileEditor = (isFirstTime = false) => {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('hidden');
            
            if (myProfile) {
                document.getElementById('edit-name-input').value = myProfile.name;
                document.getElementById('edit-icon-url').value = myProfile.icon;
                document.getElementById('edit-preview-icon').src = myProfile.icon;
            } else {
                // åˆå›žã¯ãƒ©ãƒ³ãƒ€ãƒ ç”Ÿæˆ
                generateRandomIcon();
            }
        };

        // ãƒ©ãƒ³ãƒ€ãƒ ã‚¢ã‚¤ã‚³ãƒ³ç”Ÿæˆ (DiceBear API)
        function generateRandomIcon() {
            const seed = Math.random().toString(36).substring(7);
            // å¹¾ä½•å­¦æ¨¡æ§˜(identicon)ã‚’ä½¿ç”¨ã€‚ãƒ­ãƒœãƒƒãƒˆãŒå¥½ããªã‚‰ "bottts" ã«å¤‰ãˆã¦ã‚‚OK
            const url = `https://api.dicebear.com/7.x/identicon/svg?seed=${seed}&backgroundColor=c0aede,b6e3f4,c1f4c6`;
            document.getElementById('edit-icon-url').value = url;
            document.getElementById('edit-preview-icon').src = url;
        }
        document.getElementById('random-icon-btn').addEventListener('click', generateRandomIcon);

        // ä¿å­˜ãƒœã‚¿ãƒ³
        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const name = document.getElementById('edit-name-input').value;
            const icon = document.getElementById('edit-icon-url').value;
            if(!name) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

            try {
                // usersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
                await setDoc(doc(db, "users", currentUser.uid), {
                    name: name,
                    icon: icon,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                // ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã‚‚æ›´æ–°
                myProfile = { name, icon };
                initApp();
            } catch(e) {
                console.error(e);
                alert("ä¿å­˜å¤±æ•—: " + e.message);
            }
        });

        // --- ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ---
        window.switchTab = (tabName) => {
            document.getElementById('tab-home').classList.add('hidden');
            document.getElementById('tab-profile').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        };

    </script>
</body>
</html>
