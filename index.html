<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, getDoc, setDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ★★★ ここをいただいた正しい情報に書き換えました ★★★
        const firebaseConfig = {
            apiKey: "AIzaSyCA4NQzxcz2gh8uaw3LKrKl_NEnE_fMybs",
            authDomain: "lo-g-8a620.firebaseapp.com",
            projectId: "lo-g-8a620",
            storageBucket: "lo-g-8a620.firebasestorage.app",
            messagingSenderId: "780857099698",
            appId: "1:780857099698:web:b6cb359114da98ab3e50ab"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let currentUser = null;
        let myProfile = null;

        // --- 認証 ---
        document.getElementById('login-btn').addEventListener('click', () => {
            signInWithPopup(auth, new GoogleAuthProvider()).catch((error) => {
                console.error("Login Failed:", error);
                alert("ログインエラー: " + error.message);
            });
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const userDocRef = doc(db, "users", user.uid);
                
                try {
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        myProfile = userDoc.data();
                        initApp();
                    } else {
                        document.getElementById('login-screen').classList.add('hidden');
                        openProfileEditor(true); 
                    }
                } catch (e) {
                    console.error("Profile Load Error:", e);
                }
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
            }
        });

        // --- アプリ初期化 ---
        function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');
            document.getElementById('profile-modal').classList.add('hidden');
            
            updateHeaderUI();
            loadTimeline();
        }

        function updateHeaderUI() {
            if(!myProfile) return;
            document.getElementById('header-icon').src = myProfile.icon;
            document.getElementById('input-icon').src = myProfile.icon;
            document.getElementById('profile-big-icon').src = myProfile.icon;
            document.getElementById('profile-name').innerText = myProfile.name;
            document.getElementById('profile-uid').innerText = "ID: " + currentUser.uid.slice(0, 8);
        }

        // --- 投稿機能 ---
        document.getElementById('post-btn').addEventListener('click', async () => {
            const text = document.getElementById('post-text').value;
            if (!text.trim()) return;
            if (!myProfile) return alert("プロフィールが設定されていません");

            try {
                await addDoc(collection(db, "logs"), {
                    text: text,
                    uid: currentUser.uid,
                    authorName: myProfile.name,
                    authorIcon: myProfile.icon,
                    createdAt: serverTimestamp()
                });
                document.getElementById('post-text').value = "";
                switchTab('home');
            } catch (e) {
                console.error(e);
                alert("投稿エラー: " + e.message);
            }
        });

        // --- タイムライン ---
        function loadTimeline() {
            const q = query(collection(db, "logs"), orderBy("createdAt", "desc"), limit(50));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('timeline');
                container.innerHTML = "";
                snapshot.forEach(doc => container.appendChild(createPostEl(doc.data())));
            });

            const myQ = query(collection(db, "logs"), where("uid", "==", currentUser.uid), orderBy("createdAt", "desc"), limit(20));
            onSnapshot(myQ, (snapshot) => {
                const container = document.getElementById('my-timeline');
                container.innerHTML = "";
                snapshot.forEach(doc => container.appendChild(createPostEl(doc.data())));
            });
        }

        function createPostEl(data) {
            const div = document.createElement('div');
            div.className = "p-4 hover:bg-gray-900 transition flex gap-3";
            div.innerHTML = `
                <img src="${data.authorIcon}" class="w-10 h-10 rounded bg-gray-800">
                <div class="overflow-hidden">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-sm text-white">${data.authorName}</span>
                        <span class="text-gray-500 text-xs">${data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString() : '...'}</span>
                    </div>
                    <p class="mt-1 text-gray-300 break-words whitespace-pre-wrap">${data.text}</p>
                </div>
            `;
            return div;
        }

        // --- プロフィール編集 ---
        window.openProfileEditor = (isFirstTime = false) => {
            const modal = document.getElementById('profile-modal');
            modal.classList.remove('hidden');
            
            if (myProfile) {
                document.getElementById('edit-name-input').value = myProfile.name;
                document.getElementById('edit-icon-url').value = myProfile.icon;
                document.getElementById('edit-preview-icon').src = myProfile.icon;
            } else {
                generateRandomIcon();
            }
        };

        function generateRandomIcon() {
            const seed = Math.random().toString(36).substring(7);
            const url = `https://api.dicebear.com/7.x/identicon/svg?seed=${seed}&backgroundColor=c0aede,b6e3f4,c1f4c6`;
            document.getElementById('edit-icon-url').value = url;
            document.getElementById('edit-preview-icon').src = url;
        }
        document.getElementById('random-icon-btn').addEventListener('click', generateRandomIcon);

        document.getElementById('save-profile-btn').addEventListener('click', async () => {
            const name = document.getElementById('edit-name-input').value;
            const icon = document.getElementById('edit-icon-url').value;
            if(!name) return alert("名前を入力してください");

            try {
                await setDoc(doc(db, "users", currentUser.uid), {
                    name: name,
                    icon: icon,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                myProfile = { name, icon };
                initApp();
            } catch(e) {
                console.error(e);
                alert("保存失敗: " + e.message);
            }
        });

        window.switchTab = (tabName) => {
            document.getElementById('tab-home').classList.add('hidden');
            document.getElementById('tab-profile').classList.add('hidden');
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
        };
    </script>
